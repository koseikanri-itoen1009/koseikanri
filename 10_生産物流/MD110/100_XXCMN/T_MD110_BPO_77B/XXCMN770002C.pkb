CREATE OR REPLACE PACKAGE BODY xxcmn770002c
AS
/*****************************************************************************************
 * Copyright(c)Oracle Corporation Japan, 2008. All rights reserved.
 *
 * Package Name     : xxcmn770002c(body)
 * Description      : 受払残高表（Ⅰ）製品
 * MD.050/070       : 月次〆切処理帳票Issue1.0 (T_MD050_BPO_770)
 *                    月次〆切処理帳票Issue1.0 (T_MD070_BPO_77B)
 * Version          : 1.36
 *
 * Program List
 * -------------------------- ----------------------------------------------------------
 *  Name                       Description
 * -------------------------- ----------------------------------------------------------
 *  fnc_conv_xml                FUNCTION  : ＸＭＬタグに変換する。
 *  prc_initialize              PROCEDURE : 前処理
 *  prc_get_report_data         PROCEDURE : 明細データ取得(B-1)
 *  prc_create_xml_data         PROCEDURE : ＸＭＬデータ作成
 *  submain                     PROCEDURE : メイン処理プロシージャ
 *  main                        PROCEDURE : コンカレント実行ファイル登録プロシージャ
 *
 * Change Record
 * ------------- ----- ---------------- -------------------------------------------------
 *  Date          Ver.  Editor           Description
 * ------------- ----- ---------------- -------------------------------------------------
 *  2008/04/08    1.0   T.Hokama         新規作成
 *  2008/05/15    1.1   T.Endou          不具合ID11,13対応
 *                                       11 入力パラ、処理日yyyym対応
 *                                       13 ヘッダー部分の最大文字数制限の変更
 *  2008/05/30    1.2   R.Tomoyose       実際原価を抽出する時、原価管理区分が実際原価の場合、
 *                                       ロット管理の対象の場合はロット別原価テーブル
 *                                       ロット管理の対象外の場合は標準原価マスタテーブルより取得
 *  2008/06/12    1.3   Y.Ishikawa       生産原料詳細(アドオン)の結合が不要の為削除。
 *                                       取引区分名 = 仕入先返品は払出だが出力位置は受入の部分に
 *                                       出力する。
 *  2008/06/24    1.4   T.Endou          数量・金額項目がNULLでも0出力する。
 *                                       数量・金額の間を詰める。
 *  2008/06/25    1.5   T.Ikehara        特定文字列を出力しようとすると、エラーとなり帳票が出力
 *                                       されない現象への対応
 *  2008/08/05    1.6   R.Tomoyose       参照ビューの変更「xxcmn_rcv_pay_mst_porc_rma_v」→
 *                                                       「xxcmn_rcv_pay_mst_porc_rma02_v」
 *  2008/08/20    1.7   A.Shiina         T_TE080_BPO_770 指摘9対応
 *  2008/08/22    1.8   A.Shiina         T_TE080_BPO_770 指摘14対応
 *  2008/08/27    1.9   A.Shiina         T_TE080_BPO_770 指摘20対応
 *  2008/08/28    1.10  A.Shiina         取引数量は取得時に受払区分を掛ける。
 *  2008/08/28    1.11  A.Shiina         振替項目の+-表示修正。
 *  2008/10/08    1.12  N.Yoshida        T_S_492、T_S_524対応(PT対応)
 *  2008/10/24    1.13  H.Itou           T_S_492、T_S_524対応(PT対応)
 *  2008/10/31    1.14  Y.Suzuki         Tune(prc_get_report_data cursor8 , prc_create_xml_data fnc_get_item_unit_price,prc_get_inv_qty_amt)
 *  2008/11/04    1.15  N.Yoshida        移行リハ暫定対応
 *  2008/11/12    1.15  N.Fukuda         統合指摘#634対応(移行データ検証不具合対応)
 *  2008/11/17    1.16  A.Shiina         積送データの修正
 *  2008/11/19    1.17  N.Yoshida        I_S_684対応、移行データ検証不具合対応
 *  2008/11/25    1.18  A.Shiina         本番指摘52対応
 *  2008/12/03    1.19  A.Shiina         本番指摘361対応
 *  2008/12/05    1.20  H.Maru           本番障害492対応
 *  2008/12/07    1.21  N.Yoshida        本番障害数値あわせ対応(受注ヘッダの最新フラグを追加)
 *  2008/12/08    1.22  A.Shiina         本番障害565対応
 *  2008/12/09    1.23  H.Marushita      本番障害565対応
 *  2008/12/10    1.24  A.Shiina         本番障害617,636対応
 *  2008/12/11    1.25  N.Yoshida        本番障害580対応
 *  2008/12/12    1.26  N.Yoshida        本番障害669対応
 *  2008/12/12    1.27  A.Shiina         本番障害685対応
 *  2008/12/15    1.28  N.Yoshida        本番障害725対応
 *  2008/12/17    1.29  A.Shiina         本番障害774対応
 *  2008/12/18    1.30  N.Yoshida        本番障害773対応
 *  2008/12/19    1.31  A.Shiina         本番障害799対応
 *  2008/12/25    1.32  A.Shiina         本番障害674対応
 *  2009/03/05    1.33  Y.Yamamoto       本番障害1274対応
 *  2009/04/08    1.34  A.Shiina         本番障害1387対応
 *  2009/05/29    1.35  Marushita        本番障害1511対応
 *  2014/10/16    1.36  H.Itou           E_本稼動_12321対応
 *****************************************************************************************/
--
--#######################  固定グローバル定数宣言部 START   #######################
--
  gv_status_normal CONSTANT VARCHAR2(1) := '0' ;
  gv_status_warn   CONSTANT VARCHAR2(1) := '1' ;
  gv_status_error  CONSTANT VARCHAR2(1) := '2' ;
  gv_msg_part      CONSTANT VARCHAR2(3) := ' : ' ;
  gv_msg_cont      CONSTANT VARCHAR2(3) := '.';
--
--################################  固定部 END   ###############################
--
--#######################  固定グローバル変数宣言部 START   #######################
--
--################################  固定部 END   ###############################
--
  -- ======================================================
  -- ユーザー宣言部
  -- ======================================================
  -- ===============================
  -- ユーザー定義グローバル定数
  -- ===============================
  gv_pkg_name               CONSTANT VARCHAR2(20) := 'xxcmn770002c' ;           -- パッケージ名
  gv_print_name             CONSTANT VARCHAR2(20) := '受払残高表（Ⅰ）製品' ;   -- 帳票名
--
  ------------------------------
  -- クイックコード関連
  ------------------------------
  gc_language_code           CONSTANT VARCHAR2(2)  := 'JA' ;
  gc_enable_flag             CONSTANT VARCHAR2(2)  := 'Y' ;
  gc_lookup_type_print_class CONSTANT VARCHAR2(50) := 'XXCMN_MONTH_TRANS_OUTPUT_TYPE' ; -- 帳票種別
  gc_lookup_type_print_flg   CONSTANT VARCHAR2(50) := 'XXCMN_MONTH_TRANS_OUTPUT_FLAG';  -- 印刷可否
  gc_lookup_type_crowd_kind  CONSTANT VARCHAR2(50) := 'XXCMN_MC_OUPUT_DIV' ;            -- 群種別
  gc_lookup_type_dealing_div CONSTANT VARCHAR2(50) := 'XXCMN_DEALINGS_DIV' ;            -- 取引区分
--
  ------------------------------
  -- 品目カテゴリ関連
  ------------------------------
  gc_cat_set_goods_class        CONSTANT VARCHAR2(100) := '商品区分' ;
  gc_cat_set_item_class         CONSTANT VARCHAR2(100) := '品目区分' ;
--
  ------------------------------
  -- 帳票種別
  ------------------------------
  gc_print_kind_locat     CONSTANT VARCHAR2(1) := '1';    --倉庫別・品目別
  gc_print_kind_item      CONSTANT VARCHAR2(1) := '2';    --品目別
--
   ------------------------------
  -- 群種別
  ------------------------------
  gc_crowd_kind           CONSTANT VARCHAR2(1) := '3';    --群別
  gc_crowd_acct_kind      CONSTANT VARCHAR2(1) := '4';    --経理群別
--
  ------------------------------
  -- 原価管理区分
  ------------------------------
  gc_cost_ac              CONSTANT VARCHAR2(1) := '0' ;   --実際原価
  gc_cost_st              CONSTANT VARCHAR2(1) := '1' ;   --標準原価
  ------------------------------
  -- ロット管理
  ------------------------------
  gn_lot_ctl_n            CONSTANT NUMBER := 0;  --対象外
  gn_lot_ctl_y            CONSTANT NUMBER := 1;  --対象
--
  ------------------------------
  -- 受払区分
  ------------------------------
  gc_rcv_pay_div_in       CONSTANT VARCHAR2(1) := '1' ;   --受入
  gc_rcv_pay_div_out      CONSTANT VARCHAR2(2) := '-1' ;  --払出
      -- 2008/11/4 modify yoshida 暫定ロジック start
  gc_rcv_pay_div_adj         CONSTANT VARCHAR2(2) := '-1' ;  --調整
      -- 2008/11/4 modify yoshida 暫定ロジック end
--
--
  ------------------------------
  -- エラーメッセージ関連
  ------------------------------
  gc_application          CONSTANT VARCHAR2(5)  := 'XXCMN' ;          -- アプリケーション
--
  ------------------------------
  -- 日付項目編集関連
  ------------------------------
  gc_char_format          CONSTANT VARCHAR2(30) := 'YYYYMMDD' ;
  gc_char_m_format        CONSTANT VARCHAR2(30) := 'YYYYMM' ;
  gc_char_t_format        CONSTANT VARCHAR2(30) := 'YYYYMMDD HH24MISS' ;
  gc_char_d_format        CONSTANT VARCHAR2(30) := 'YYYY/MM/DD' ;
  gc_char_dt_format       CONSTANT VARCHAR2(30) := 'YYYY/MM/DD HH24:MI:SS' ;
--
  ------------------------------
  -- 項目編集関連
  ------------------------------
  gc_d                   CONSTANT VARCHAR2(1) := 'D';
  gc_n                   CONSTANT VARCHAR2(1) := 'N';
  gc_t                   CONSTANT VARCHAR2(1) := 'T';
  gc_z                   CONSTANT VARCHAR2(1) := 'Z';
--
  gn_one                 CONSTANT NUMBER      := 1   ;
  gn_two                 CONSTANT NUMBER      := 2   ;
--
  ------------------------------
  -- 項目位置判断
  ------------------------------
  -- 項目判定用
  gc_break_col             VARCHAR2(100) DEFAULT '-' ;     -- 項目判定切り替え
  -- 受入
  gc_col_no_po             CONSTANT VARCHAR2(2) := '1';    -- 仕入
  gc_col_no_wrap           CONSTANT VARCHAR2(2) := '2';    -- 包装
  gc_col_no_set            CONSTANT VARCHAR2(2) := '3';    -- セット
  gc_col_no_oki            CONSTANT VARCHAR2(2) := '4';    -- 沖縄
  gc_col_no_trnsfr         CONSTANT VARCHAR2(2) := '5';    -- 振替入庫
  gc_col_no_acct_1         CONSTANT VARCHAR2(2) := '6';    -- 緑営１
  gc_col_no_acct_2         CONSTANT VARCHAR2(2) := '7';    -- 緑営２
  gc_col_no_guift          CONSTANT VARCHAR2(2) := '8';    -- ドリンクギフト
  gc_col_no_locat_chg      CONSTANT VARCHAR2(2) := '9';    -- 倉替
  gc_col_no_ret_goods      CONSTANT VARCHAR2(2) := '10';   -- 返品
  gc_col_no_other          CONSTANT VARCHAR2(2) := '11';   -- その他
  -- 払出
  gc_col_no_out_set        CONSTANT VARCHAR2(2) := '12';   -- セット
  gc_col_no_out_mtrl       CONSTANT VARCHAR2(2) := '13';   -- 返品原料へ
  gc_col_no_out_dismnt     CONSTANT VARCHAR2(2) := '14';   -- 解体半製品へ
  gc_col_no_out_pay        CONSTANT VARCHAR2(2) := '15';   -- 有償
  gc_col_no_out_trnsfr     CONSTANT VARCHAR2(2) := '16';   -- 振替有償
  gc_col_no_out_point      CONSTANT VARCHAR2(2) := '17';   -- 拠点
  gc_col_no_out_guift      CONSTANT VARCHAR2(2) := '18';   -- ドリンクギフト
  gc_col_no_out_other      CONSTANT VARCHAR2(2) := '19';   -- その他
--
  ------------------------------
  -- 数値・金額小数点位置
  ------------------------------
  gn_quantity_decml        NUMBER  := 3;
  gn_amount_decml          NUMBER  := 0;
--
  ------------------------------
  -- 文書タイプ
  ------------------------------
  gv_doc_type_xfer           CONSTANT VARCHAR2(5)     := 'XFER';  --
  gv_doc_type_trni           CONSTANT VARCHAR2(5)     := 'TRNI';  --
  gv_doc_type_adji           CONSTANT VARCHAR2(5)     := 'ADJI';  --
  gv_doc_type_prod           CONSTANT VARCHAR2(5)     := 'PROD';  --
  gv_doc_type_porc           CONSTANT VARCHAR2(5)     := 'PORC';  --
  gv_doc_type_omso           CONSTANT VARCHAR2(5)     := 'OMSO';  --
--
  ------------------------------
  -- 事由コード
  ------------------------------
  gv_reason_code_xfer        CONSTANT VARCHAR2(5)   := 'X122';--
  gv_reason_code_trni        CONSTANT VARCHAR2(5)   := 'X122';--
  gv_reason_code_adji_po     CONSTANT VARCHAR2(5)   := 'X201';--仕入
  gv_reason_code_adji_hama   CONSTANT VARCHAR2(5)   := 'X988';--浜岡
  gv_reason_code_adji_move   CONSTANT VARCHAR2(5)   := 'X123';--移動
  gv_reason_code_adji_othr   CONSTANT VARCHAR2(5)   := 'X977';--相手先（出力対象外）
  gv_reason_code_adji_itm    CONSTANT VARCHAR2(5)   := 'X942';-- 黙視品目払出
  gv_reason_code_adji_snt    CONSTANT VARCHAR2(5)   := 'X951';-- その他払出
-- 2008/10/08 v1.12 ADD START
  gv_reason_code_adji_itm_u  CONSTANT VARCHAR2(5)   := 'X943';-- 黙視品目受入
  gv_reason_code_adji_snt_u  CONSTANT VARCHAR2(5)   := 'X950';-- その他受入
-- 2008/10/08 v1.12 ADD START
--
  ------------------------------
  -- 取引区分
  ------------------------------
  gv_dealings_div_prod1      CONSTANT VARCHAR2(10)  := '品種振替';
  gv_dealings_div_prod2      CONSTANT VARCHAR2(10)  := '品目振替';
  gv_dealings_name_po        CONSTANT xxcmn_lookup_values_v.meaning%TYPE := '仕入';
      -- 2008/11/4 modify yoshida 暫定ロジック start
  gv_d_name_trn_rcv          CONSTANT xxcmn_lookup_values_v.meaning%TYPE := '振替有償_受入';
  gv_d_name_item_trn_rcv     CONSTANT xxcmn_lookup_values_v.meaning%TYPE := '商品振替有償_受入';
  gv_d_name_trn_ship_rcv_gen CONSTANT xxcmn_lookup_values_v.meaning%TYPE := '振替出荷_受入_原';
  gv_d_name_trn_ship_rcv_han CONSTANT xxcmn_lookup_values_v.meaning%TYPE := '振替出荷_受入_半';
      -- 2008/11/4 modify yoshida 暫定ロジック end
--
  -- ===============================
  -- ユーザー定義グローバル型
  -- ===============================
  -- 入力パラメータ格納用レコード変数
  TYPE rec_param_data  IS RECORD(
      exec_year_month     VARCHAR2(6)                          -- 処理年月
     ,goods_class         mtl_categories_b.segment1%TYPE       -- 商品区分
     ,item_class          mtl_categories_b.segment1%TYPE       -- 品目区分
     ,print_kind          VARCHAR2(1)                          -- 帳票種別
     ,locat_code          ic_tran_pnd.location%TYPE            -- 倉庫コード
     ,crowd_kind          fnd_lookup_values.meaning%TYPE       -- 群種別
     ,crowd_code          mtl_categories_b.segment1%TYPE       -- 群コード
     ,acct_crowd_code     mtl_categories_b.segment1%TYPE       -- 経理群コード
    ) ;
--
  -- 受払残高表データ格納用レコード変数
  TYPE rec_data_type_dtl IS RECORD(
      locat_code            ic_whse_mst.whse_code%TYPE              -- 倉庫コード
     ,locat_name            ic_whse_mst.whse_name%TYPE              -- 倉庫名
     ,item_id               xxcmn_item_mst2_v.item_id%TYPE          -- 品目ID
     ,lot_id                ic_tran_pnd.lot_id%TYPE                 -- ロットID
     ,trans_qty             ic_tran_pnd.trans_qty%TYPE              -- 取引数量
     ,cost_kbn              ic_item_mst_b.attribute15%TYPE          -- 原価管理区分
     ,lot_ctl               xxcmn_lot_each_item_v.lot_ctl%TYPE      -- ロット管理
     ,actual_unit_price     xxcmn_lot_cost.unit_ploce%TYPE          -- 実際原価
     ,column_no             fnd_lookup_values.attribute2%TYPE       -- 項目位置
     ,rcv_pay_div           xxcmn_rcv_pay_mst.rcv_pay_div%TYPE      -- 受払区分
     ,trans_date            DATE                                    -- 取引日
     ,crowd_code            mtl_categories_b.segment1%TYPE          -- 群コード
     ,crowd_low             mtl_categories_b.segment1%TYPE          -- 群コード（小）
     ,crowd_mid             mtl_categories_b.segment1%TYPE          -- 群コード（中）
     ,crowd_high            mtl_categories_b.segment1%TYPE          -- 群コード（大）
     ,item_code             xxcmn_item_mst2_v.item_no%TYPE          -- 品目コード
     ,item_name             xxcmn_item_mst2_v.item_name%TYPE        -- 品目名称
    ) ;
  TYPE tab_data_type_dtl IS TABLE OF rec_data_type_dtl INDEX BY BINARY_INTEGER ;
--
  -- ===============================
  -- ユーザー定義グローバル変数
  -- ===============================
  gn_user_id                fnd_user.user_id%TYPE DEFAULT FND_GLOBAL.USER_ID; -- ユーザーＩＤ
--
  ------------------------------
  -- ヘッダ情報取得用
  ------------------------------
  gv_user_dept              xxcmn_locations_all.location_short_name%TYPE;     -- 担当部署
  gv_user_name              per_all_people_f.per_information18%TYPE;          -- 担当者
  gv_print_class_name       fnd_lookup_values.meaning%TYPE;                   -- 帳票種別名
  gv_goods_class_name       mtl_categories_tl.description%TYPE;               -- 商品区分名
  gv_item_class_name        mtl_categories_tl.description%TYPE;               -- 品目区分名
  gv_crowd_kind_name        mtl_categories_tl.description%TYPE;               -- 群種別名
--
  ------------------------------
  -- 条件取得用
  ------------------------------
  gv_exec_year_month_bef    VARCHAR2(6);      -- 処理年月の前月
  gd_exec_start             DATE;             -- 処理年月の開始日
  gd_exec_end               DATE;             -- 処理年月の終了日
  gv_exec_start             VARCHAR2(20);     -- 処理年月の開始日
  gv_exec_end               VARCHAR2(20);     -- 処理年月の終了日
  gv_exec_start_bef         VARCHAR2(20);     -- 処理年月の前月開始日
  gv_exec_end_bef           VARCHAR2(20);     -- 処理年月の前月終了日
  gv_exec_start_aft         VARCHAR2(20);     -- 処理年月の翌月開始日
  gv_exec_end_aft           VARCHAR2(20);     -- 処理年月の翌月終了日
--
  ------------------------------
  -- ＸＭＬ用
  ------------------------------
  gv_report_id              VARCHAR2(12) ;    -- 帳票ID
  gd_exec_date              DATE         ;    -- 実施日
--
  gt_main_data              tab_data_type_dtl ;       -- 取得レコード表
  gt_xml_data_table         XML_DATA ;                -- ＸＭＬデータタグ表
  gl_xml_idx                NUMBER DEFAULT 0 ;        -- ＸＭＬデータタグ表のインデックス
--
  ------------------------------
  --  標準原価評価日付
  ------------------------------
  gd_st_unit_date         DATE; -- 2009/05/29 ADD
--
--#####################  固定共通例外宣言部 START   ####################
--
  --*** 処理部共通例外 ***
  global_process_expt       EXCEPTION ;
  --*** 共通関数例外 ***
  global_api_expt           EXCEPTION ;
  --*** 共通関数OTHERS例外 ***
  global_api_others_expt    EXCEPTION ;
--
  PRAGMA EXCEPTION_INIT(global_api_others_expt,-20000) ;
--
--###########################  固定部 END   ############################
--
  /**********************************************************************************
   * Function Name    : fnc_conv_xml
   * Description      : ＸＭＬタグに変換する。
   ***********************************************************************************/
  FUNCTION fnc_conv_xml(
      iv_name              IN        VARCHAR2   --   タグネーム
     ,iv_value             IN        VARCHAR2   --   タグデータ
     ,ic_type              IN        CHAR       --   タグタイプ
    ) RETURN VARCHAR2
  IS
    -- =====================================================
    -- 固定ローカル定数
    -- =====================================================
    cv_prg_name    CONSTANT VARCHAR2(100) := 'fnc_conv_xml' ;   -- プログラム名
--
    -- =====================================================
    -- ユーザー宣言部
    -- =====================================================
    -- *** ローカル変数 ***
    lv_convert_data         VARCHAR2(2000) ;
--
  BEGIN
--
    --データの場合
    IF (ic_type = 'D') THEN
      lv_convert_data := '<'||iv_name||'><![CDATA['||iv_value||']]></'||iv_name||'>' ;
    ELSE
      lv_convert_data := '<'||iv_name||'>' ;
    END IF ;
--
    RETURN(lv_convert_data) ;
--
  END fnc_conv_xml ;
--
  /**********************************************************************************
   * Procedure Name   : prc_initialize
   * Description      : 前処理
   ***********************************************************************************/
  PROCEDURE prc_initialize(
      ir_param      IN     rec_param_data   -- 01.入力パラメータ群
     ,ov_errbuf     OUT    VARCHAR2         --    エラー・メッセージ           --# 固定 #
     ,ov_retcode    OUT    VARCHAR2         --    リターン・コード             --# 固定 #
     ,ov_errmsg     OUT    VARCHAR2         --    ユーザー・エラー・メッセージ --# 固定 #
    )
  IS
    -- ===============================
    -- 固定ローカル定数
    -- ===============================
    cv_prg_name   CONSTANT VARCHAR2(100) := 'prc_initialize' ; -- プログラム名
--
--#####################  固定ローカル変数宣言部 START   ########################
--
    lv_errbuf  VARCHAR2(5000);  -- エラー・メッセージ
    lv_retcode VARCHAR2(1);     -- リターン・コード
    lv_errmsg  VARCHAR2(5000);  -- ユーザー・エラー・メッセージ
--
--###########################  固定部 END   ####################################
--
    -- ===============================
    -- ユーザー宣言部
    -- ===============================
    -- *** ローカル定数 ***
    lc_f_day           CONSTANT VARCHAR2(2)  := '01';
    lc_ym              CONSTANT VARCHAR2(6)  := 'YYYYMM';
    lc_f_time          CONSTANT VARCHAR2(10) := ' 00:00:00';
    lc_e_time          CONSTANT VARCHAR2(10) := ' 23:59:59';
    -- エラーコード
    lc_err_code        CONSTANT VARCHAR2(100) := 'APP-XXCMN-10010';
    -- トークン名
    lc_token_name_01   CONSTANT VARCHAR2(100) := 'PARAMETER';
    lc_token_name_02   CONSTANT VARCHAR2(100) := 'VALUE';
    -- トークン値
    lc_token_value     CONSTANT VARCHAR2(100) := '処理年月';
--
    -- *** ローカル変数 ***
--
    -- *** ローカル・例外処理 ***
    get_value_expt        EXCEPTION ;     -- 値取得エラー
--
  BEGIN
--
--##################  固定ステータス初期化部 START   ###################
--
    ov_retcode := gv_status_normal;
--
--###########################  固定部 END   ############################
--
    -- ====================================================
    -- 担当部署名取得
    -- ====================================================
    gv_user_dept := xxcmn_common_pkg.get_user_dept( gn_user_id );
--
    -- ====================================================
    -- 担当者名取得
    -- ====================================================
    gv_user_name := xxcmn_common_pkg.get_user_name( gn_user_id );
--
    -- ====================================================
    -- 帳票種別取得
    -- ====================================================
    BEGIN
      SELECT flv.meaning
      INTO   gv_print_class_name
      FROM   xxcmn_lookup_values_v flv
      WHERE  flv.lookup_code   = ir_param.print_kind
      AND    flv.lookup_type   = gc_lookup_type_print_class
      ;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        NULL;
    END ;
--
    -- ====================================================
    -- 商品区分取得
    -- ====================================================
    BEGIN
-- 2008/10/08 v1.12 DELETE START
      /*SELECT cat.description
      INTO   gv_goods_class_name
      FROM   xxcmn_categories2_v cat
      WHERE  cat.category_set_name = gc_cat_set_goods_class
      AND    cat.segment1          = ir_param.goods_class
      ;*/
-- 2008/10/08 v1.12 DELETE END
-- 2008/10/08 v1.12 ADD START
      SELECT mct.description
      INTO   gv_goods_class_name
      FROM   mtl_category_sets_b mcsb
            ,mtl_categories_b mcb
            ,mtl_categories_tl mct
      WHERE  mcsb.structure_id    = mcb.structure_id
      AND    mcsb.category_set_id = TO_NUMBER(FND_PROFILE.VALUE('XXCMN_ITEM_CATEGORY_PROD_CLASS'))
      AND    mcb.segment1         = ir_param.goods_class
      AND    mcb.category_id      = mct.category_id
      AND    mct.language         = 'JA'
      ;
-- 2008/10/08 v1.12 ADD END
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        NULL;
    END ;
--
    -- ====================================================
    -- 品目区分取得
    -- ====================================================
    BEGIN
-- 2008/10/08 v1.12 DELETE START
      /*SELECT cat.description
      INTO   gv_item_class_name
      FROM   xxcmn_categories2_v cat
      WHERE  cat.category_set_name = gc_cat_set_item_class
      AND    cat.segment1          = ir_param.item_class
      ;*/
-- 2008/10/08 v1.12 DELETE END
-- 2008/10/08 v1.12 ADD START
      SELECT mct.description
      INTO   gv_item_class_name
      FROM   mtl_category_sets_b mcsb
            ,mtl_categories_b mcb
            ,mtl_categories_tl mct
      WHERE  mcsb.structure_id    = mcb.structure_id
      AND    mcsb.category_set_id = TO_NUMBER(FND_PROFILE.VALUE('XXCMN_ITEM_CATEGORY_ITEM_CLASS'))
      AND    mcb.segment1         = ir_param.item_class
      AND    mcb.category_id      = mct.category_id
      AND    mct.language         = 'JA'
      ;
-- 2008/10/08 v1.12 ADD END
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        NULL;
    END ;
--
    -- ====================================================
    -- 群種別取得
    -- ====================================================
    BEGIN
      SELECT flv.meaning
      INTO   gv_crowd_kind_name
      FROM   xxcmn_lookup_values_v flv
      WHERE  flv.lookup_code   = ir_param.crowd_kind
      AND    flv.lookup_type   = gc_lookup_type_crowd_kind
      ;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        NULL;
    END ;
--
    -- ====================================================
    -- 処理年月
    -- ====================================================
    -- 日付変換チェック
    gd_exec_start := FND_DATE.STRING_TO_DATE( ir_param.exec_year_month, gc_char_m_format ) ;
    IF ( gd_exec_start IS NULL ) THEN
      -- メッセージセット
      lv_retcode := gv_status_error ;
      lv_errbuf  := xxcmn_common_pkg.get_msg( iv_application   => gc_application
                                             ,iv_name          => lc_err_code
                                             ,iv_token_name1   => lc_token_name_01
                                             ,iv_token_name2   => lc_token_name_02
                                             ,iv_token_value1  => lc_token_value
                                             ,iv_token_value2  => ir_param.exec_year_month ) ;
      RAISE get_value_expt ;
    END IF ;
--
    -- ====================================================
    -- 日付情報取得
    -- ====================================================
    -- 処理年月・開始日
    gd_exec_start := FND_DATE.STRING_TO_DATE(ir_param.exec_year_month , gc_char_m_format);
    gv_exec_start := TO_CHAR(gd_exec_start, gc_char_d_format) || lc_f_time;
    -- 処理年月・終了日
    gd_exec_end   := LAST_DAY(gd_exec_start);
    gv_exec_end   := TO_CHAR(gd_exec_end, gc_char_d_format) || lc_e_time;
    -- 前月・年月
    gv_exec_year_month_bef := TO_CHAR(ADD_MONTHS(gd_exec_start , -1), lc_ym);
    -- 処理年月・前月開始日
    gv_exec_start_bef := TO_CHAR(ADD_MONTHS(gd_exec_start , -1), gc_char_dt_format);
    -- 処理年月・前月終了日
    gv_exec_end_bef   := TO_CHAR(gd_exec_start -1, gc_char_d_format) || lc_e_time;
    -- 処理年月・翌月開始日
    gv_exec_start_aft := TO_CHAR(ADD_MONTHS(gd_exec_start , 1), gc_char_dt_format);
    -- 処理年月・翌月終了日
    gv_exec_end_aft  := TO_CHAR(LAST_DAY(ADD_MONTHS(gd_exec_start, 1))
                                ,gc_char_d_format) || lc_e_time;
--
  EXCEPTION
    --*** 値取得エラー例外 ***
    WHEN get_value_expt THEN
--
      ov_errmsg  := lv_errmsg ;
      ov_errbuf  := lv_errbuf ;
      ov_retcode := lv_retcode ;
--
--#################################  固定例外処理部 START   ####################################
--
    -- *** 共通関数例外ハンドラ ***
    WHEN global_api_expt THEN
      ov_errmsg  := lv_errmsg;
      ov_errbuf  := SUBSTRB(gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||lv_errbuf,1,5000);
      ov_retcode := gv_status_error;
    -- *** 共通関数OTHERS例外ハンドラ ***
    WHEN global_api_others_expt THEN
      ov_errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM;
      ov_retcode := gv_status_error;
    -- *** OTHERS例外ハンドラ ***
    WHEN OTHERS THEN
      ov_errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM;
      ov_retcode := gv_status_error;
--
--#####################################  固定部 END   ##########################################
--
  END prc_initialize ;
--
  /**********************************************************************************
   * Procedure Name   : prc_get_report_data
   * Description      : 明細データ取得(B-1)
   ***********************************************************************************/
  PROCEDURE prc_get_report_data(
      ir_param      IN  rec_param_data            -- 01.入力パラメータ群
     ,ot_data_rec   OUT NOCOPY tab_data_type_dtl  -- 02.取得レコード群
     ,ov_errbuf     OUT VARCHAR2                  --    エラー・メッセージ           --# 固定 #
     ,ov_retcode    OUT VARCHAR2                  --    リターン・コード             --# 固定 #
     ,ov_errmsg     OUT VARCHAR2                  --    ユーザー・エラー・メッセージ --# 固定 #
    )
  IS
    -- ===============================
    -- 固定ローカル定数
    -- ===============================
    cv_prg_name   CONSTANT VARCHAR2(100) := 'prc_get_report_data'; -- プログラム名
--
--#####################  固定ローカル変数宣言部 START   ########################
--
    lv_errbuf  VARCHAR2(5000);  -- エラー・メッセージ
    lv_retcode VARCHAR2(1);     -- リターン・コード
    lv_errmsg  VARCHAR2(5000);  -- ユーザー・エラー・メッセージ
--
--###########################  固定部 END   ####################################
--
    -- ===============================
    -- ユーザー宣言部
    -- ===============================
    -- *** ローカル・定数 ***
-- 2008/10/08 v1.12 ADD START
    cn_prod_class_id          CONSTANT NUMBER := TO_NUMBER(FND_PROFILE.VALUE('XXCMN_ITEM_CATEGORY_PROD_CLASS'));
    cn_item_class_id          CONSTANT NUMBER := TO_NUMBER(FND_PROFILE.VALUE('XXCMN_ITEM_CATEGORY_ITEM_CLASS'));
    cn_crowd_code_id          CONSTANT NUMBER := TO_NUMBER(FND_PROFILE.VALUE('XXCMN_ITEM_CATEGORY_CROWD_CODE'));
    cn_acnt_crowd_code_id     CONSTANT NUMBER := TO_NUMBER(FND_PROFILE.VALUE('XXCMN_ITEM_CATEGORY_ACNT_CROWD_CODE'));
-- 2008/10/08 v1.12 ADD END
--
    -- *** ローカル・変数 ***
-- 2008/10/31 v1.14 ADD START
    ln_crowd_code_id NUMBER;
    lt_crowd_code    mtl_categories_b.segment1%TYPE;
-- 2008/10/31 v1.14 ADD END
-- 2008/10/08 v1.12 DELETE START
    /*lv_select1    VARCHAR2(5000) ;
    lv_select2    VARCHAR2(5000) ;
    lv_from       VARCHAR2(5000) ;
    lv_where      VARCHAR2(5000) ;
    lv_order_by   VARCHAR2(5000) ;
    lv_sql        VARCHAR2(32000) ;     -- データ取得用ＳＱＬ
    lv_sql2       VARCHAR2(32000) ;     -- データ取得用ＳＱＬ
--
    lv_sql_xfer      VARCHAR2(5000);
    lv_sql_trni      VARCHAR2(5000);
    lv_sql_adji      VARCHAR2(5000);
    lv_sql_adji_po   VARCHAR2(5000);
    lv_sql_adji_hm   VARCHAR2(5000);
    lv_sql_adji_mv   VARCHAR2(5000);
    lv_sql_adji_snt  VARCHAR2(5000);
    lv_sql_prod      VARCHAR2(5000);
    lv_sql_prod_rv   VARCHAR2(5000);
    lv_sql_porc      VARCHAR2(5000);
    lv_sql_porc_po   VARCHAR2(5000);
    lv_sql_omsso     VARCHAR2(5000);
    --xfer
    lv_from_xfer         VARCHAR2(5000);
    lv_where_xfer        VARCHAR2(5000);
    --trni
    lv_from_trni         VARCHAR2(5000);
    lv_where_trni        VARCHAR2(5000);
    --adji（仕入）
    lv_from_adji_po      VARCHAR2(5000);
    lv_where_adji_po     VARCHAR2(5000);
    --adji（浜岡）
    lv_from_adji_hm      VARCHAR2(5000);
    lv_where_adji_hm     VARCHAR2(5000);
    --adji（移動）
    lv_from_adji_mv      VARCHAR2(5000);
    lv_where_adji_mv     VARCHAR2(5000);
    --adji（その他払出）
    lv_from_adji_snt     VARCHAR2(5000);
    lv_where_adji_snt    VARCHAR2(5000);
    --adji（上記以外）
    lv_from_adji         VARCHAR2(5000);
    lv_where_adji        VARCHAR2(5000);
    --prod（Reverse_idなし）品種・品目振替以外
    lv_from_prod         VARCHAR2(5000);
    lv_where_prod        VARCHAR2(5000);
    --porc
    lv_select_porc       VARCHAR2(5000);
    lv_from_porc         VARCHAR2(5000);
    lv_where_porc        VARCHAR2(5000);
    --porc（仕入）
    lv_from_porc_po      VARCHAR2(5000);
    lv_where_porc_po     VARCHAR2(5000);
    --omsso
    lv_select_omsso      VARCHAR2(5000);
    lv_from_omsso        VARCHAR2(5000);
    lv_where_omsso       VARCHAR2(5000);*/
-- 2008/10/08 v1.12 DELETE END
--
    -- *** ローカル・カーソル ***
    TYPE   ref_cursor IS REF CURSOR ;
    lc_ref ref_cursor ;
--
-- 2008/10/31 v1.14 ADD START
    -- ----------------------------------------------------
    -- 入力パラメータによりカーソルの選択を行う
    -- ----------------------------------------------------
    --===============================================================
    -- 検索条件.帳票種別          ⇒ 倉庫・品目別
    -- 検索条件.群種別            ⇒ 群別/経理群別
    -- 検索条件.倉庫コード        ⇒ 入力なし
    -- 検索条件.群/経理群コード   ⇒ 入力なし
    --===============================================================
    CURSOR get_data_cur01 IS
      -- ----------------------------------------------------
      -- XFER :経理受払区分移動積送あり
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) use_nl (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_xfer_mst                      ixm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_xfer
      AND    itp.reason_code         = gv_reason_code_xfer
      AND    itp.completed_ind       = 1
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.doc_id              = ixm.transfer_id
      AND    ixm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = itp.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itp.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.reason_code        = itp.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- TRNI :経理受払区分移動積送なし
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_trni
      AND    itc.reason_code         = gv_reason_code_trni
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itc.doc_type            = iaj.trans_type
      AND    itc.doc_id              = iaj.doc_id
      AND    itc.doc_line            = iaj.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 ADD START
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itc.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
-- 2008/11/19 v1.17 ADD END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.rcv_pay_div        = itc.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(他)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji    --文書タイプ
      AND    itc.reason_code        IN ('X911'
                                       ,'X912'
                                       ,'X921'
                                       ,'X922'
                                       ,'X931'
                                       ,'X932'
                                       ,'X941'
                                       ,'X952'
                                       ,'X953'
                                       ,'X954'
                                       ,'X955'
                                       ,'X956'
                                       ,'X957'
                                       ,'X958'
                                       ,'X959'
                                       ,'X960'
                                       ,'X961'
                                       ,'X962'
                                       ,'X963'
-- 2008/11/19 v1.17 UPDATE START
--                                       ,'X964')
                                       ,'X964'
                                       ,'X965'
                                       ,'X966')
-- 2008/11/19 v1.17 UPDATE END
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(仕入)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
            ,SUM(itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div))) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
-- v1.36 Add Start
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
-- v1.36 Add End
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_po
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
-- v1.36 Add Start
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
-- v1.36 Add End
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
-- v1.36 Add Start
      GROUP BY
             iwm.whse_code                    -- h_whse_code
            ,iwm.whse_name                    -- h_whse_name
            ,itc.item_id                      -- item_id
            ,itc.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itc.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,ijm.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(浜岡)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_hama
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(移動)
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) use_nl (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- 2008/12/11 v1.25 N.Yoshida mod start
--            ,ABS(itc.trans_qty) * TO_NUMBER(gc_rcv_pay_div_adj) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod start
--            ,NVL(itc.trans_qty,0)             trans_qty
            ,NVL(itc.trans_qty,0) * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod end
-- 2008/12/11 v1.25 N.Yoshida mod end
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmrl
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_move
      AND    xmrih.mov_hdr_id        = xmrl.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmrl.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/12/11 v1.26 N.Yoshida mod start
      AND    xrpm.rcv_pay_div        = CASE
--                                       WHEN itc.trans_qty >= 0 THEN 1
--                                       ELSE -1
                                       WHEN itc.trans_qty >= 0 THEN -1
                                       ELSE 1
                                       END
-- 2008/12/11 v1.26 N.Yoshida mod end
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(その他払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code        IN (gv_reason_code_adji_itm
                                       ,gv_reason_code_adji_itm_u
                                       ,gv_reason_code_adji_snt_u
                                       ,gv_reason_code_adji_snt)
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 DELETE START
      --AND    xrpm.rcv_pay_div        = CASE
      --                                 WHEN itc.trans_qty >= 0 THEN 1
      --                                 ELSE -1
      --                                 END
-- 2008/11/19 v1.17 DELETE END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PROD :経理受払区分生産関連（Reverse_idなし）品種・品目振替なし
      -- ----------------------------------------------------
      SELECT /*+ leading (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) use_nl (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gme_material_details             gmd
            ,gme_batch_header                 gbh
            ,gmd_routings_b                   grb
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_prod
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.reverse_id          IS NULL
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gmd.batch_id            = itp.doc_id
      AND    gmd.line_no             = itp.doc_line
      AND    gmd.line_type           = itp.line_type
      AND    gbh.batch_id            = gmd.batch_id
      AND    grb.routing_id          = gbh.routing_id
      AND    xrpm.routing_class      = grb.routing_class
      AND    xrpm.line_type          = gmd.line_type
      AND    (((gmd.attribute5 IS NULL) AND (xrpm.hit_in_div IS NULL))
             OR (xrpm.hit_in_div = gmd.attribute5))
      AND    itp.doc_type            = xrpm.doc_type
      AND    itp.line_type           = xrpm.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    ((xrpm.routing_class    <> '70')
             OR ((xrpm.routing_class     = '70')
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd2
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd2.batch_id   = gmd.batch_id
                              AND    gmd2.line_no    = gmd.line_no
                              AND    gmd2.line_type  = -1
                              AND    gic.item_id     = gmd2.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_origin))
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd3
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd3.batch_id   = gmd.batch_id
                              AND    gmd3.line_no    = gmd.line_no
                              AND    gmd3.line_type  = 1
                              AND    gic.item_id     = gmd3.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_ahead))
             ))
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC1 :経理受払区分購買関連 (製品出荷,有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xola.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.req_status         IN ('04','08')
      AND    otta.attribute1         IN ('1','2')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC2 :経理受払区分購買関連 (振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC3 :経理受払区分購買関連 (商品振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC4 :経理受払区分購買関連 (商品振替有償、払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xoha.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC5 :経理受払区分購買関連 (振替出荷、出荷)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code <> xola.shipping_item_code
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC6 :経理受払区分購買関連 (振替出荷、受入_原料、受入_半)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC7 :経理受払区分購買関連 (倉替,返品)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC8 :経理受払区分購買関連 (見本,廃却)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- PORC :経理受払区分購買関連（仕入）
    -- ----------------------------------------------------
      SELECT /*+ leading (itp rsl gic2 mcb2 gic1 mcb1) use_nl (itp rsl gic2 mcb2 gic1 mcb1) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,SUM(itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,rcv_shipment_lines               rsl
            ,rcv_transactions                 rt
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.source_document_code = 'PO'
      AND    rt.transaction_id       = itp.line_id
      AND    rt.shipment_line_id     = rsl.shipment_line_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = rsl.source_document_code
      AND    xrpm.transaction_type   = rt.transaction_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
-- v1.36 Add Start
      GROUP BY
             iwm.whse_code                    -- h_whse_code
            ,iwm.whse_name                    -- h_whse_name
            ,itp.item_id                      -- item_id
            ,itp.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itp.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,rsl.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO1 :経理受払区分受注関連 (製品出荷,有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
--            ,oe_order_lines_all               oola
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    otta.attribute1         IN ('1','2')
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.arrival_date      >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date      <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status        IN ('04','08')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO2 :経理受払区分受注関連 (振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO3 :経理受払区分受注関連 (商品振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO4 :経理受払区分受注関連 (商品振替有償、払出)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    mcb4.segment1           = '1'
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    mcb5.segment1           = '5'
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO5 :経理受払区分受注関連 (振替出荷、出荷)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code  <> xola.shipping_item_code
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO6 :経理受払区分受注関連 (振替出荷、受入_原料、受入_半)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           IN ('1','4')
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO7 :経理受払区分受注関連 (倉替,返品)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO8 :経理受払区分受注関連 (見本,廃却)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xoha.header_id          = ooha.header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
    -- ----------------------------------------------------
    -- 当月受払無しデータ
    -- ----------------------------------------------------
      UNION ALL
      SELECT /*+ leading (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) use_nl (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,0                                lot_id
            ,0                                trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,'1'                              column_no
            ,'1'                              rcv_pay_div
            ,TO_DATE(gv_exec_start_bef, gc_char_dt_format) trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   xxinv_stc_inventory_month_stck   xsims
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_whse_mst                      iwm
      WHERE  xsims.item_id           = iimb.item_id
      AND    ximb.item_id            = iimb.item_id
      AND    ilm.item_id             = xsims.item_id
      AND    ilm.lot_id              = xsims.lot_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.start_date_active <= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    ximb.end_date_active   >= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    gic1.item_id            = xsims.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = xsims.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = xsims.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    iwm.whse_code           = xsims.whse_code
      AND    xsims.invent_ym         = gv_exec_year_month_bef
-- 2008/12/10 v1.24 UPDATE START
--      AND    xsims.monthly_stock    <> 0
      AND    (
               (xsims.monthly_stock <> 0)
               OR
               (xsims.cargo_stock   <> 0)
             )
      AND    iwm.attribute1          = '0'
-- 2008/12/10 v1.24 UPDATE END
      ORDER BY h_whse_code      -- 倉庫コード
              ,crowd_code       -- 群コード
              ,item_code        -- 品目コード
              ,column_no        -- 項目位置
              ,rcv_pay_div      -- 受払区分
      ;
--
    --===============================================================
    -- 検索条件.帳票種別          ⇒ 倉庫・品目別
    -- 検索条件.群種別            ⇒ 群別/経理群別
    -- 検索条件.倉庫コード        ⇒ 入力あり
    -- 検索条件.群/経理群コード   ⇒ 入力なし
    --===============================================================
    CURSOR get_data_cur02 IS
      -- ----------------------------------------------------
      -- XFER :経理受払区分移動積送あり
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) use_nl (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_xfer_mst                      ixm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_xfer
      AND    itp.reason_code         = gv_reason_code_xfer
      AND    itp.completed_ind       = 1
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.doc_id              = ixm.transfer_id
      AND    ixm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = itp.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itp.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.reason_code        = itp.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- TRNI :経理受払区分移動積送なし
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_trni
      AND    itc.reason_code         = gv_reason_code_trni
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itc.doc_type            = iaj.trans_type
      AND    itc.doc_id              = iaj.doc_id
      AND    itc.doc_line            = iaj.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 ADD START
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itc.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
-- 2008/11/19 v1.17 ADD END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.rcv_pay_div        = itc.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(他)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji    --文書タイプ
      AND    itc.reason_code        IN ('X911'
                                       ,'X912'
                                       ,'X921'
                                       ,'X922'
                                       ,'X931'
                                       ,'X932'
                                       ,'X941'
                                       ,'X952'
                                       ,'X953'
                                       ,'X954'
                                       ,'X955'
                                       ,'X956'
                                       ,'X957'
                                       ,'X958'
                                       ,'X959'
                                       ,'X960'
                                       ,'X961'
                                       ,'X962'
                                       ,'X963'
-- 2008/11/19 v1.17 UPDATE START
--                                       ,'X964')
                                       ,'X964'
                                       ,'X965'
                                       ,'X966')
-- 2008/11/19 v1.17 UPDATE END
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(仕入)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
            ,SUM(itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div))) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
-- v1.36 Add Start
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
-- v1.36 Add End
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_po
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
-- v1.36 Add Start
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
-- v1.36 Add End
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
-- v1.36 Add Start
      GROUP BY
             iwm.whse_code                    -- h_whse_code
            ,iwm.whse_name                    -- h_whse_name
            ,itc.item_id                      -- item_id
            ,itc.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itc.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,ijm.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(浜岡)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_hama
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(移動)
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) use_nl (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- 2008/12/11 v1.25 N.Yoshida mod start
--            ,ABS(itc.trans_qty) * TO_NUMBER(gc_rcv_pay_div_adj) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod start
--            ,NVL(itc.trans_qty,0)             trans_qty
            ,NVL(itc.trans_qty,0) * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod end
-- 2008/12/11 v1.25 N.Yoshida mod end
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmrl
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_move
      AND    xmrih.mov_hdr_id        = xmrl.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmrl.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/12/11 v1.26 N.Yoshida mod start
      AND    xrpm.rcv_pay_div        = CASE
--                                       WHEN itc.trans_qty >= 0 THEN 1
--                                       ELSE -1
                                       WHEN itc.trans_qty >= 0 THEN -1
                                       ELSE 1
                                       END
-- 2008/12/11 v1.26 N.Yoshida mod end
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(その他払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code        IN (gv_reason_code_adji_itm
                                       ,gv_reason_code_adji_itm_u
                                       ,gv_reason_code_adji_snt_u
                                       ,gv_reason_code_adji_snt)
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 DELETE START
      --AND    xrpm.rcv_pay_div        = CASE
      --                                 WHEN itc.trans_qty >= 0 THEN 1
      --                                 ELSE -1
      --                                 END
-- 2008/11/19 v1.17 DELETE END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PROD :経理受払区分生産関連（Reverse_idなし）品種・品目振替なし
      -- ----------------------------------------------------
      SELECT /*+ leading (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) use_nl (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gme_material_details             gmd
            ,gme_batch_header                 gbh
            ,gmd_routings_b                   grb
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_prod
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.reverse_id          IS NULL
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gmd.batch_id            = itp.doc_id
      AND    gmd.line_no             = itp.doc_line
      AND    gmd.line_type           = itp.line_type
      AND    gbh.batch_id            = gmd.batch_id
      AND    grb.routing_id          = gbh.routing_id
      AND    xrpm.routing_class      = grb.routing_class
      AND    xrpm.line_type          = gmd.line_type
      AND    (((gmd.attribute5 IS NULL) AND (xrpm.hit_in_div IS NULL))
             OR (xrpm.hit_in_div = gmd.attribute5))
      AND    itp.doc_type            = xrpm.doc_type
      AND    itp.line_type           = xrpm.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    ((xrpm.routing_class    <> '70')
             OR ((xrpm.routing_class     = '70')
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd2
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd2.batch_id   = gmd.batch_id
                              AND    gmd2.line_no    = gmd.line_no
                              AND    gmd2.line_type  = -1
                              AND    gic.item_id     = gmd2.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_origin))
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd3
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd3.batch_id   = gmd.batch_id
                              AND    gmd3.line_no    = gmd.line_no
                              AND    gmd3.line_type  = 1
                              AND    gic.item_id     = gmd3.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_ahead))
             ))
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC1 :経理受払区分購買関連 (製品出荷,有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xola.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.req_status         IN ('04','08')
      AND    otta.attribute1         IN ('1','2')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC2 :経理受払区分購買関連 (振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC3 :経理受払区分購買関連 (商品振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC4 :経理受払区分購買関連 (商品振替有償、払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xoha.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC5 :経理受払区分購買関連 (振替出荷、出荷)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code <> xola.shipping_item_code
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC6 :経理受払区分購買関連 (振替出荷、受入_原料、受入_半)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC7 :経理受払区分購買関連 (倉替,返品)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC8 :経理受払区分購買関連 (見本,廃却)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
    -- ----------------------------------------------------
    -- PORC :経理受払区分購買関連（仕入）
    -- ----------------------------------------------------
      SELECT /*+ leading (itp rsl gic2 mcb2 gic1 mcb1) use_nl (itp rsl gic2 mcb2 gic1 mcb1) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,SUM(itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,rcv_shipment_lines               rsl
            ,rcv_transactions                 rt
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.source_document_code = 'PO'
      AND    rt.transaction_id       = itp.line_id
      AND    rt.shipment_line_id     = rsl.shipment_line_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = rsl.source_document_code
      AND    xrpm.transaction_type   = rt.transaction_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
-- v1.36 Add Start
      GROUP BY
             iwm.whse_code                    -- h_whse_code
            ,iwm.whse_name                    -- h_whse_name
            ,itp.item_id                      -- item_id
            ,itp.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itp.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,rsl.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO1 :経理受払区分受注関連 (製品出荷,有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
--            ,oe_order_lines_all               oola
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    otta.attribute1         IN ('1','2')
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.arrival_date      >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date      <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status        IN ('04','08')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO2 :経理受払区分受注関連 (振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO3 :経理受払区分受注関連 (商品振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO4 :経理受払区分受注関連 (商品振替有償、払出)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    mcb4.segment1           = '1'
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    mcb5.segment1           = '5'
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO5 :経理受払区分受注関連 (振替出荷、出荷)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code  <> xola.shipping_item_code
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO6 :経理受払区分受注関連 (振替出荷、受入_原料、受入_半)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           IN ('1','4')
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO7 :経理受払区分受注関連 (倉替,返品)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO8 :経理受払区分受注関連 (見本,廃却)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xoha.header_id          = ooha.header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
    -- ----------------------------------------------------
    -- 当月受払無しデータ
    -- ----------------------------------------------------
      UNION ALL
      SELECT /*+ leading (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) use_nl (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,0                                lot_id
            ,0                                trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,'1'                              column_no
            ,'1'                              rcv_pay_div
            ,TO_DATE(gv_exec_start_bef, gc_char_dt_format) trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   xxinv_stc_inventory_month_stck   xsims
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_whse_mst                      iwm
      WHERE  xsims.item_id           = iimb.item_id
      AND    ximb.item_id            = iimb.item_id
      AND    ilm.item_id             = xsims.item_id
      AND    ilm.lot_id              = xsims.lot_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.start_date_active <= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    ximb.end_date_active   >= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    gic1.item_id            = xsims.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = xsims.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = xsims.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    iwm.whse_code           = xsims.whse_code
      AND    xsims.invent_ym         = gv_exec_year_month_bef
      AND    iwm.whse_code           = ir_param.locat_code
-- 2008/12/10 v1.24 UPDATE START
--      AND    xsims.monthly_stock    <> 0
      AND    (
               (xsims.monthly_stock <> 0)
               OR
               (xsims.cargo_stock   <> 0)
             )
      AND    iwm.attribute1          = '0'
-- 2008/12/10 v1.24 UPDATE END
      ORDER BY h_whse_code      -- 倉庫コード
              ,crowd_code       -- 群コード
              ,item_code        -- 品目コード
              ,column_no        -- 項目位置
              ,rcv_pay_div      -- 受払区分
      ;
--
    --===============================================================
    -- 検索条件.帳票種別          ⇒ 倉庫・品目別
    -- 検索条件.群種別            ⇒ 群別/経理群別
    -- 検索条件.倉庫コード        ⇒ 入力なし
    -- 検索条件.群/経理群コード   ⇒ 入力あり
    --===============================================================
    CURSOR get_data_cur03 IS
      -- ----------------------------------------------------
      -- XFER :経理受払区分移動積送あり
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) use_nl (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_xfer_mst                      ixm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_xfer
      AND    itp.reason_code         = gv_reason_code_xfer
      AND    itp.completed_ind       = 1
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.doc_id              = ixm.transfer_id
      AND    ixm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = itp.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itp.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.reason_code        = itp.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- TRNI :経理受払区分移動積送なし
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_trni
      AND    itc.reason_code         = gv_reason_code_trni
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itc.doc_type            = iaj.trans_type
      AND    itc.doc_id              = iaj.doc_id
      AND    itc.doc_line            = iaj.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 ADD START
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itc.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
-- 2008/11/19 v1.17 ADD END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.rcv_pay_div        = itc.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(他)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji    --文書タイプ
      AND    itc.reason_code        IN ('X911'
                                       ,'X912'
                                       ,'X921'
                                       ,'X922'
                                       ,'X931'
                                       ,'X932'
                                       ,'X941'
                                       ,'X952'
                                       ,'X953'
                                       ,'X954'
                                       ,'X955'
                                       ,'X956'
                                       ,'X957'
                                       ,'X958'
                                       ,'X959'
                                       ,'X960'
                                       ,'X961'
                                       ,'X962'
                                       ,'X963'
-- 2008/11/19 v1.17 UPDATE START
--                                       ,'X964')
                                       ,'X964'
                                       ,'X965'
                                       ,'X966')
-- 2008/11/19 v1.17 UPDATE END
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(仕入)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
            ,SUM(itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div))) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
-- v1.36 Add Start
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
-- v1.36 Add End
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_po
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
-- v1.36 Add Start
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
-- v1.36 Add End
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
-- v1.36 Add Start
      GROUP BY
             iwm.whse_code                    -- h_whse_code
            ,iwm.whse_name                    -- h_whse_name
            ,itc.item_id                      -- item_id
            ,itc.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itc.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,ijm.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(浜岡)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_hama
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(移動)
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) use_nl (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- 2008/12/11 v1.25 N.Yoshida mod start
--            ,ABS(itc.trans_qty) * TO_NUMBER(gc_rcv_pay_div_adj) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod start
--            ,NVL(itc.trans_qty,0)             trans_qty
            ,NVL(itc.trans_qty,0) * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod end
-- 2008/12/11 v1.25 N.Yoshida mod end
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmrl
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_move
      AND    xmrih.mov_hdr_id        = xmrl.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmrl.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/12/11 v1.26 N.Yoshida mod start
      AND    xrpm.rcv_pay_div        = CASE
--                                       WHEN itc.trans_qty >= 0 THEN 1
--                                       ELSE -1
                                       WHEN itc.trans_qty >= 0 THEN -1
                                       ELSE 1
                                       END
-- 2008/12/11 v1.26 N.Yoshida mod end
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(その他払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code        IN (gv_reason_code_adji_itm
                                       ,gv_reason_code_adji_itm_u
                                       ,gv_reason_code_adji_snt_u
                                       ,gv_reason_code_adji_snt)
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 DELETE START
      --AND    xrpm.rcv_pay_div        = CASE
      --                                 WHEN itc.trans_qty >= 0 THEN 1
      --                                 ELSE -1
      --                                 END
-- 2008/11/19 v1.17 DELETE END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PROD :経理受払区分生産関連（Reverse_idなし）品種・品目振替なし
      -- ----------------------------------------------------
      SELECT /*+ leading (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) use_nl (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gme_material_details             gmd
            ,gme_batch_header                 gbh
            ,gmd_routings_b                   grb
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_prod
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.reverse_id          IS NULL
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gmd.batch_id            = itp.doc_id
      AND    gmd.line_no             = itp.doc_line
      AND    gmd.line_type           = itp.line_type
      AND    gbh.batch_id            = gmd.batch_id
      AND    grb.routing_id          = gbh.routing_id
      AND    xrpm.routing_class      = grb.routing_class
      AND    xrpm.line_type          = gmd.line_type
      AND    (((gmd.attribute5 IS NULL) AND (xrpm.hit_in_div IS NULL))
             OR (xrpm.hit_in_div = gmd.attribute5))
      AND    itp.doc_type            = xrpm.doc_type
      AND    itp.line_type           = xrpm.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    ((xrpm.routing_class    <> '70')
             OR ((xrpm.routing_class     = '70')
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd2
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd2.batch_id   = gmd.batch_id
                              AND    gmd2.line_no    = gmd.line_no
                              AND    gmd2.line_type  = -1
                              AND    gic.item_id     = gmd2.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_origin))
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd3
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd3.batch_id   = gmd.batch_id
                              AND    gmd3.line_no    = gmd.line_no
                              AND    gmd3.line_type  = 1
                              AND    gic.item_id     = gmd3.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_ahead))
             ))
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC1 :経理受払区分購買関連 (製品出荷,有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xola.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.req_status         IN ('04','08')
      AND    otta.attribute1         IN ('1','2')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC2 :経理受払区分購買関連 (振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC3 :経理受払区分購買関連 (商品振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC4 :経理受払区分購買関連 (商品振替有償、払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xoha.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC5 :経理受払区分購買関連 (振替出荷、出荷)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code <> xola.shipping_item_code
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC6 :経理受払区分購買関連 (振替出荷、受入_原料、受入_半)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC7 :経理受払区分購買関連 (倉替,返品)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC8 :経理受払区分購買関連 (見本,廃却)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- PORC :経理受払区分購買関連（仕入）
    -- ----------------------------------------------------
      SELECT /*+ leading (itp rsl gic2 mcb2 gic1 mcb1) use_nl (itp rsl gic2 mcb2 gic1 mcb1) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,SUM(itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,rcv_shipment_lines               rsl
            ,rcv_transactions                 rt
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.source_document_code = 'PO'
      AND    rt.transaction_id       = itp.line_id
      AND    rt.shipment_line_id     = rsl.shipment_line_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = rsl.source_document_code
      AND    xrpm.transaction_type   = rt.transaction_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
-- v1.36 Add Start
      GROUP BY
             iwm.whse_code                    -- h_whse_code
            ,iwm.whse_name                    -- h_whse_name
            ,itp.item_id                      -- item_id
            ,itp.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itp.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,rsl.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO1 :経理受払区分受注関連 (製品出荷,有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
--            ,oe_order_lines_all               oola
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    otta.attribute1         IN ('1','2')
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.arrival_date      >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date      <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status        IN ('04','08')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO2 :経理受払区分受注関連 (振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO3 :経理受払区分受注関連 (商品振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO4 :経理受払区分受注関連 (商品振替有償、払出)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    mcb4.segment1           = '1'
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    mcb5.segment1           = '5'
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO5 :経理受払区分受注関連 (振替出荷、出荷)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code  <> xola.shipping_item_code
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO6 :経理受払区分受注関連 (振替出荷、受入_原料、受入_半)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           IN ('1','4')
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO7 :経理受払区分受注関連 (倉替,返品)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO8 :経理受払区分受注関連 (見本,廃却)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xoha.header_id          = ooha.header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    mcb3.segment1           = lt_crowd_code
    -- ----------------------------------------------------
    -- 当月受払無しデータ
    -- ----------------------------------------------------
      UNION ALL
      SELECT /*+ leading (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) use_nl (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,0                                lot_id
            ,0                                trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,'1'                              column_no
            ,'1'                              rcv_pay_div
            ,TO_DATE(gv_exec_start_bef, gc_char_dt_format) trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   xxinv_stc_inventory_month_stck   xsims
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_whse_mst                      iwm
      WHERE  xsims.item_id           = iimb.item_id
      AND    ximb.item_id            = iimb.item_id
      AND    ilm.item_id             = xsims.item_id
      AND    ilm.lot_id              = xsims.lot_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.start_date_active <= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    ximb.end_date_active   >= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    gic1.item_id            = xsims.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = xsims.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = xsims.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    iwm.whse_code           = xsims.whse_code
      AND    xsims.invent_ym         = gv_exec_year_month_bef
      AND    mcb3.segment1           = lt_crowd_code
-- 2008/12/10 v1.24 UPDATE START
--      AND    xsims.monthly_stock    <> 0
      AND    (
               (xsims.monthly_stock <> 0)
               OR
               (xsims.cargo_stock   <> 0)
             )
      AND    iwm.attribute1          = '0'
-- 2008/12/10 v1.24 UPDATE END
      ORDER BY h_whse_code      -- 倉庫コード
              ,crowd_code       -- 群コード
              ,item_code        -- 品目コード
              ,column_no        -- 項目位置
              ,rcv_pay_div      -- 受払区分
      ;
--
    --===============================================================
    -- 検索条件.帳票種別          ⇒ 倉庫・品目別
    -- 検索条件.群種別            ⇒ 群別/経理群別
    -- 検索条件.倉庫コード        ⇒ 入力あり
    -- 検索条件.群/経理群コード   ⇒ 入力あり
    --===============================================================
    CURSOR get_data_cur04 IS
      -- ----------------------------------------------------
      -- XFER :経理受払区分移動積送あり
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) use_nl (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_xfer_mst                      ixm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_xfer
      AND    itp.reason_code         = gv_reason_code_xfer
      AND    itp.completed_ind       = 1
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.doc_id              = ixm.transfer_id
      AND    ixm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = itp.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itp.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.reason_code        = itp.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- TRNI :経理受払区分移動積送なし
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_trni
      AND    itc.reason_code         = gv_reason_code_trni
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itc.doc_type            = iaj.trans_type
      AND    itc.doc_id              = iaj.doc_id
      AND    itc.doc_line            = iaj.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 ADD START
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itc.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
-- 2008/11/19 v1.17 ADD END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.rcv_pay_div        = itc.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(他)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji    --文書タイプ
      AND    itc.reason_code        IN ('X911'
                                       ,'X912'
                                       ,'X921'
                                       ,'X922'
                                       ,'X931'
                                       ,'X932'
                                       ,'X941'
                                       ,'X952'
                                       ,'X953'
                                       ,'X954'
                                       ,'X955'
                                       ,'X956'
                                       ,'X957'
                                       ,'X958'
                                       ,'X959'
                                       ,'X960'
                                       ,'X961'
                                       ,'X962'
                                       ,'X963'
-- 2008/11/19 v1.17 UPDATE START
--                                       ,'X964')
                                       ,'X964'
                                       ,'X965'
                                       ,'X966')
-- 2008/11/19 v1.17 UPDATE END
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(仕入)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
            ,SUM(itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div))) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
-- v1.36 Add Start
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
-- v1.36 Add End
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_po
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
-- v1.36 Add Start
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
-- v1.36 Add End
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
-- v1.36 Add Start
      GROUP BY
             iwm.whse_code                    -- h_whse_code
            ,iwm.whse_name                    -- h_whse_name
            ,itc.item_id                      -- item_id
            ,itc.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itc.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,ijm.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(浜岡)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_hama
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(移動)
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) use_nl (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- 2008/12/11 v1.25 N.Yoshida mod start
--            ,ABS(itc.trans_qty) * TO_NUMBER(gc_rcv_pay_div_adj) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod start
--            ,NVL(itc.trans_qty,0)             trans_qty
            ,NVL(itc.trans_qty,0) * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod end
-- 2008/12/11 v1.25 N.Yoshida mod end
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmrl
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_move
      AND    xmrih.mov_hdr_id        = xmrl.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmrl.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/12/11 v1.26 N.Yoshida mod start
      AND    xrpm.rcv_pay_div        = CASE
--                                       WHEN itc.trans_qty >= 0 THEN 1
--                                       ELSE -1
                                       WHEN itc.trans_qty >= 0 THEN -1
                                       ELSE 1
                                       END
-- 2008/12/11 v1.26 N.Yoshida mod end
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(その他払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code        IN (gv_reason_code_adji_itm
                                       ,gv_reason_code_adji_itm_u
                                       ,gv_reason_code_adji_snt_u
                                       ,gv_reason_code_adji_snt)
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 DELETE START
      --AND    xrpm.rcv_pay_div        = CASE
      --                                 WHEN itc.trans_qty >= 0 THEN 1
      --                                 ELSE -1
      --                                 END
-- 2008/11/19 v1.17 DELETE END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itc.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itc.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PROD :経理受払区分生産関連（Reverse_idなし）品種・品目振替なし
      -- ----------------------------------------------------
      SELECT /*+ leading (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) use_nl (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gme_material_details             gmd
            ,gme_batch_header                 gbh
            ,gmd_routings_b                   grb
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_prod
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.reverse_id          IS NULL
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gmd.batch_id            = itp.doc_id
      AND    gmd.line_no             = itp.doc_line
      AND    gmd.line_type           = itp.line_type
      AND    gbh.batch_id            = gmd.batch_id
      AND    grb.routing_id          = gbh.routing_id
      AND    xrpm.routing_class      = grb.routing_class
      AND    xrpm.line_type          = gmd.line_type
      AND    (((gmd.attribute5 IS NULL) AND (xrpm.hit_in_div IS NULL))
             OR (xrpm.hit_in_div = gmd.attribute5))
      AND    itp.doc_type            = xrpm.doc_type
      AND    itp.line_type           = xrpm.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    ((xrpm.routing_class    <> '70')
             OR ((xrpm.routing_class     = '70')
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd2
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd2.batch_id   = gmd.batch_id
                              AND    gmd2.line_no    = gmd.line_no
                              AND    gmd2.line_type  = -1
                              AND    gic.item_id     = gmd2.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_origin))
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd3
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd3.batch_id   = gmd.batch_id
                              AND    gmd3.line_no    = gmd.line_no
                              AND    gmd3.line_type  = 1
                              AND    gic.item_id     = gmd3.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_ahead))
             ))
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC1 :経理受払区分購買関連 (製品出荷,有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xola.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.req_status         IN ('04','08')
      AND    otta.attribute1         IN ('1','2')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC2 :経理受払区分購買関連 (振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC3 :経理受払区分購買関連 (商品振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC4 :経理受払区分購買関連 (商品振替有償、払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xoha.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC5 :経理受払区分購買関連 (振替出荷、出荷)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code <> xola.shipping_item_code
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC6 :経理受払区分購買関連 (振替出荷、受入_原料、受入_半)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC7 :経理受払区分購買関連 (倉替,返品)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
      -- ----------------------------------------------------
      -- PORC8 :経理受払区分購買関連 (見本,廃却)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- PORC :経理受払区分購買関連（仕入）
    -- ----------------------------------------------------
      SELECT /*+ leading (itp rsl gic2 mcb2 gic1 mcb1) use_nl (itp rsl gic2 mcb2 gic1 mcb1) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,SUM(itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,rcv_shipment_lines               rsl
            ,rcv_transactions                 rt
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.source_document_code = 'PO'
      AND    rt.transaction_id       = itp.line_id
      AND    rt.shipment_line_id     = rsl.shipment_line_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = rsl.source_document_code
      AND    xrpm.transaction_type   = rt.transaction_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
-- v1.36 Add Start
      GROUP BY
             iwm.whse_code                    -- h_whse_code
            ,iwm.whse_name                    -- h_whse_name
            ,itp.item_id                      -- item_id
            ,itp.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itp.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,rsl.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO1 :経理受払区分受注関連 (製品出荷,有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
--            ,oe_order_lines_all               oola
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    otta.attribute1         IN ('1','2')
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.arrival_date      >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date      <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status        IN ('04','08')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO2 :経理受払区分受注関連 (振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO3 :経理受払区分受注関連 (商品振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO4 :経理受払区分受注関連 (商品振替有償、払出)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    mcb4.segment1           = '1'
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    mcb5.segment1           = '5'
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO5 :経理受払区分受注関連 (振替出荷、出荷)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code  <> xola.shipping_item_code
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO6 :経理受払区分受注関連 (振替出荷、受入_原料、受入_半)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           IN ('1','4')
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO7 :経理受払区分受注関連 (倉替,返品)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO8 :経理受払区分受注関連 (見本,廃却)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
            ,ic_whse_mst                      iwm
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xoha.header_id          = ooha.header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    iwm.whse_code           = itp.whse_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      AND    itp.whse_code           = ir_param.locat_code
      AND    mcb3.segment1           = lt_crowd_code
    -- ----------------------------------------------------
    -- 当月受払無しデータ
    -- ----------------------------------------------------
      UNION ALL
      SELECT /*+ leading (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) use_nl (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) */
             iwm.whse_code                    h_whse_code
            ,iwm.whse_name                    h_whse_name
            ,iimb.item_id                     item_id
            ,0                                lot_id
            ,0                                trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,'1'                              column_no
            ,'1'                              rcv_pay_div
            ,TO_DATE(gv_exec_start_bef, gc_char_dt_format) trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   xxinv_stc_inventory_month_stck   xsims
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_whse_mst                      iwm
      WHERE  xsims.item_id           = iimb.item_id
      AND    ximb.item_id            = iimb.item_id
      AND    ilm.item_id             = xsims.item_id
      AND    ilm.lot_id              = xsims.lot_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.start_date_active <= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    ximb.end_date_active   >= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    gic1.item_id            = xsims.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = xsims.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = xsims.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    iwm.whse_code           = xsims.whse_code
      AND    xsims.invent_ym         = gv_exec_year_month_bef
      AND    mcb3.segment1           = lt_crowd_code
      AND    iwm.whse_code           = ir_param.locat_code
-- 2008/12/10 v1.24 UPDATE START
--      AND    xsims.monthly_stock    <> 0
      AND    (
               (xsims.monthly_stock <> 0)
               OR
               (xsims.cargo_stock   <> 0)
             )
      AND    iwm.attribute1          = '0'
-- 2008/12/10 v1.24 UPDATE END
      ORDER BY h_whse_code      -- 倉庫コード
              ,crowd_code       -- 群コード
              ,item_code        -- 品目コード
              ,column_no        -- 項目位置
              ,rcv_pay_div      -- 受払区分
      ;
--
    --===============================================================
    -- 検索条件.帳票種別          ⇒ 品目別
    -- 検索条件.群種別            ⇒ 群別/経理群別
    -- 検索条件.倉庫コード        ⇒ 入力なし
    -- 検索条件.群/経理群コード   ⇒ 入力なし
    --===============================================================
    CURSOR get_data_cur05 IS
      -- ----------------------------------------------------
      -- XFER :経理受払区分移動積送あり
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) use_nl (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_xfer_mst                      ixm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_xfer
      AND    itp.reason_code         = gv_reason_code_xfer
      AND    itp.completed_ind       = 1
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.doc_id              = ixm.transfer_id
      AND    ixm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = itp.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itp.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.reason_code        = itp.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- TRNI :経理受払区分移動積送なし
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_trni
      AND    itc.reason_code         = gv_reason_code_trni
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itc.doc_type            = iaj.trans_type
      AND    itc.doc_id              = iaj.doc_id
      AND    itc.doc_line            = iaj.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 ADD START
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itc.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
-- 2008/11/19 v1.17 ADD END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.rcv_pay_div        = itc.line_type
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(他)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji    --文書タイプ
      AND    itc.reason_code        IN ('X911'
                                       ,'X912'
                                       ,'X921'
                                       ,'X922'
                                       ,'X931'
                                       ,'X932'
                                       ,'X941'
                                       ,'X952'
                                       ,'X953'
                                       ,'X954'
                                       ,'X955'
                                       ,'X956'
                                       ,'X957'
                                       ,'X958'
                                       ,'X959'
                                       ,'X960'
                                       ,'X961'
                                       ,'X962'
                                       ,'X963'
-- 2008/11/19 v1.17 UPDATE START
--                                       ,'X964')
                                       ,'X964'
                                       ,'X965'
                                       ,'X966')
-- 2008/11/19 v1.17 UPDATE END
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(仕入)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
            ,SUM(itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div))) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
-- v1.36 Add Start
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
-- v1.36 Add End
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_po
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
-- v1.36 Add Start
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
-- v1.36 Add End
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
-- v1.36 Add Start
      GROUP BY
             itc.item_id                      -- item_id
            ,itc.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itc.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,ijm.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(浜岡)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_hama
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(移動)
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) use_nl (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- 2008/12/11 v1.25 N.Yoshida mod start
--            ,ABS(itc.trans_qty) * TO_NUMBER(gc_rcv_pay_div_adj) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod start
--            ,NVL(itc.trans_qty,0)             trans_qty
            ,NVL(itc.trans_qty,0) * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod end
-- 2008/12/11 v1.25 N.Yoshida mod end
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmrl
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_move
      AND    xmrih.mov_hdr_id        = xmrl.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmrl.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/12/11 v1.26 N.Yoshida mod start
      AND    xrpm.rcv_pay_div        = CASE
--                                       WHEN itc.trans_qty >= 0 THEN 1
--                                       ELSE -1
                                       WHEN itc.trans_qty >= 0 THEN -1
                                       ELSE 1
                                       END
-- 2008/12/11 v1.26 N.Yoshida mod end
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(その他払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code        IN (gv_reason_code_adji_itm
                                       ,gv_reason_code_adji_itm_u
                                       ,gv_reason_code_adji_snt_u
                                       ,gv_reason_code_adji_snt)
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 DELETE START
      --AND    xrpm.rcv_pay_div        = CASE
      --                                 WHEN itc.trans_qty >= 0 THEN 1
      --                                 ELSE -1
      --                                 END
-- 2008/11/19 v1.17 DELETE END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PROD :経理受払区分生産関連（Reverse_idなし）品種・品目振替なし
      -- ----------------------------------------------------
      SELECT /*+ leading (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) use_nl (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gme_material_details             gmd
            ,gme_batch_header                 gbh
            ,gmd_routings_b                   grb
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_prod
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.reverse_id          IS NULL
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gmd.batch_id            = itp.doc_id
      AND    gmd.line_no             = itp.doc_line
      AND    gmd.line_type           = itp.line_type
      AND    gbh.batch_id            = gmd.batch_id
      AND    grb.routing_id          = gbh.routing_id
      AND    xrpm.routing_class      = grb.routing_class
      AND    xrpm.line_type          = gmd.line_type
      AND    (((gmd.attribute5 IS NULL) AND (xrpm.hit_in_div IS NULL))
             OR (xrpm.hit_in_div = gmd.attribute5))
      AND    itp.doc_type            = xrpm.doc_type
      AND    itp.line_type           = xrpm.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    ((xrpm.routing_class    <> '70')
             OR ((xrpm.routing_class     = '70')
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd2
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd2.batch_id   = gmd.batch_id
                              AND    gmd2.line_no    = gmd.line_no
                              AND    gmd2.line_type  = -1
                              AND    gic.item_id     = gmd2.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_origin))
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd3
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd3.batch_id   = gmd.batch_id
                              AND    gmd3.line_no    = gmd.line_no
                              AND    gmd3.line_type  = 1
                              AND    gic.item_id     = gmd3.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_ahead))
             ))
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC1 :経理受払区分購買関連 (製品出荷,有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xola.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.req_status         IN ('04','08')
      AND    otta.attribute1         IN ('1','2')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC2 :経理受払区分購買関連 (振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC3 :経理受払区分購買関連 (商品振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC4 :経理受払区分購買関連 (商品振替有償、払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xoha.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC5 :経理受払区分購買関連 (振替出荷、出荷)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code <> xola.shipping_item_code
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC6 :経理受払区分購買関連 (振替出荷、受入_原料、受入_半)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC7 :経理受払区分購買関連 (倉替,返品)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC8 :経理受払区分購買関連 (見本,廃却)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- PORC :経理受払区分購買関連（仕入）
    -- ----------------------------------------------------
      SELECT /*+ leading (itp rsl gic2 mcb2 gic1 mcb1) use_nl (itp rsl gic2 mcb2 gic1 mcb1) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,SUM(itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,rcv_shipment_lines               rsl
            ,rcv_transactions                 rt
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.source_document_code = 'PO'
      AND    rt.transaction_id       = itp.line_id
      AND    rt.shipment_line_id     = rsl.shipment_line_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = rsl.source_document_code
      AND    xrpm.transaction_type   = rt.transaction_type
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
-- v1.36 Add Start
      GROUP BY
             itp.item_id                      -- item_id
            ,itp.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itp.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,rsl.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO1 :経理受払区分受注関連 (製品出荷,有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
--            ,oe_order_lines_all               oola
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    otta.attribute1         IN ('1','2')
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.arrival_date      >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date      <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status        IN ('04','08')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO2 :経理受払区分受注関連 (振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO3 :経理受払区分受注関連 (商品振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO4 :経理受払区分受注関連 (商品振替有償、払出)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    mcb4.segment1           = '1'
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    mcb5.segment1           = '5'
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO5 :経理受払区分受注関連 (振替出荷、出荷)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code  <> xola.shipping_item_code
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO6 :経理受払区分受注関連 (振替出荷、受入_原料、受入_半)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           IN ('1','4')
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO7 :経理受払区分受注関連 (倉替,返品)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO8 :経理受払区分受注関連 (見本,廃却)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xoha.header_id          = ooha.header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
    -- ----------------------------------------------------
    -- 当月受払無しデータ
    -- ----------------------------------------------------
      UNION ALL
      SELECT /*+ leading (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) use_nl (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,0                                lot_id
            ,0                                trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,'1'                              column_no
            ,'1'                              rcv_pay_div
            ,TO_DATE(gv_exec_start_bef, gc_char_dt_format) trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   xxinv_stc_inventory_month_stck   xsims
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
-- 2008/12/10 v1.24 ADD START
            ,ic_whse_mst                      iwm
-- 2008/12/10 v1.24 ADD END
      WHERE  xsims.item_id           = iimb.item_id
      AND    ximb.item_id            = iimb.item_id
      AND    ilm.item_id             = xsims.item_id
      AND    ilm.lot_id              = xsims.lot_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.start_date_active <= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    ximb.end_date_active   >= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    gic1.item_id            = xsims.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = xsims.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = xsims.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xsims.invent_ym         = gv_exec_year_month_bef
-- 2008/12/10 v1.24 UPDATE START
--      AND    xsims.monthly_stock    <> 0
      AND    (
               (xsims.monthly_stock <> 0)
               OR
               (xsims.cargo_stock   <> 0)
             )
      AND    iwm.whse_code           = xsims.whse_code
      AND    iwm.attribute1          = '0'
-- 2008/12/10 v1.24 UPDATE END
      ORDER BY crowd_code       -- 群コード
              ,item_code        -- 品目コード
              ,column_no        -- 項目位置
              ,rcv_pay_div      -- 受払区分
      ;
--
    --===============================================================
    -- 検索条件.帳票種別          ⇒ 品目別
    -- 検索条件.群種別            ⇒ 群別/経理群別
    -- 検索条件.倉庫コード        ⇒ 入力なし
    -- 検索条件.群/経理群コード   ⇒ 入力あり
    --===============================================================
    CURSOR get_data_cur06 IS
      -- ----------------------------------------------------
      -- XFER :経理受払区分移動積送あり
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) use_nl (xmrih xmril ixm itp gic2 mcb2 gic1 mcb1 iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_xfer_mst                      ixm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_xfer
      AND    itp.reason_code         = gv_reason_code_xfer
      AND    itp.completed_ind       = 1
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.doc_id              = ixm.transfer_id
      AND    ixm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = itp.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itp.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.reason_code        = itp.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- TRNI :経理受払区分移動積送なし
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (xmrih xmril ijm iaj itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmril
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_trni
      AND    itc.reason_code         = gv_reason_code_trni
      AND    xmrih.mov_hdr_id        = xmril.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itc.doc_type            = iaj.trans_type
      AND    itc.doc_id              = iaj.doc_id
      AND    itc.doc_line            = iaj.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmril.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 ADD START
      AND    xrpm.rcv_pay_div        = CASE
                                       WHEN itc.trans_qty >= 0 THEN 1
                                       ELSE -1
                                       END
-- 2008/11/19 v1.17 ADD END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.rcv_pay_div        = itc.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(他)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji    --文書タイプ
      AND    itc.reason_code        IN ('X911'
                                       ,'X912'
                                       ,'X921'
                                       ,'X922'
                                       ,'X931'
                                       ,'X932'
                                       ,'X941'
                                       ,'X952'
                                       ,'X953'
                                       ,'X954'
                                       ,'X955'
                                       ,'X956'
                                       ,'X957'
                                       ,'X958'
                                       ,'X959'
                                       ,'X960'
                                       ,'X961'
                                       ,'X962'
                                       ,'X963'
-- 2008/11/19 v1.17 UPDATE START
--                                       ,'X964')
                                       ,'X964'
                                       ,'X965'
                                       ,'X966')
-- 2008/11/19 v1.17 UPDATE END
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(仕入)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
            ,SUM(itc.trans_qty * ABS(TO_NUMBER(xrpm.rcv_pay_div))) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
-- v1.36 Add Start
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
-- v1.36 Add End
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_po
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
-- v1.36 Add Start
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
-- v1.36 Add End
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
-- v1.36 Add Start
      GROUP BY
             itc.item_id                      -- item_id
            ,itc.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itc.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,ijm.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(浜岡)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 xrpm ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_hama
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(移動)
      -- ----------------------------------------------------
      SELECT /*+ leading (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) use_nl (xmrih xmrl ijm iaj itc gic1 mcb1 gic2 mcb2) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
-- 2008/12/11 v1.25 N.Yoshida mod start
--            ,ABS(itc.trans_qty) * TO_NUMBER(gc_rcv_pay_div_adj) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod start
--            ,NVL(itc.trans_qty,0)             trans_qty
            ,NVL(itc.trans_qty,0) * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
-- 2008/12/12 v1.26 N.Yoshida mod end
-- 2008/12/11 v1.25 N.Yoshida mod end
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_adjs_jnl                      iaj
            ,ic_jrnl_mst                      ijm
            ,xxinv_mov_req_instr_lines        xmrl
            ,xxinv_mov_req_instr_headers      xmrih
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code         = gv_reason_code_adji_move
      AND    xmrih.mov_hdr_id        = xmrl.mov_hdr_id
      AND    xmrih.actual_arrival_date  >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xmrih.actual_arrival_date  <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    iaj.trans_type          = itc.doc_type
      AND    iaj.doc_id              = itc.doc_id
      AND    iaj.doc_line            = itc.doc_line
      AND    ijm.journal_id          = iaj.journal_id
      AND    ijm.attribute1          = TO_CHAR(xmrl.mov_line_id)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/12/11 v1.26 N.Yoshida mod start
      AND    xrpm.rcv_pay_div        = CASE
--                                       WHEN itc.trans_qty >= 0 THEN 1
--                                       ELSE -1
                                       WHEN itc.trans_qty >= 0 THEN -1
                                       ELSE 1
                                       END
-- 2008/12/11 v1.26 N.Yoshida mod end
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- ADJI :経理受払区分在庫調整(その他払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) use_nl (itc gic2 mcb2 gic1 mcb1 ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itc.item_id                      item_id
            ,itc.lot_id                       lot_id
            ,itc.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itc.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_cmp                      itc
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itc.doc_type            = gv_doc_type_adji
      AND    itc.reason_code        IN (gv_reason_code_adji_itm
                                       ,gv_reason_code_adji_itm_u
                                       ,gv_reason_code_adji_snt_u
                                       ,gv_reason_code_adji_snt)
      AND    itc.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itc.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itc.item_id
      AND    ilm.lot_id              = itc.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itc.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itc.trans_date)
      AND    gic1.item_id            = itc.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itc.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itc.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
-- 2008/11/19 v1.17 DELETE START
      --AND    xrpm.rcv_pay_div        = CASE
      --                                 WHEN itc.trans_qty >= 0 THEN 1
      --                                 ELSE -1
      --                                 END
-- 2008/11/19 v1.17 DELETE END
      AND    xrpm.doc_type           = itc.doc_type
      AND    xrpm.reason_code        = itc.reason_code
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itc.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PROD :経理受払区分生産関連（Reverse_idなし）品種・品目振替なし
      -- ----------------------------------------------------
      SELECT /*+ leading (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) use_nl (itp gic2 mcb2 gic1 mcb1 gmd gbh grb ilm iimb ximb) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gme_material_details             gmd
            ,gme_batch_header                 gbh
            ,gmd_routings_b                   grb
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_prod
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    itp.reverse_id          IS NULL
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gmd.batch_id            = itp.doc_id
      AND    gmd.line_no             = itp.doc_line
      AND    gmd.line_type           = itp.line_type
      AND    gbh.batch_id            = gmd.batch_id
      AND    grb.routing_id          = gbh.routing_id
      AND    xrpm.routing_class      = grb.routing_class
      AND    xrpm.line_type          = gmd.line_type
      AND    (((gmd.attribute5 IS NULL) AND (xrpm.hit_in_div IS NULL))
             OR (xrpm.hit_in_div = gmd.attribute5))
      AND    itp.doc_type            = xrpm.doc_type
      AND    itp.line_type           = xrpm.line_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    ((xrpm.routing_class    <> '70')
             OR ((xrpm.routing_class     = '70')
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd2
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd2.batch_id   = gmd.batch_id
                              AND    gmd2.line_no    = gmd.line_no
                              AND    gmd2.line_type  = -1
                              AND    gic.item_id     = gmd2.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_origin))
                 AND (EXISTS (SELECT 1
                              FROM   gme_material_details gmd3
                                    ,gmi_item_categories  gic
                                    ,mtl_categories_b     mcb
                              WHERE  gmd3.batch_id   = gmd.batch_id
                              AND    gmd3.line_no    = gmd.line_no
                              AND    gmd3.line_type  = 1
                              AND    gic.item_id     = gmd3.item_id
                              AND    gic.category_set_id = cn_item_class_id
                              AND    gic.category_id = mcb.category_id
                              AND    mcb.segment1    = xrpm.item_div_ahead))
             ))
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC1 :経理受払区分購買関連 (製品出荷,有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xola.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.req_status         IN ('04','08')
      AND    otta.attribute1         IN ('1','2')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC2 :経理受払区分購買関連 (振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC3 :経理受払区分購買関連 (商品振替有償)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC4 :経理受払区分購買関連 (商品振替有償、払出)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola rsl itp gic1 mcb1 gic2 mcb2 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.oe_order_header_id  = xoha.header_id
      AND    rsl.oe_order_line_id    = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC5 :経理受払区分購買関連 (振替出荷、出荷)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code <> xola.shipping_item_code
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    ooha.header_id          = rsl.oe_order_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC6 :経理受払区分購買関連 (振替出荷、受入_原料、受入_半)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) use_nl (xoha xola iimb gic2 mcb2 gic1 mcb1 ooha otta rsl itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    ooha.header_id          = xoha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC7 :経理受払区分購買関連 (倉替,返品)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
      -- ----------------------------------------------------
      -- PORC8 :経理受払区分購買関連 (見本,廃却)
      -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) use_nl (xoha xola iimb2 gic2 mcb2 gic1 mcb1 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,rcv_shipment_lines               rsl
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    xoha.header_id          = rsl.oe_order_header_id
      AND    xola.line_id            = rsl.oe_order_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = 'RMA'
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- PORC :経理受払区分購買関連（仕入）
    -- ----------------------------------------------------
      SELECT /*+ leading (itp rsl gic2 mcb2 gic1 mcb1) use_nl (itp rsl gic2 mcb2 gic1 mcb1) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
-- v1.36 Mod Start
--            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,SUM(itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)) trans_qty
-- v1.36 Mod End
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,rcv_shipment_lines               rsl
            ,rcv_transactions                 rt
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_porc
      AND    itp.completed_ind       = 1
      AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    rsl.shipment_header_id  = itp.doc_id
      AND    rsl.line_num            = itp.doc_line
      AND    rsl.source_document_code = 'PO'
      AND    rt.transaction_id       = itp.line_id
      AND    rt.shipment_line_id     = rsl.shipment_line_id
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.source_document_code = rsl.source_document_code
      AND    xrpm.transaction_type   = rt.transaction_type
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
-- v1.36 Add Start
      GROUP BY
             itp.item_id                      -- item_id
            ,itp.lot_id                       -- lot_id
            ,iimb.attribute15                 -- cost_mng_clss
            ,iimb.lot_ctl                     -- lot_ctl
            ,xlc.unit_ploce                   -- actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              -- column_no
            ,xrpm.rcv_pay_div                 -- rcv_pay_div
            ,itp.trans_date                   -- trans_date
            ,mcb3.segment1                    -- crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      -- crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      -- crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      -- crowd_high
            ,iimb.item_no                     -- item_code
            ,ximb.item_short_name             -- item_name
            ,rsl.attribute1                   -- 受入返品実績アドオン.取引ID
-- v1.36 Add End
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO1 :経理受払区分受注関連 (製品出荷,有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
--            ,oe_order_lines_all               oola
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    otta.attribute1         IN ('1','2')
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    xrpm.item_div_ahead     = '5'
      AND    xoha.arrival_date      >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date      <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status        IN ('04','08')
      AND    xola.request_item_code  = xola.shipping_item_code
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('102','103')
      AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
             OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO2 :経理受払区分受注関連 (振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           <> '5'
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('104','105')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO3 :経理受払区分受注関連 (商品振替有償)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_ahead     = mcb1.segment1
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xrpm.prod_div_origin    = mcb4.segment1
      AND    gic5.item_id            = itp.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    gic5.category_id        = mcb5.category_id
      AND    xrpm.item_div_origin    = mcb5.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    ooha.header_id          = xoha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('107','108')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO4 :経理受払区分受注関連 (商品振替有償、払出)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) use_nl (xoha xola wdd itp gic1 mcb1 gic2 mcb2 ooha otta xrpm) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,ic_item_mst_b                    iimb2
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,gmi_item_categories              gic5
            ,mtl_categories_b                 mcb5
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = itp.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    xrpm.prod_div_origin    = mcb1.segment1
      AND    gic2.item_id            = itp.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_origin    = mcb2.segment1
      AND    gic3.item_id            = itp.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '2'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '08'
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       = '109'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xola.request_item_code  = iimb2.item_no
      AND    gic4.item_id            = iimb2.item_id
      AND    gic4.category_set_id    = cn_prod_class_id
      AND    mcb4.category_id        = gic4.category_id
      AND    mcb4.segment1           = '1'
      AND    gic5.item_id            = iimb2.item_id
      AND    gic5.category_set_id    = cn_item_class_id
      AND    mcb5.category_id        = gic5.category_id
      AND    mcb5.segment1           = '5'
      AND    xrpm.prod_div_ahead     = mcb4.segment1
      AND    xrpm.item_div_ahead     = mcb5.segment1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO5 :経理受払区分受注関連 (振替出荷、出荷)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    xola.request_item_code  <> xola.shipping_item_code
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.header_id          = wdd.source_header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       = '112'
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO6 :経理受払区分受注関連 (振替出荷、受入_原料、受入_半)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) use_nl (xoha xola iimb gic1 mcb1 gic2 mcb2 ooha otta xrpm wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,itp.lot_id                       lot_id
            ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                 ,gv_d_name_item_trn_rcv
                                                 ,gv_d_name_trn_ship_rcv_gen
                                                 ,gv_d_name_trn_ship_rcv_han)
                       THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                  ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
             END                              trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,gmi_item_categories              gic4
            ,mtl_categories_b                 mcb4
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = xrpm.doc_type
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_no            = xola.request_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    xrpm.item_div_ahead     = mcb2.segment1
      AND    gic3.item_id            = iimb.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    gic4.item_id            = itp.item_id
      AND    gic4.category_set_id    = cn_item_class_id
      AND    gic4.category_id        = mcb4.category_id
      AND    mcb4.segment1           IN ('1','4')
      AND    xrpm.item_div_origin    = mcb4.segment1
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xoha.header_id          = ooha.header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '1'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xoha.req_status         = '04'
      AND    xrpm.doc_type           = gv_doc_type_omso
      AND    xrpm.dealings_div       IN ('110','111')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO7 :経理受払区分受注関連 (倉替,返品)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 wdd itp ooha otta xrpm) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    wdd.source_header_id    = xoha.header_id
      AND    wdd.source_line_id      = xola.line_id
      AND    xoha.header_id          = ooha.header_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    ((otta.attribute4           <> '2')
             OR  (otta.attribute4       IS NULL))
      AND    otta.attribute1         = '3'
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('201','203')
      AND    xrpm.shipment_provision_div = otta.attribute1
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
      UNION ALL
    -- ----------------------------------------------------
    -- OMSO8 :経理受払区分受注関連 (見本,廃却)
    -- ----------------------------------------------------
      SELECT /*+ leading (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) use_nl (xoha xola iimb2 gic1 mcb1 gic2 mcb2 ooha otta wdd itp) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,itp.item_id                      item_id
            ,itp.lot_id                       lot_id
            ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div) trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,CASE WHEN INSTR(xrpm.break_col_02,gc_break_col) = 0
                  THEN ''
                  WHEN xrpm.rcv_pay_div = gc_rcv_pay_div_in
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  WHEN xrpm.dealings_div_name = gv_dealings_name_po
                  THEN SUBSTR(xrpm.break_col_02,1,INSTR(xrpm.break_col_02,gc_break_col)-1)
                  ELSE SUBSTR(xrpm.break_col_02,INSTR(xrpm.break_col_02,gc_break_col)+1)
             END                              column_no
            ,xrpm.rcv_pay_div                 rcv_pay_div
            ,itp.trans_date                   trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   ic_tran_pnd                      itp
            ,wsh_delivery_details             wdd
            ,oe_order_headers_all             ooha
            ,oe_transaction_types_all         otta
            ,xxwsh_order_headers_all          xoha
            ,xxwsh_order_lines_all            xola
            ,ic_item_mst_b                    iimb
            ,ic_item_mst_b                    iimb2
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
            ,xxcmn_rcv_pay_mst                xrpm
-- 2009/03/05 Y.Yamamoto #1274 add start
            ,ic_whse_mst                      iwm
-- 2009/03/05 Y.Yamamoto #1274 add end
      WHERE  itp.doc_type            = gv_doc_type_omso
      AND    itp.completed_ind       = 1
      AND    xoha.latest_external_flag = 'Y'
      AND    ilm.item_id             = itp.item_id
      AND    ilm.lot_id              = itp.lot_id
      AND    iimb.item_id            = ilm.item_id
      AND    iimb2.item_no           = xola.shipping_item_code
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.item_id            = iimb.item_id
      AND    ximb.start_date_active <= TRUNC(itp.trans_date)
      AND    ximb.end_date_active   >= TRUNC(itp.trans_date)
      AND    gic1.item_id            = iimb2.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = iimb2.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = iimb2.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    wdd.delivery_detail_id  = itp.line_detail_id
      AND    xoha.header_id          = wdd.source_header_id
      AND    xola.line_id            = wdd.source_line_id
      AND    xola.order_header_id    = xoha.order_header_id
      AND    otta.transaction_type_id = ooha.order_type_id
      AND    xoha.header_id          = ooha.header_id
      AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(gv_exec_start,gc_char_dt_format)
      AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(gv_exec_end,gc_char_dt_format)
      AND    xrpm.doc_type           = itp.doc_type
      AND    xrpm.dealings_div       IN ('504','509')
      AND    xrpm.stock_adjustment_div = otta.attribute4
      AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
      AND    xrpm.break_col_02       IS NOT NULL
      AND    mcb3.segment1           = lt_crowd_code
-- 2009/03/05 Y.Yamamoto #1274 add start
      AND    iwm.whse_code           = itp.whse_code
      AND    iwm.attribute1          = '0'
-- 2009/03/05 Y.Yamamoto #1274 add end
    -- ----------------------------------------------------
    -- 当月受払無しデータ
    -- ----------------------------------------------------
      UNION ALL
      SELECT /*+ leading (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) use_nl (xsims gic1 mcb1 gic2 mcb2 gic3 mcb3 iimb ximb xlc) */
             NULL                             h_whse_code
            ,NULL                             h_whse_name
            ,iimb.item_id                     item_id
            ,0                                lot_id
            ,0                                trans_qty
            ,iimb.attribute15                 cost_mng_clss
            ,iimb.lot_ctl                     lot_ctl
            ,xlc.unit_ploce                   actual_unit_price
            ,'1'                              column_no
            ,'1'                              rcv_pay_div
            ,TO_DATE(gv_exec_start_bef, gc_char_dt_format) trans_date
            ,mcb3.segment1                    crowd_code
            ,SUBSTR(mcb3.segment1, 1, 3)      crowd_low
            ,SUBSTR(mcb3.segment1, 1, 2)      crowd_mid
            ,SUBSTR(mcb3.segment1, 1, 1)      crowd_high
            ,iimb.item_no                     item_code
            ,ximb.item_short_name             item_name
      FROM   xxinv_stc_inventory_month_stck   xsims
            ,ic_item_mst_b                    iimb
            ,xxcmn_item_mst_b                 ximb
            ,ic_lots_mst                      ilm
            ,xxcmn_lot_cost                   xlc
            ,gmi_item_categories              gic1
            ,mtl_categories_b                 mcb1
            ,gmi_item_categories              gic2
            ,mtl_categories_b                 mcb2
            ,gmi_item_categories              gic3
            ,mtl_categories_b                 mcb3
-- 2008/12/10 v1.24 ADD START
            ,ic_whse_mst                      iwm
-- 2008/12/10 v1.24 ADD END
      WHERE  xsims.item_id           = iimb.item_id
      AND    ximb.item_id            = iimb.item_id
      AND    ilm.item_id             = xsims.item_id
      AND    ilm.lot_id              = xsims.lot_id
      AND    xlc.item_id(+)          = ilm.item_id
      AND    xlc.lot_id (+)          = ilm.lot_id
      AND    ximb.start_date_active <= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    ximb.end_date_active   >= TO_DATE(gv_exec_start_bef, gc_char_dt_format)
      AND    gic1.item_id            = xsims.item_id
      AND    gic1.category_set_id    = cn_prod_class_id
      AND    gic1.category_id        = mcb1.category_id
      AND    mcb1.segment1           = ir_param.goods_class
      AND    gic2.item_id            = xsims.item_id
      AND    gic2.category_set_id    = cn_item_class_id
      AND    gic2.category_id        = mcb2.category_id
      AND    mcb2.segment1           = ir_param.item_class
      AND    gic3.item_id            = xsims.item_id
      AND    gic3.category_set_id    = ln_crowd_code_id
      AND    gic3.category_id        = mcb3.category_id
      AND    xsims.invent_ym         = gv_exec_year_month_bef
      AND    mcb3.segment1           = lt_crowd_code
-- 2008/12/10 v1.24 UPDATE START
--      AND    xsims.monthly_stock    <> 0
      AND    (
               (xsims.monthly_stock <> 0)
               OR
               (xsims.cargo_stock   <> 0)
             )
      AND    iwm.whse_code           = xsims.whse_code
      AND    iwm.attribute1          = '0'
-- 2008/12/10 v1.24 UPDATE END
      ORDER BY crowd_code       -- 群コード
              ,item_code        -- 品目コード
              ,column_no        -- 項目位置
              ,rcv_pay_div      -- 受払区分
      ;
--
  BEGIN
--
--##################  固定ステータス初期化部 START   ###################
--
    ov_retcode := gv_status_normal;
--
--###########################  固定部 END   ############################
--
    -- ====================================================
    -- データ抽出
    -- ====================================================
-- 2008/10/31 v1.14 ADD START
    -- 帳票種別＝「1：倉庫・品目別」が指定されている場合
    IF (ir_param.print_kind = gc_print_kind_locat) THEN
--
      -- 倉庫コードが指定されていない場合
      IF (ir_param.locat_code IS NULL) THEN
--
        -- 群種別＝「3：郡別」が指定されている場合
        IF (ir_param.crowd_kind = gc_crowd_kind) THEN
--
          ln_crowd_code_id := cn_crowd_code_id;
          lt_crowd_code    := ir_param.crowd_code;
--
          -- 群コードが入力されていない場合
          IF (ir_param.crowd_code IS NULL) THEN
--
            OPEN  get_data_cur01;
            FETCH get_data_cur01 BULK COLLECT INTO ot_data_rec;
            CLOSE get_data_cur01;
--
          -- 群コードが入力されている場合
          ELSE
--
            OPEN  get_data_cur03;
            FETCH get_data_cur03 BULK COLLECT INTO ot_data_rec;
            CLOSE get_data_cur03;
--
          END IF;
--
        -- 群種別＝「4：経理郡別」が指定されている場合
        ELSIF (ir_param.crowd_kind = gc_crowd_acct_kind) THEN
--
          ln_crowd_code_id := cn_acnt_crowd_code_id;
          lt_crowd_code    := ir_param.acct_crowd_code;
--
          -- 経理群コードが入力されていない場合
          IF (ir_param.acct_crowd_code IS NULL) THEN
--
            OPEN  get_data_cur01;
            FETCH get_data_cur01 BULK COLLECT INTO ot_data_rec;
            CLOSE get_data_cur01;
--
          -- 経理群コードが入力されている場合
          ELSE
--
            OPEN  get_data_cur03;
            FETCH get_data_cur03 BULK COLLECT INTO ot_data_rec;
            CLOSE get_data_cur03;
--
          END IF;
--
        END IF;
--
      -- 倉庫コードが指定されている場合
      ELSE
--
        -- 群種別＝「3：郡別」が指定されている場合
        IF (ir_param.crowd_kind = gc_crowd_kind) THEN
--
          ln_crowd_code_id := cn_crowd_code_id;
          lt_crowd_code    := ir_param.crowd_code;
--
          -- 群コードが入力されていない場合
          IF (ir_param.crowd_code IS NULL) THEN
--
            OPEN  get_data_cur02;
            FETCH get_data_cur02 BULK COLLECT INTO ot_data_rec;
            CLOSE get_data_cur02;
--
          -- 群コードが入力されている場合
          ELSE
--
            OPEN  get_data_cur04;
            FETCH get_data_cur04 BULK COLLECT INTO ot_data_rec;
            CLOSE get_data_cur04;
--
          END IF;
--
        -- 群種別＝「4：経理郡別」が指定されている場合
        ELSIF (ir_param.crowd_kind = gc_crowd_acct_kind) THEN
--
          ln_crowd_code_id := cn_acnt_crowd_code_id;
          lt_crowd_code    := ir_param.acct_crowd_code;
--
          -- 経理群コードが入力されていない場合
          IF (ir_param.acct_crowd_code IS NULL) THEN
--
            OPEN  get_data_cur02;
            FETCH get_data_cur02 BULK COLLECT INTO ot_data_rec;
            CLOSE get_data_cur02;
--
          -- 経理群コードが入力されている場合
          ELSE
--
            OPEN  get_data_cur04;
            FETCH get_data_cur04 BULK COLLECT INTO ot_data_rec;
            CLOSE get_data_cur04;
--
          END IF;
--
        END IF;
--
      END IF;
--
    -- 帳票種別＝「2：品目別」が指定されている場合
    ELSIF (ir_param.print_kind = gc_print_kind_item) THEN
--
      -- 群種別＝「3：郡別」が指定されている場合
      IF (ir_param.crowd_kind = gc_crowd_kind) THEN
--
        ln_crowd_code_id := cn_crowd_code_id;
        lt_crowd_code    := ir_param.crowd_code;
--
        -- 群コードが入力されていない場合
        IF (ir_param.crowd_code IS NULL) THEN
--
          OPEN  get_data_cur05;
          FETCH get_data_cur05 BULK COLLECT INTO ot_data_rec;
          CLOSE get_data_cur05;
--
        -- 群コードが入力されている場合
        ELSE
--
          OPEN  get_data_cur06;
          FETCH get_data_cur06 BULK COLLECT INTO ot_data_rec;
          CLOSE get_data_cur06;
--
        END IF;
--
      -- 群種別＝「4：経理郡別」が指定されている場合
      ELSIF (ir_param.crowd_kind = gc_crowd_acct_kind) THEN
--
        ln_crowd_code_id := cn_acnt_crowd_code_id;
        lt_crowd_code    := ir_param.acct_crowd_code;
--
        -- 経理群コードが入力されていない場合
        IF (ir_param.acct_crowd_code IS NULL) THEN
--
          OPEN  get_data_cur05;
          FETCH get_data_cur05 BULK COLLECT INTO ot_data_rec;
          CLOSE get_data_cur05;
--
        -- 経理群コードが入力されている場合
        ELSE
--
          OPEN  get_data_cur06;
          FETCH get_data_cur06 BULK COLLECT INTO ot_data_rec;
          CLOSE get_data_cur06;
--
        END IF;
--
      END IF;
--
    END IF;
-- 2008/10/31 v1.14 ADD END
--
  EXCEPTION
--#################################  固定例外処理部 START   ####################################
--
    -- *** 共通関数例外ハンドラ ***
    WHEN global_api_expt THEN
      IF (lc_ref%ISOPEN) THEN
        CLOSE lc_ref ;
      END IF ;
      ov_errmsg  := lv_errmsg;
      ov_errbuf  := SUBSTRB(gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||lv_errbuf,1,5000);
      ov_retcode := gv_status_error;
    -- *** 共通関数OTHERS例外ハンドラ ***
    WHEN global_api_others_expt THEN
      IF (lc_ref%ISOPEN) THEN
        CLOSE lc_ref ;
      END IF ;
      ov_errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM;
      ov_retcode := gv_status_error;
    -- *** OTHERS例外ハンドラ ***
    WHEN OTHERS THEN
      IF (lc_ref%ISOPEN) THEN
        CLOSE lc_ref ;
      END IF ;
      ov_errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM;
      ov_retcode := gv_status_error;
--
--#####################################  固定部 END   ##########################################
--
  END prc_get_report_data ;
--
  /**********************************************************************************
   * Procedure Name   : prc_create_xml_data
   * Description      : ＸＭＬデータ作成
   ***********************************************************************************/
  PROCEDURE prc_create_xml_data(
      ir_param          IN  rec_param_data    -- 01.レコード  ：パラメータ
     ,ov_errbuf         OUT VARCHAR2          --    エラー・メッセージ           --# 固定 #
     ,ov_retcode        OUT VARCHAR2          --    リターン・コード             --# 固定 #
     ,ov_errmsg         OUT VARCHAR2          --    ユーザー・エラー・メッセージ --# 固定 #
    )
  IS
--
    -- =====================================================
    -- 固定ローカル定数
    -- =====================================================
    cv_prg_name    CONSTANT VARCHAR2(100) := 'prc_create_xml_data' ; -- プログラム名
--
--#####################  固定ローカル変数宣言部 START   ########################
--
    lv_errbuf  VARCHAR2(5000) ;  -- エラー・メッセージ
    lv_retcode VARCHAR2(1) ;     -- リターン・コード
    lv_errmsg  VARCHAR2(5000) ;  -- ユーザー・エラー・メッセージ
--
--###########################  固定部 END   ####################################
--
    -- =====================================================
    -- ユーザー宣言部
    -- =====================================================
    -- *** ローカル定数 ***
    -- キーブレイク判断用
    lc_break_init           VARCHAR2(100) DEFAULT '*' ;            -- 初期値
    lc_break_null           VARCHAR2(100) DEFAULT '**' ;           -- ＮＵＬＬ判定
--
    -- *** ローカル変数 ***
    -- キーブレイク判断用
    lv_locat_code           VARCHAR2(100) DEFAULT lc_break_init ;  -- 倉庫コード
    lv_crowd_code           VARCHAR2(100) DEFAULT lc_break_init ;  -- 群コード
    lv_crowd_low            VARCHAR2(100) DEFAULT lc_break_init ;  -- 群コード（小）
    lv_crowd_mid            VARCHAR2(100) DEFAULT lc_break_init ;  -- 群コード（中）
    lv_crowd_high           VARCHAR2(100) DEFAULT lc_break_init ;  -- 群コード（大）
    lv_item_code            VARCHAR2(100) DEFAULT lc_break_init ;  -- 品目コード
    lv_cost_kbn             VARCHAR2(100) DEFAULT lc_break_init ;  -- 原価管理区分
    lv_column_no            VARCHAR2(100) DEFAULT lc_break_init ;  -- 項目位置
    lv_col_name             VARCHAR2(100) DEFAULT lc_break_init ;  -- 項目タグ
--
    -- 値取得用用
    ln_unit_price           NUMBER        DEFAULT 0;               -- 単価
    ln_inv_qty              NUMBER        DEFAULT 0;               -- 在庫数量
    ln_inv_amt              NUMBER        DEFAULT 0;               -- 在庫金額
    ln_first_inv_qty        NUMBER        DEFAULT 0;               -- 在庫数量（月首）
    ln_first_inv_amt        NUMBER        DEFAULT 0;               -- 在庫金額（月首）
    ln_end_inv_qty          NUMBER        DEFAULT 0;               -- 在庫数量（月末）
    ln_end_inv_amt          NUMBER        DEFAULT 0;               -- 在庫金額（月末）
-- 2008/11/17 v1.16 ADD START
    ln_first_cargo_qty      NUMBER        DEFAULT 0;               -- 積送中在庫数量（月首）
    ln_first_cargo_amt      NUMBER        DEFAULT 0;               -- 積送中在庫金額（月首）
    ln_end_cargo_qty        NUMBER        DEFAULT 0;               -- 積送中在庫数量（月末）
    ln_end_cargo_amt        NUMBER        DEFAULT 0;               -- 積送中在庫金額（月末）
-- 2008/11/17 v1.16 ADD END
--
    -- 計算用
    ln_quantity             NUMBER        DEFAULT 0;               -- 数量
    ln_qty_in               NUMBER        DEFAULT 0;               -- 数量（受入）
    ln_qty_out              NUMBER        DEFAULT 0;               -- 数量（払出）
    ln_amount               NUMBER        DEFAULT 0;               -- 金額
    ln_amt_in               NUMBER        DEFAULT 0;               -- 金額（受入）
    ln_amt_out              NUMBER        DEFAULT 0;               -- 金額（払出）
    ln_position             NUMBER        DEFAULT 0;               -- ポジション
    ln_instr                NUMBER        DEFAULT 0;               -- 項目判定切替位置
-- 2008/12/15 v1.28 N.Yoshida add start
    ln_last_pos             NUMBER        DEFAULT 0;
-- 2008/12/15 v1.28 N.Yoshida add end
--
    -- 項目判定用
    lb_trnsfr               BOOLEAN       DEFAULT FALSE;           -- 振替項目
    lb_payout               BOOLEAN       DEFAULT FALSE;           -- 払出項目
-- 2008/08/22 v1.8 ADD START
    lb_revi                 BOOLEAN       DEFAULT FALSE;           -- 数値補正
-- 2008/08/22 v1.8 ADD END
--
-- 2008/11/25 v1.18 ADD START
    lb_zero                 BOOLEAN       DEFAULT TRUE;            -- 出力判定
-- 2008/11/25 v1.18 ADD END
    -- *** ローカル・例外処理 ***
    no_data_expt            EXCEPTION ;             -- 取得レコードなし
--
    ---------------------
    -- XMLタグ挿入処理
    ---------------------
    PROCEDURE prc_set_xml(
        ic_type              IN        CHAR    --   タグタイプ  T:タグ
                                                             -- D:データ
                                                             -- N:データ(NULLの場合タグを書かない)
                                                             -- Z:データ(NULLの場合0表示)
       ,iv_name              IN        VARCHAR2                --   タグ名
       ,iv_value             IN        VARCHAR2  DEFAULT NULL  --   タグデータ(省略可
       ,in_lengthb           IN        NUMBER    DEFAULT NULL  --   文字長（バイト）(省略可
       ,iv_index             IN        NUMBER    DEFAULT NULL  --   インデックス(省略可
      )
    IS
      -- *** ローカル変数 ***
      ln_xml_idx  NUMBER;
      ln_work     NUMBER;
      lv_work     VARCHAR2(32000);
--
    BEGIN
--
      IF (ic_type = gc_n) THEN
        --NULLの場合タグを書かない対応
        IF (iv_value IS NULL) THEN
          RETURN;
        END IF;
--
        BEGIN
          ln_work := TO_NUMBER(iv_value);
        EXCEPTION
          WHEN INVALID_NUMBER OR VALUE_ERROR THEN
            RETURN;
        END;
      END IF;
--
      -- 項目タグ名が「*_qty」または「*_amt」の場合、出力しない
      IF (iv_name = '*_qty') OR (TRIM(iv_name) = '*_amt') THEN
        RETURN;
      END IF;
--
      --インデックス
      IF (iv_index IS NULL) THEN
        ln_xml_idx := gt_xml_data_table.COUNT + 1 ;
      ELSE
        ln_xml_idx := iv_index;
      END IF;
--
      lv_work := iv_value;
--
      --タグセット
      gt_xml_data_table(ln_xml_idx).tag_name  := iv_name ; --<タグ名>
      IF (ic_type = gc_t) THEN
        gt_xml_data_table(ln_xml_idx).tag_type  := gc_t ;  --<タグのみ>
      ELSE
        gt_xml_data_table(ln_xml_idx).tag_type  := gc_d ;  --<タグ ＆ データ>
        IF (ic_type = gc_z) THEN
          gt_xml_data_table(ln_xml_idx).tag_value := NVL(lv_work, 0) ; --Nullの場合０表示
        ELSE
          gt_xml_data_table(ln_xml_idx).tag_value := lv_work ;         --Nullでもそのまま表示
        END IF;
      END IF;
--
      --文字切り
      IF (in_lengthb IS NOT NULL) THEN
        gt_xml_data_table(ln_xml_idx).tag_value
          := SUBSTRB(gt_xml_data_table(ln_xml_idx).tag_value , gn_one , in_lengthb);
      END IF;
--
    END prc_set_xml ;
--
    ---------------------
    -- 標準単価取得
    ---------------------
    FUNCTION fnc_get_item_unit_price(
        in_pos   IN   NUMBER    --レコード配列位置
      ) RETURN NUMBER
    IS
--
    -- *** ローカル変数 ***
    ln_unit_price NUMBER DEFAULT 0;    --原価戻り値
--
    BEGIN
--
      --原価区分＝標準原価、原価区分＝実際原価andロット管理＝対象外のとき
      IF  (   (gt_main_data(in_pos).cost_kbn = gc_cost_st)
           OR (    (gt_main_data(in_pos).cost_kbn = gc_cost_ac)
               AND (gt_main_data(in_pos).lot_ctl  = gn_lot_ctl_n) ) )
      THEN
        -- 標準原価マスタより標準単価を取得
        BEGIN
          SELECT prc.stnd_unit_price as price
          INTO   ln_unit_price
          FROM   xxcmn_stnd_unit_price_v prc
          WHERE  prc.item_id    = gt_main_data(in_pos).item_id
-- 2008/10/31 v1.14 MOD START
--            AND (prc.start_date_active IS NULL OR
--                 prc.start_date_active  <= TRUNC(gt_main_data(in_pos).trans_date))
--            AND (prc.end_date_active   IS NULL OR
--                 prc.end_date_active    >= TRUNC(gt_main_data(in_pos).trans_date));
-- 2008/10/31 v1.14 MOD END
--2009/05/29 MOD START
--            AND  prc.start_date_active  <= TRUNC(gt_main_data(in_pos).trans_date)
--            AND  prc.end_date_active    >= TRUNC(gt_main_data(in_pos).trans_date);
            AND  prc.start_date_active  <= gd_st_unit_date
            AND  prc.end_date_active    >= gd_st_unit_date;
--2009/05/29 MOD END
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            ln_unit_price :=  0;
        END;
        RETURN  ln_unit_price;
--
      --原価区分＝標準原価以外の場合、Zeroを設定
      ELSE
        RETURN  0;
      END IF;
--
    END fnc_get_item_unit_price;
--
-- 2008/11/17 v1.16 DELETE START
/*
    --------------------------------------
    -- 品目の在庫・金額（実際単価）を取得
    --------------------------------------
    PROCEDURE prc_get_inv_qty_amt(
        ir_param      IN     rec_param_data                     -- 入力パラメータ群
       ,in_pos        IN     NUMBER                             -- レコード配列位置
       ,iv_year_month IN     VARCHAR2                           -- 取引日対象年月
       ,on_inv_qty    OUT    NUMBER                             -- 数量
       ,on_inv_amt    OUT    NUMBER                             -- 金額（実際単価）
    )
    IS
      -- *** ローカル定数 ***
      cn_prod_class_id          CONSTANT NUMBER := TO_NUMBER(FND_PROFILE.VALUE('XXCMN_ITEM_CATEGORY_PROD_CLASS'));
      cn_item_class_id          CONSTANT NUMBER := TO_NUMBER(FND_PROFILE.VALUE('XXCMN_ITEM_CATEGORY_ITEM_CLASS'));
      -- *** ローカル変数 ***
      ln_idx              NUMBER;           -- 対象インデックス
      ld_trn_start        VARCHAR2(20);     -- 取引日対象開始日
      ld_trn_end          VARCHAR2(20);     -- 取引日対象開始日
      ld_alv_start        VARCHAR2(20);     -- 着荷日対象開始日
      ld_alv_end          VARCHAR2(20);     -- 着荷日対象開始日
--
    BEGIN
--
      --取引日が前月（月首）
      ln_idx := in_pos;  -- 初期値
      IF (iv_year_month < ir_param.exec_year_month) THEN
        ld_trn_start := gv_exec_start_bef;
        ld_trn_end   := gv_exec_end_bef;
        ld_alv_start := gv_exec_start;
        ld_alv_end   := gv_exec_end;
      --取引日が当月（月末）
      ELSE
        IF (gt_main_data.COUNT > in_pos) THEN
          ln_idx := in_pos - 1;
        END IF;
        ld_trn_start := gv_exec_start;
        ld_trn_end   := gv_exec_end;
        ld_alv_start := gv_exec_start_aft;
        ld_alv_end   := gv_exec_end_aft;
      END IF;
--
      --原価区分＝標準原価、原価区分＝実際原価andロット管理＝対象外のとき
      IF  (   (gt_main_data(in_pos).cost_kbn = gc_cost_st)
           OR (    (gt_main_data(in_pos).cost_kbn = gc_cost_ac)
               AND (gt_main_data(in_pos).lot_ctl  = gn_lot_ctl_n) ) )
      THEN
        -- 受払VIEW(OMSO)より数量を取得
        -- ※原価区分＝標準原価のため、金額を算出しない
        BEGIN
-- 2008/10/08 v1.12 DELETE START
--          SELECT
--                 NVL(SUM(NVL(trn.trans_qty, 0)),0) as stock   -- 取引数量
--                ,0                                 as price   -- 実際単価
--          INTO   on_inv_qty
--                ,on_inv_amt
--          FROM  ic_tran_pnd               trn      -- 保留在庫トラン
--               ,xxcmn_rcv_pay_mst_omso_v  xrpmxv   --  受払VIW
--          WHERE trn.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start, gc_char_dt_format )
--            AND trn.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,  gc_char_dt_format )
--            AND xrpmxv.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start, gc_char_dt_format )
--            AND xrpmxv.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,  gc_char_dt_format )
--            AND trn.doc_type            = gv_doc_type_omso                  --文書タイプ
--            AND trn.completed_ind       = 1                                 --完了区分
--            AND trn.doc_type            = xrpmxv.doc_type                   --文書タイプ
--            AND trn.line_detail_id      = xrpmxv.doc_line
--            AND trn.item_id             = gt_main_data(ln_idx).item_id
--            AND ( (ir_param.print_kind <> gc_print_kind_locat)
--               OR ( (ir_param.print_kind = gc_print_kind_locat)
--                AND (trn.whse_code = gt_main_data(ln_idx).locat_code)));
-- 2008/10/08 v1.12 DELETE END
-- 2008/10/08 v1.12 ADD START
-- 2008/10/31 v1.14 MOD START
          IF (ir_param.print_kind = gc_print_kind_locat) THEN
            SELECT NVL(SUM(NVL(trn.trans_qty, 0)),0) as stock   -- 取引数量
                  ,0                                 as price   -- 実際単価
            INTO   on_inv_qty
                  ,on_inv_amt
            FROM   ( --OMSO_SUM01
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl(itp wdd xoha ooha otta xola) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xrpm.item_div_ahead     = '5'
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xola.request_item_code  = xola.shipping_item_code
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('102','103')
              AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
                     OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM02
              SELECT /*+ leading (iimb xoha xola wdd itp otta ooha) use_nl (iimb xoha xola wdd itp otta ooha) */
/*
                     CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                         ,gv_d_name_item_trn_rcv
                                                         ,gv_d_name_trn_ship_rcv_gen
                                                         ,gv_d_name_trn_ship_rcv_han)
                               THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                     ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
                     END                              trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '2'
              AND    xoha.req_status         = '08'
              AND    xrpm.dealings_div       IN ('104','105','107','108')
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM02
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '2'
              AND    xoha.req_status         = '08'
              AND    xrpm.dealings_div       = '109'
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM03
              SELECT /*+ leading (iimb xola xoha wdd itp otta ooha) use_nl (iimb xola xoha wdd itp otta ooha) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '1'
              AND    xoha.req_status         = '04'
              AND    xrpm.dealings_div       = '112'
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM04
              SELECT /*+ leading (iimb xola xoha wdd itp otta ooha) use_nl (iimb xola xoha wdd itp otta ooha) */
/*
                     CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                         ,gv_d_name_item_trn_rcv
                                                         ,gv_d_name_trn_ship_rcv_gen
                                                         ,gv_d_name_trn_ship_rcv_han)
                               THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                     ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
                     END                              trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '1'
              AND    xoha.req_status         = '04'
              AND    xrpm.dealings_div       IN ('110','111')
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM07
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '3'
              AND    xrpm.dealings_div       IN ('201','203')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM08
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('504','509')
              AND    xrpm.stock_adjustment_div = otta.attribute4
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
            ) trn;
          ELSE
            SELECT NVL(SUM(NVL(trn.trans_qty, 0)),0) as stock   -- 取引数量
                  ,0                                 as price   -- 実際単価
            INTO   on_inv_qty
                  ,on_inv_amt
            FROM   ( --OMSO_SUM01
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl(itp wdd xoha ooha otta xola) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xrpm.item_div_ahead     = '5'
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xola.request_item_code  = xola.shipping_item_code
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('102','103')
              AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
                     OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
              UNION ALL --OMSO_SUM02
              SELECT /*+ leading (iimb xoha xola wdd itp otta ooha) use_nl (iimb xoha xola wdd itp otta ooha) */
/*
                     CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                         ,gv_d_name_item_trn_rcv
                                                         ,gv_d_name_trn_ship_rcv_gen
                                                         ,gv_d_name_trn_ship_rcv_han)
                               THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                     ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
                     END                              trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '2'
              AND    xoha.req_status         = '08'
              AND    xrpm.dealings_div       IN ('104','105','107','108')
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              UNION ALL --OMSO_SUM02
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '2'
              AND    xoha.req_status         = '08'
              AND    xrpm.dealings_div       = '109'
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              UNION ALL --OMSO_SUM03
              SELECT /*+ leading (iimb xola xoha wdd itp otta ooha) use_nl (iimb xola xoha wdd itp otta ooha) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '1'
              AND    xoha.req_status         = '04'
              AND    xrpm.dealings_div       = '112'
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              UNION ALL --OMSO_SUM04
              SELECT /*+ leading (iimb xola xoha wdd itp otta ooha) use_nl (iimb xola xoha wdd itp otta ooha) */
/*
                     CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                         ,gv_d_name_item_trn_rcv
                                                         ,gv_d_name_trn_ship_rcv_gen
                                                         ,gv_d_name_trn_ship_rcv_han)
                               THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                     ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
                     END                              trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '1'
              AND    xoha.req_status         = '04'
              AND    xrpm.dealings_div       IN ('110','111')
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              UNION ALL --OMSO_SUM07
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('201','203')
              AND    otta.attribute1         = '3'
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              UNION ALL --OMSO_SUM08
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('504','509')
              AND    xrpm.stock_adjustment_div = otta.attribute4
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
            ) trn;
          END IF;
-- 2008/10/31 v1.14 MOD END
-- 2008/10/08 v1.12 ADD END
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            on_inv_qty :=  0;
            on_inv_amt :=  0;
        END;
--
      --原価区分＝標準原価以外の場合
      ELSE
        -- 受払VIEW(OMSO)より数量・金額を取得
        BEGIN
-- 2008/10/08 v1.12 DELETE START
--          SELECT
--                 NVL(SUM(NVL(trn.trans_qty, 0)),0) as stock       -- 取引数量
--                ,NVL(SUM(NVL(trn.trans_qty, 0) * NVL(xleiv.actual_unit_price, 0)),0)
--                                                 as price          -- 実際単価
--          INTO   on_inv_qty
--                ,on_inv_amt
--          FROM ic_tran_pnd               trn      -- 保留在庫トラン
--              ,xxcmn_rcv_pay_mst_omso_v  xrpmxv   --  受払VIW
--              ,xxcmn_lot_each_item_v     xleiv    -- ロット別品目情報
--          WHERE trn.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start, gc_char_dt_format )
--            AND trn.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,  gc_char_dt_format )
--            AND xrpmxv.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start, gc_char_dt_format )
--            AND xrpmxv.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,  gc_char_dt_format )
--            AND trn.doc_type            = gv_doc_type_omso                  --文書タイプ
--            AND trn.completed_ind       = 1                                 --完了区分
--            AND trn.doc_type            = xrpmxv.doc_type                   --文書タイプ
--            AND trn.line_detail_id      = xrpmxv.doc_line
--            AND trn.item_id             = gt_main_data(ln_idx).item_id
--            AND trn.item_id             = xleiv.item_id
--            AND trn.lot_id              = xleiv.lot_id
--            AND ( (ir_param.print_kind <> gc_print_kind_locat)
--               OR ( (ir_param.print_kind = gc_print_kind_locat)
--                AND (trn.whse_code       = gt_main_data(ln_idx).locat_code)));
-- 2008/10/08 v1.12 DELETE END
-- 2008/10/08 v1.12 ADD START
-- 2008/10/31 v1.14 MOD START
          IF (ir_param.print_kind = gc_print_kind_locat) THEN
            SELECT NVL(SUM(NVL(trn.trans_qty, 0)),0) as stock   -- 取引数量
                  ,NVL(SUM(NVL(trn.trans_qty, 0) * NVL(xlc.unit_ploce, 0)),0)
                                                     as price   -- 実際単価
            INTO   on_inv_qty
                  ,on_inv_amt
            FROM   ( --OMSO_SUM01
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl(itp wdd xoha ooha otta xola) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xrpm.item_div_ahead     = '5'
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xola.request_item_code  = xola.shipping_item_code
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('102','103')
              AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
                     OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM02
              SELECT /*+ leading (iimb xoha xola wdd itp otta ooha) use_nl (iimb xoha xola wdd itp otta ooha) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                         ,gv_d_name_item_trn_rcv
                                                         ,gv_d_name_trn_ship_rcv_gen
                                                         ,gv_d_name_trn_ship_rcv_han)
                               THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                     ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
                     END                              trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '2'
              AND    xoha.req_status         = '08'
              AND    xrpm.dealings_div       IN ('104','105','107','108')
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM02
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '2'
              AND    xoha.req_status         = '08'
              AND    xrpm.dealings_div       = '109'
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM03
              SELECT /*+ leading (iimb xola xoha wdd itp otta ooha) use_nl (iimb xola xoha wdd itp otta ooha) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '1'
              AND    xoha.req_status         = '04'
              AND    xrpm.dealings_div       = '112'
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM04
              SELECT /*+ leading (iimb xola xoha wdd itp otta ooha) use_nl (iimb xola xoha wdd itp otta ooha) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                         ,gv_d_name_item_trn_rcv
                                                         ,gv_d_name_trn_ship_rcv_gen
                                                         ,gv_d_name_trn_ship_rcv_han)
                               THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                     ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
                     END                              trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '1'
              AND    xoha.req_status         = '04'
              AND    xrpm.dealings_div       IN ('110','111')
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM07
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '3'
              AND    xrpm.dealings_div       IN ('201','203')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
              UNION ALL --OMSO_SUM08
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('504','509')
              AND    xrpm.stock_adjustment_div = otta.attribute4
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              AND    itp.whse_code           = gt_main_data(ln_idx).locat_code
                   ) trn
                  ,xxcmn_lot_cost xlc
            WHERE  xlc.item_id(+) = trn.item_id
            AND    xlc.lot_id (+) = trn.lot_id;
          ELSE
            SELECT NVL(SUM(NVL(trn.trans_qty, 0)),0) as stock   -- 取引数量
                  ,NVL(SUM(NVL(trn.trans_qty, 0) * NVL(xlc.unit_ploce, 0)),0)
                                                     as price   -- 実際単価
            INTO   on_inv_qty
                  ,on_inv_amt
            FROM   ( --OMSO_SUM01
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl(itp wdd xoha ooha otta xola) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xrpm.item_div_ahead     = '5'
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xola.request_item_code  = xola.shipping_item_code
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('102','103')
              AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    ((xrpm.ship_prov_rcv_pay_category IS NULL)
                     OR (xrpm.ship_prov_rcv_pay_category = otta.attribute11))
              UNION ALL --OMSO_SUM02
              SELECT /*+ leading (iimb xoha xola wdd itp otta ooha) use_nl (iimb xoha xola wdd itp otta ooha) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                         ,gv_d_name_item_trn_rcv
                                                         ,gv_d_name_trn_ship_rcv_gen
                                                         ,gv_d_name_trn_ship_rcv_han)
                               THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                     ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
                     END                              trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '2'
              AND    xoha.req_status         = '08'
              AND    xrpm.dealings_div       IN ('104','105','107','108')
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              UNION ALL --OMSO_SUM02
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '2'
              AND    xoha.req_status         = '08'
              AND    xrpm.dealings_div       = '109'
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              UNION ALL --OMSO_SUM03
              SELECT /*+ leading (iimb xola xoha wdd itp otta ooha) use_nl (iimb xola xoha wdd itp otta ooha) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '1'
              AND    xoha.req_status         = '04'
              AND    xrpm.dealings_div       = '112'
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              UNION ALL --OMSO_SUM04
              SELECT /*+ leading (iimb xola xoha wdd itp otta ooha) use_nl (iimb xola xoha wdd itp otta ooha) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,CASE WHEN xrpm.dealings_div_name IN (gv_d_name_trn_rcv
                                                         ,gv_d_name_item_trn_rcv
                                                         ,gv_d_name_trn_ship_rcv_gen
                                                         ,gv_d_name_trn_ship_rcv_han)
                               THEN itp.trans_qty * TO_NUMBER(gc_rcv_pay_div_adj)
                     ELSE itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)
                     END                              trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
                    ,ic_item_mst_b                    iimb
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
      -- 2008/11/4 modify yoshida 暫定ロジック start
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    iimb.item_no            = xola.request_item_code
              AND    iimb.item_id            = gt_main_data(ln_idx).item_id
              --AND    itp.item_id             = gt_main_data(ln_idx).item_id
      -- 2008/11/4 modify yoshida 暫定ロジック end
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    otta.attribute1         = '1'
              AND    xoha.req_status         = '04'
              AND    xrpm.dealings_div       IN ('110','111')
              --AND    xrpm.shipment_provision_div = DECODE(xoha.req_status,'04','1','08','2')
              AND    xrpm.shipment_provision_div = otta.attribute1
              UNION ALL --OMSO_SUM07
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    ((otta.attribute4           <> '2')
                     OR  (otta.attribute4       IS NULL))
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('201','203')
              AND    otta.attribute1         = '3'
              AND    xrpm.shipment_provision_div = otta.attribute1
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
              UNION ALL --OMSO_SUM08
              SELECT /*+ leading (itp wdd xoha ooha otta xola) use_nl (itp wdd xoha ooha otta xola) */
/*
                     itp.item_id                      item_id
                    ,itp.lot_id                       lot_id
                    ,itp.trans_qty * TO_NUMBER(xrpm.rcv_pay_div)  trans_qty
              FROM   ic_tran_pnd                      itp
                    ,wsh_delivery_details             wdd
                    ,oe_order_headers_all             ooha
                    ,oe_transaction_types_all         otta
                    ,xxwsh_order_headers_all          xoha
                    ,xxwsh_order_lines_all            xola
                    ,xxcmn_rcv_pay_mst                xrpm
              WHERE  itp.doc_type            = gv_doc_type_omso
              AND    itp.completed_ind       = 1
              AND    itp.trans_date >= FND_DATE.STRING_TO_DATE(ld_trn_start,gc_char_dt_format)
              AND    itp.trans_date <= FND_DATE.STRING_TO_DATE(ld_trn_end,gc_char_dt_format)
              AND    itp.item_id             = gt_main_data(ln_idx).item_id
              AND    wdd.delivery_detail_id  = itp.line_detail_id
              AND    ooha.org_id             = wdd.org_id
              AND    ooha.header_id          = wdd.source_header_id
              AND    otta.transaction_type_id = ooha.order_type_id
              AND    xoha.header_id          = wdd.source_header_id
              AND    xoha.arrival_date >= FND_DATE.STRING_TO_DATE(ld_alv_start,gc_char_dt_format)
              AND    xoha.arrival_date <= FND_DATE.STRING_TO_DATE(ld_alv_end,gc_char_dt_format)
              AND    xola.order_header_id    = xoha.order_header_id
              AND    xola.line_id            = wdd.source_line_id
              AND    xrpm.doc_type           = itp.doc_type
              AND    xrpm.dealings_div       IN ('504','509')
              AND    xrpm.stock_adjustment_div = otta.attribute4
              AND    xrpm.ship_prov_rcv_pay_category = otta.attribute11
                   ) trn
                  ,xxcmn_lot_cost xlc
            WHERE  xlc.item_id(+) = trn.item_id
            AND    xlc.lot_id (+) = trn.lot_id;
          END IF;
-- 2008/10/31 v1.14 MOD END
-- 2008/10/08 v1.12 ADD END
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            on_inv_qty :=  0;
            on_inv_amt :=  0;
        END;
      END IF;
--
    END prc_get_inv_qty_amt;
--
*/
-- 2008/11/17 DELETE END
    ------------------------------------------------
    -- 品目の月首・月末在庫・金額（実際単価）を取得
    ------------------------------------------------
    PROCEDURE prc_get_fst_end_inv_qty_amt(
        ir_param      IN   rec_param_data    -- 入力パラメータ群
       ,in_pos        IN   NUMBER            -- レコード配列位置
       ,iv_year_month IN   VARCHAR2          -- 対象年月
       ,on_inv_qty    OUT  NUMBER            -- 数量
       ,on_cargo_qty  OUT  NUMBER            -- 積送中数量
       ,on_inv_amt    OUT  NUMBER            -- 金額（実際単価）
       ,on_cargo_amt  OUT  NUMBER            -- 積送中金額（実際単価）
      )
    IS
      -- *** ローカル変数 ***
      ln_idx  NUMBER;
      ln_cost_kbn NUMBER; -- 0実際原価、1標準原価
--
    BEGIN
--
      -- 対象インデックスを取得
      ln_idx := in_pos;  -- 初期値
-- 2008/12/15 v1.28 N.Yoshida mod start
      /*IF (iv_year_month = ir_param.exec_year_month) AND (gt_main_data.COUNT > in_pos) THEN
        -- 月末
        ln_idx := in_pos - 1;
      END IF;
--
      -- 原価管理区分
      IF((gt_main_data(in_pos).cost_kbn = gc_cost_ac) AND (gt_main_data(in_pos).lot_ctl  = gn_lot_ctl_y))THEN
        ln_cost_kbn := 0;
      ELSE
        ln_cost_kbn := 1;
      END IF;*/
--
      IF (iv_year_month = ir_param.exec_year_month) AND (gt_main_data.COUNT + 1 > in_pos) THEN
        -- 月末
        ln_idx := in_pos - 1;
      ELSIF (gt_main_data.COUNT + 1 = in_pos) THEN
        ln_idx := in_pos - 1;
      END IF;
--
      -- 原価管理区分
      IF((gt_main_data(ln_idx).cost_kbn = gc_cost_ac) AND (gt_main_data(ln_idx).lot_ctl  = gn_lot_ctl_y))THEN
        ln_cost_kbn := 0;
      ELSE
        ln_cost_kbn := 1;
      END IF;
-- 2008/12/15 v1.28 N.Yoshida mod end
--
      IF( (ln_cost_kbn=1) AND(iv_year_month = gv_exec_year_month_bef) AND (ir_param.print_kind = gc_print_kind_locat)) THEN
         -- 月初残高を取得 倉庫別 標準原価
-- 2008/12/18 v1.30 UPDATE START
        BEGIN
           SELECT NVL(SUM(NVL(stc.monthly_stock, 0)),0) as stock
-- 2008/12/25 v1.32 UPDATE START
--                 ,NVL(SUM(NVL(stc.cargo_stock  , 0)),0) as cargo_stock
                 ,NVL(SUM(NVL(stc.cargo_stock  , 0) - NVL(stc.cargo_stock_not_stn, 0)),0) as cargo_stock
-- 2008/12/25 v1.32 UPDATE END
  -- 2008/12/10 v1.24 UPDATE START
  --               ,0 as price
  --               ,0 as cargo_price
                 ,NVL(SUM(ROUND(NVL(stc.monthly_stock, 0) * NVL(ln_unit_price, 0))),0) as price
-- 2008/12/25 v1.32 UPDATE START
--                 ,NVL(SUM(ROUND(NVL(stc.cargo_stock, 0) * NVL(ln_unit_price, 0))),0)   as cargo_price
                 ,NVL(SUM(ROUND((NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)) * NVL(ln_unit_price, 0))),0)   as cargo_price
-- 2008/12/25 v1.32 UPDATE END
  -- 2008/12/10 v1.24 UPDATE END
           INTO   on_inv_qty
                 ,on_cargo_qty
                 ,on_inv_amt
                 ,on_cargo_amt
           FROM   xxinv_stc_inventory_month_stck stc
  -- 2008/12/10 v1.24 ADD START
                 ,ic_whse_mst                    iwm
  -- 2008/12/10 v1.24 ADD END
           WHERE  stc.item_id   = gt_main_data(ln_idx).item_id
           AND    stc.invent_ym = iv_year_month
           AND    stc.whse_code = gt_main_data(ln_idx).locat_code
  -- 2008/12/10 v1.24 ADD START
           AND    iwm.whse_code  = stc.whse_code
           AND    iwm.attribute1 = '0'
  -- 2008/12/10 v1.24 ADD END
           ;
        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             on_inv_qty   := 0;
             on_cargo_qty := 0;
             on_inv_amt   := 0;
             on_cargo_amt := 0;
        END;
-- 2008/12/18 v1.30 UPDATE END
      ELSIF((ln_cost_kbn=1) AND(iv_year_month = gv_exec_year_month_bef) AND (ir_param.print_kind <> gc_print_kind_locat)) THEN
           -- 月初残高を取得 品目別 標準原価
-- 2008/12/18 v1.30 UPDATE START
        BEGIN
           SELECT NVL(SUM(NVL(stc.monthly_stock, 0)),0) as stock
-- 2008/12/25 v1.32 UPDATE START
--                 ,NVL(SUM(NVL(stc.cargo_stock  , 0)),0) as cargo_stock
                 ,NVL(SUM(NVL(stc.cargo_stock  , 0) - NVL(stc.cargo_stock_not_stn, 0)),0) as cargo_stock
-- 2008/12/25 v1.32 UPDATE END
  -- 2008/12/10 v1.24 UPDATE START
  --               ,0 as price
  --               ,0 as cargo_price
                 ,NVL(SUM(ROUND(NVL(stc.monthly_stock, 0) * NVL(ln_unit_price, 0))),0) as price
-- 2008/12/25 v1.32 UPDATE START
--                 ,NVL(SUM(ROUND(NVL(stc.cargo_stock, 0) * NVL(ln_unit_price, 0))),0)   as cargo_price
                 ,NVL(SUM(ROUND((NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)) * NVL(ln_unit_price, 0))),0)   as cargo_price
-- 2008/12/25 v1.32 UPDATE END
  -- 2008/12/10 v1.24 UPDATE END
           INTO   on_inv_qty
                 ,on_cargo_qty
                 ,on_inv_amt
                 ,on_cargo_amt
           FROM   xxinv_stc_inventory_month_stck stc
  -- 2008/12/10 v1.24 ADD START
                 ,ic_whse_mst                    iwm
  -- 2008/12/10 v1.24 ADD END
           WHERE  stc.item_id   = gt_main_data(ln_idx).item_id
           AND    stc.invent_ym = iv_year_month
  -- 2008/12/10 v1.24 ADD START
           AND    iwm.whse_code  = stc.whse_code
           AND    iwm.attribute1 = '0'
  -- 2008/12/10 v1.24 ADD END
           ;
        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             on_inv_qty   := 0;
             on_cargo_qty := 0;
             on_inv_amt   := 0;
             on_cargo_amt := 0;
        END;
-- 2008/12/18 v1.30 UPDATE END
      ELSIF((ln_cost_kbn=0) AND(iv_year_month = gv_exec_year_month_bef) AND (ir_param.print_kind = gc_print_kind_locat)) THEN
         -- 月初残高を取得 倉庫別 実際原価
-- 2008/12/18 v1.30 UPDATE START
        BEGIN
          SELECT NVL(SUM(NVL(stc.monthly_stock, 0)),0) as stock
-- 2008/12/25 v1.32 UPDATE START
--                ,NVL(SUM(NVL(stc.cargo_stock, 0)),0)   as cargo_stock
                ,NVL(SUM(NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)),0)   as cargo_stock
-- 2008/12/25 v1.32 UPDATE END
                ,NVL(SUM(ROUND(NVL(stc.monthly_stock, 0) * NVL(xlc.unit_ploce, 0))),0) as price
-- 2008/12/25 v1.32 UPDATE START
--                ,NVL(SUM(ROUND(NVL(stc.cargo_stock, 0) * NVL(xlc.unit_ploce, 0))),0)   as cargo_price
                ,NVL(SUM(ROUND((NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)) * NVL(xlc.unit_ploce, 0))),0)   as cargo_price
-- 2008/12/25 v1.32 UPDATE END
          INTO   on_inv_qty
                ,on_cargo_qty
                ,on_inv_amt
                ,on_cargo_amt
          FROM   xxinv_stc_inventory_month_stck stc
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                    iwm
-- 2008/12/10 v1.24 ADD END
                ,xxcmn_lot_cost xlc
          WHERE  stc.item_id   = gt_main_data(ln_idx).item_id
          AND    stc.invent_ym = iv_year_month
          AND    stc.whse_code = gt_main_data(ln_idx).locat_code
          AND    stc.item_id   = xlc.item_id(+)
          AND    stc.lot_id    = xlc.lot_id (+)
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code  = stc.whse_code
          AND    iwm.attribute1 = '0'
-- 2008/12/10 v1.24 ADD END
          ;
        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             on_inv_qty   := 0;
             on_cargo_qty := 0;
             on_inv_amt   := 0;
             on_cargo_amt := 0;
        END;
-- 2008/12/18 v1.30 UPDATE END
      ELSIF((ln_cost_kbn=0) AND(iv_year_month = gv_exec_year_month_bef) AND (ir_param.print_kind <> gc_print_kind_locat)) THEN
         -- 月初残高を取得 品目別 実際原価
-- 2008/12/18 v1.30 UPDATE START
        BEGIN
          SELECT NVL(SUM(NVL(stc.monthly_stock, 0)),0) as stock
-- 2008/12/25 v1.32 UPDATE START
--                ,NVL(SUM(NVL(stc.cargo_stock, 0)),0)   as cargo_stock
                ,NVL(SUM(NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)),0)   as cargo_stock
-- 2008/12/25 v1.32 UPDATE END
                ,NVL(SUM(ROUND(NVL(stc.monthly_stock, 0) * NVL(xlc.unit_ploce, 0))),0) as price
-- 2008/12/25 v1.32 UPDATE START
--                ,NVL(SUM(ROUND(NVL(stc.cargo_stock, 0) * NVL(xlc.unit_ploce, 0))),0)   as cargo_price
                ,NVL(SUM(ROUND((NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)) * NVL(xlc.unit_ploce, 0))),0)   as cargo_price
-- 2008/12/25 v1.32 UPDATE END
          INTO   on_inv_qty
                ,on_cargo_qty
                ,on_inv_amt
                ,on_cargo_amt
          FROM   xxinv_stc_inventory_month_stck stc
                ,xxcmn_lot_cost xlc
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                    iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stc.item_id   = gt_main_data(ln_idx).item_id
          AND    stc.invent_ym = iv_year_month
          AND    stc.item_id   = xlc.item_id(+)
          AND    stc.lot_id    = xlc.lot_id (+)
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code  = stc.whse_code
          AND    iwm.attribute1 = '0'
-- 2008/12/10 v1.24 ADD END
          ;
        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             on_inv_qty   := 0;
             on_cargo_qty := 0;
             on_inv_amt   := 0;
             on_cargo_amt := 0;
        END;
-- 2008/12/18 v1.30 UPDATE END
      ELSIF((ln_cost_kbn=1) AND(iv_year_month <> gv_exec_year_month_bef) AND (ir_param.print_kind = gc_print_kind_locat)) THEN
                -- 実棚卸金額 倉庫別 標準原価
-- 2008/12/18 v1.30 UPDATE START
          /*SELECT NVL(SUM(NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0)),0) AS stock
-- 2008/12/10 v1.24 UPDATE START
--                ,0 as price
                ,NVL(SUM(ROUND((NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0)) * NVL(ln_unit_price, 0))),0) AS stock_amt
-- 2008/12/10 v1.24 UPDATE END
          INTO   on_inv_qty
                ,on_inv_amt
          FROM   xxinv_stc_inventory_result     stcr
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                    iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stcr.item_id                       = gt_main_data(ln_idx).item_id
          AND    TO_CHAR(stcr.invent_date,'YYYYMM')  = iv_year_month
          AND    stcr.invent_whse_code              = gt_main_data(ln_idx).locat_code
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code  = stcr.invent_whse_code
          AND    iwm.attribute1 = '0'
-- 2008/12/10 v1.24 ADD END
          ;
              -- 積送金額 倉庫別 標準原価
          SELECT NVL(SUM(NVL(stc.cargo_stock, 0)),0)   AS cargo_stock
-- 2008/12/10 v1.24 UPDATE START
--                ,0 as cargo_price
                ,NVL(SUM(ROUND(NVL(stc.cargo_stock, 0) * NVL(ln_unit_price, 0))),0) AS cargo_price
-- 2008/12/10 v1.24 UPDATE START
          INTO   on_cargo_qty
                ,on_cargo_amt
          FROM   xxinv_stc_inventory_month_stck stc
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                    iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stc.item_id   = gt_main_data(ln_idx).item_id
          AND    stc.invent_ym = iv_year_month
          AND    stc.whse_code = gt_main_data(ln_idx).locat_code
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code  = stc.whse_code
          AND    iwm.attribute1 = '0'
-- 2008/12/10 v1.24 ADD END
          ;*/
--
        BEGIN
          -- 実棚数量、金額算出
          SELECT NVL(SUM(stcr_in.trans_qty),0) AS stock
                ,NVL(SUM(ROUND(stcr_in.trans_qty * NVL(ln_unit_price, 0))),0) AS stock_amt
          INTO   on_inv_qty
                ,on_inv_amt
          FROM  (SELECT  stcr.invent_whse_code
                        ,stcr.item_id
                        ,stcr.lot_id
                        ,SUM(ROUND(NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0), 3)) AS trans_qty
                 FROM    xxinv_stc_inventory_result  stcr
                        ,ic_whse_mst                 iwm
                 WHERE   stcr.invent_whse_code  = gt_main_data(ln_idx).locat_code
                 AND     stcr.item_id           = gt_main_data(ln_idx).item_id
                 AND     TO_CHAR(stcr.invent_date,'YYYYMM')  = iv_year_month
                 AND     iwm.whse_code          = stcr.invent_whse_code
                 AND     iwm.attribute1         = '0'
                 GROUP BY stcr.invent_whse_code, stcr.item_id, stcr.lot_id
                ) stcr_in
          ;

          -- 積送中数量、金額算出
          SELECT NVL(SUM(stc_in.cargo_stock),0)   AS cargo_stock
                ,NVL(SUM(ROUND(stc_in.cargo_stock * NVL(ln_unit_price, 0))),0) AS cargo_price
          INTO   on_cargo_qty
                ,on_cargo_amt
          FROM  (SELECT  stc.whse_code
                        ,stc.item_id
                        ,stc.lot_id
-- 2008/12/25 v1.32 UPDATE START
--                        ,SUM(NVL(stc.cargo_stock, 0)) AS cargo_stock
                        ,SUM(NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)) AS cargo_stock
-- 2008/12/25 v1.32 UPDATE START
                 FROM    xxinv_stc_inventory_month_stck   stc
                        ,ic_whse_mst                      iwm
                 WHERE   stc.whse_code    = gt_main_data(ln_idx).locat_code
                 AND     stc.item_id      = gt_main_data(ln_idx).item_id
                 AND     stc.invent_ym    = iv_year_month
                 AND     iwm.whse_code    = stc.whse_code
                 AND     iwm.attribute1   = '0'
                 GROUP BY stc.whse_code, stc.item_id, stc.lot_id
                ) stc_in
          ;
        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             on_inv_qty   := 0;
             on_cargo_qty := 0;
             on_inv_amt   := 0;
             on_cargo_amt := 0;
        END;
-- 2008/12/18 v1.30 UPDATE END
      ELSIF((ln_cost_kbn=1) AND(iv_year_month <> gv_exec_year_month_bef) AND (ir_param.print_kind <> gc_print_kind_locat)) THEN
                -- 実棚卸金額 品目別 標準原価
-- 2008/12/18 v1.30 UPDATE START
          /*SELECT NVL(SUM(NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0)),0) AS stock
-- 2008/12/10 v1.24 UPDATE START
--                ,0 as price
                ,NVL(SUM(ROUND((NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0)) * NVL(ln_unit_price, 0))),0) AS stock_amt
-- 2008/12/10 v1.24 UPDATE END
          INTO   on_inv_qty
                ,on_inv_amt
          FROM   xxinv_stc_inventory_result     stcr
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                    iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stcr.item_id                       = gt_main_data(ln_idx).item_id
          AND    TO_CHAR(stcr.invent_date,'YYYYMM')  = iv_year_month
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code  = stcr.invent_whse_code
          AND    iwm.attribute1 = '0'
-- 2008/12/10 v1.24 ADD END
          ;
              -- 積送金額 品目別 標準原価
          SELECT NVL(SUM(NVL(stc.cargo_stock, 0)),0)   AS cargo_stock
-- 2008/12/10 v1.24 UPDATE START
--                ,0 as cargo_price
                ,NVL(SUM(ROUND(NVL(stc.cargo_stock, 0) * NVL(ln_unit_price, 0))),0) AS cargo_price
-- 2008/12/10 v1.24 UPDATE END
          INTO   on_cargo_qty
                ,on_cargo_amt
          FROM   xxinv_stc_inventory_month_stck stc
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                    iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stc.item_id      = gt_main_data(ln_idx).item_id
          AND    stc.invent_ym    = iv_year_month
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code    = stc.whse_code
          AND    iwm.attribute1   = '0'
-- 2008/12/10 v1.24 ADD END
          ;*/
--
        BEGIN
          -- 実棚数量、金額算出
          SELECT NVL(SUM(stcr_in.trans_qty),0) AS stock
                ,NVL(SUM(ROUND(stcr_in.trans_qty * NVL(ln_unit_price, 0))),0) AS stock_amt
          INTO   on_inv_qty
                ,on_inv_amt
          FROM  (SELECT  stcr.invent_whse_code
                        ,stcr.item_id
                        ,stcr.lot_id
                        ,SUM(ROUND(NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0), 3)) AS trans_qty
                 FROM    xxinv_stc_inventory_result  stcr
                        ,ic_whse_mst                 iwm
                 WHERE   stcr.item_id           = gt_main_data(ln_idx).item_id
                 AND     TO_CHAR(stcr.invent_date,'YYYYMM')  = iv_year_month
                 AND     iwm.whse_code          = stcr.invent_whse_code
                 AND     iwm.attribute1         = '0'
                 GROUP BY stcr.invent_whse_code, stcr.item_id, stcr.lot_id
                ) stcr_in
          ;

          -- 積送中数量、金額算出
          SELECT NVL(SUM(stc_in.cargo_stock),0)   AS cargo_stock
                ,NVL(SUM(ROUND(stc_in.cargo_stock * NVL(ln_unit_price, 0))),0) AS cargo_price
          INTO   on_cargo_qty
                ,on_cargo_amt
          FROM  (SELECT  stc.whse_code
                        ,stc.item_id
                        ,stc.lot_id
-- 2008/12/25 v1.32 UPDATE START
--                        ,SUM(NVL(stc.cargo_stock, 0)) AS cargo_stock
                        ,SUM(NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)) AS cargo_stock
-- 2008/12/25 v1.32 UPDATE END
                 FROM    xxinv_stc_inventory_month_stck   stc
                        ,ic_whse_mst                      iwm
                 WHERE   stc.item_id      = gt_main_data(ln_idx).item_id
                 AND     stc.invent_ym    = iv_year_month
                 AND     iwm.whse_code    = stc.whse_code
                 AND     iwm.attribute1   = '0'
                 GROUP BY stc.whse_code, stc.item_id, stc.lot_id
                ) stc_in
          ;
        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             on_inv_qty   := 0;
             on_cargo_qty := 0;
             on_inv_amt   := 0;
             on_cargo_amt := 0;
        END;
-- 2008/12/18 v1.30 UPDATE END
      ELSIF((ln_cost_kbn=0) AND(iv_year_month <> gv_exec_year_month_bef) AND (ir_param.print_kind = gc_print_kind_locat)) THEN
                -- 実棚卸金額 倉庫別 実際原価
-- 2008/12/18 v1.30 UPDATE START
          /*SELECT  NVL(SUM(NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0)),0) AS stock
                 ,NVL(SUM(ROUND((NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0)) * NVL(xlc.unit_ploce, 0))),0) AS stock_amt
          INTO   on_inv_qty
                ,on_inv_amt
          FROM   xxinv_stc_inventory_result       stcr
                ,xxcmn_lot_cost                   xlc
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                      iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stcr.item_id                       = gt_main_data(ln_idx).item_id
          AND    TO_CHAR(stcr.invent_date,'YYYYMM')  = iv_year_month
          AND    stcr.item_id          = xlc.item_id(+)
          AND    stcr.lot_id           = xlc.lot_id (+)
          AND    stcr.invent_whse_code = gt_main_data(ln_idx).locat_code
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code  = stcr.invent_whse_code
          AND    iwm.attribute1 = '0'
-- 2008/12/10 v1.24 ADD END
          ;
          SELECT  NVL(SUM(NVL(stc.cargo_stock, 0)),0)   AS cargo_stock
                 ,NVL(SUM(ROUND(NVL(stc.cargo_stock, 0) * NVL(xlc.unit_ploce, 0))),0) AS cargo_price
          INTO   on_cargo_qty
                ,on_cargo_amt
          FROM   xxinv_stc_inventory_month_stck   stc
                ,xxcmn_lot_cost                   xlc
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                      iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stc.item_id      = gt_main_data(ln_idx).item_id
          AND    stc.invent_ym    = iv_year_month
          AND    stc.item_id      = xlc.item_id(+)
          AND    stc.lot_id       = xlc.lot_id (+)
          AND    stc.whse_code    = gt_main_data(ln_idx).locat_code
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code    = stc.whse_code
          AND    iwm.attribute1   = '0'
-- 2008/12/10 v1.24 ADD END
          ;*/
--
        BEGIN
          -- 実棚数量、金額算出
          SELECT NVL(SUM(stcr_in.trans_qty),0) AS stock
                ,NVL(SUM(ROUND(stcr_in.trans_qty * NVL(xlc.unit_ploce, 0))),0) AS stock_amt
          INTO   on_inv_qty
                ,on_inv_amt
          FROM  (SELECT  stcr.invent_whse_code
                        ,stcr.item_id
                        ,stcr.lot_id
                        ,SUM(ROUND(NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0), 3)) AS trans_qty
                 FROM    xxinv_stc_inventory_result  stcr
                        ,ic_whse_mst                 iwm
                 WHERE   stcr.invent_whse_code  = gt_main_data(ln_idx).locat_code
                 AND     stcr.item_id           = gt_main_data(ln_idx).item_id
                 AND     TO_CHAR(stcr.invent_date,'YYYYMM')  = iv_year_month
                 AND     iwm.whse_code          = stcr.invent_whse_code
                 AND     iwm.attribute1         = '0'
                 GROUP BY stcr.invent_whse_code, stcr.item_id, stcr.lot_id
                ) stcr_in
                ,xxcmn_lot_cost                   xlc
          WHERE  stcr_in.item_id      = xlc.item_id(+)
          AND    stcr_in.lot_id       = xlc.lot_id(+)
          ;

          -- 積送中数量、金額算出
          SELECT NVL(SUM(stc_in.cargo_stock),0)   AS cargo_stock
                ,NVL(SUM(ROUND(stc_in.cargo_stock * NVL(xlc.unit_ploce, 0))),0) AS cargo_price
          INTO   on_cargo_qty
                ,on_cargo_amt
          FROM  (SELECT  stc.whse_code
                        ,stc.item_id
                        ,stc.lot_id
-- 2008/12/25 v1.32 UPDATE START
--                        ,SUM(NVL(stc.cargo_stock, 0)) AS cargo_stock
                        ,SUM(NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)) AS cargo_stock
-- 2008/12/25 v1.32 UPDATE END
                 FROM    xxinv_stc_inventory_month_stck   stc
                        ,ic_whse_mst                      iwm
                 WHERE   stc.whse_code    = gt_main_data(ln_idx).locat_code
                 AND     stc.item_id      = gt_main_data(ln_idx).item_id
                 AND     stc.invent_ym    = iv_year_month
                 AND     iwm.whse_code    = stc.whse_code
                 AND     iwm.attribute1   = '0'
                 GROUP BY stc.whse_code, stc.item_id, stc.lot_id
                ) stc_in
                ,xxcmn_lot_cost                   xlc
          WHERE  stc_in.item_id      = xlc.item_id(+)
          AND    stc_in.lot_id       = xlc.lot_id(+)
          ;
        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             on_inv_qty   := 0;
             on_cargo_qty := 0;
             on_inv_amt   := 0;
             on_cargo_amt := 0;
        END;
-- 2008/12/18 v1.30 UPDATE END
      ELSE
                -- 実棚卸金額 品目別 実際原価
-- 2008/12/18 v1.30 UPDATE START
          /*SELECT  NVL(SUM(NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0)),0) AS stock
                 ,NVL(SUM(ROUND((NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0)) * NVL(xlc.unit_ploce, 0))),0) AS stock_amt
          INTO   on_inv_qty
                ,on_inv_amt
          FROM   xxinv_stc_inventory_result       stcr
                ,xxcmn_lot_cost                   xlc
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                      iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stcr.item_id                       = gt_main_data(ln_idx).item_id
          AND    TO_CHAR(stcr.invent_date,'YYYYMM')  = iv_year_month
          AND    stcr.item_id          = xlc.item_id(+)
          AND    stcr.lot_id           = xlc.lot_id (+)
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code  = stcr.invent_whse_code
          AND    iwm.attribute1 = '0'
-- 2008/12/10 v1.24 ADD END
          ;
          SELECT  NVL(SUM(NVL(stc.cargo_stock, 0)),0)   AS cargo_stock
                 ,NVL(SUM(ROUND(NVL(stc.cargo_stock, 0) * NVL(xlc.unit_ploce, 0))),0) AS cargo_price
          INTO   on_cargo_qty
                ,on_cargo_amt
          FROM   xxinv_stc_inventory_month_stck   stc
                ,xxcmn_lot_cost                   xlc
-- 2008/12/10 v1.24 ADD START
                ,ic_whse_mst                      iwm
-- 2008/12/10 v1.24 ADD END
          WHERE  stc.item_id      = gt_main_data(ln_idx).item_id
          AND    stc.invent_ym    = iv_year_month
          AND    stc.item_id      = xlc.item_id(+)
          AND    stc.lot_id       = xlc.lot_id (+)
-- 2008/12/10 v1.24 ADD START
          AND    iwm.whse_code    = stc.whse_code
          AND    iwm.attribute1   = '0'
-- 2008/12/10 v1.24 ADD END
          ;*/
--
        BEGIN
          -- 実棚数量、金額算出
          SELECT NVL(SUM(stcr_in.trans_qty),0) AS stock
                ,NVL(SUM(ROUND(stcr_in.trans_qty * NVL(xlc.unit_ploce, 0))),0) AS stock_amt
          INTO   on_inv_qty
                ,on_inv_amt
          FROM  (SELECT  stcr.invent_whse_code
                        ,stcr.item_id
                        ,stcr.lot_id
                        ,SUM(ROUND(NVL(stcr.case_amt,0) * NVL(stcr.content,0) + NVL(stcr.loose_amt,0), 3)) AS trans_qty
                 FROM    xxinv_stc_inventory_result  stcr
                        ,ic_whse_mst                 iwm
                 WHERE   stcr.item_id           = gt_main_data(ln_idx).item_id
                 AND     TO_CHAR(stcr.invent_date,'YYYYMM')  = iv_year_month
                 AND     iwm.whse_code          = stcr.invent_whse_code
                 AND     iwm.attribute1         = '0'
                 GROUP BY stcr.invent_whse_code, stcr.item_id, stcr.lot_id
                ) stcr_in
                ,xxcmn_lot_cost                   xlc
          WHERE  stcr_in.item_id      = xlc.item_id(+)
          AND    stcr_in.lot_id       = xlc.lot_id(+)
          ;

          -- 積送中数量、金額算出
          SELECT NVL(SUM(stc_in.cargo_stock),0)   AS cargo_stock
                ,NVL(SUM(ROUND(stc_in.cargo_stock * NVL(xlc.unit_ploce, 0))),0) AS cargo_price
          INTO   on_cargo_qty
                ,on_cargo_amt
          FROM  (SELECT  stc.whse_code
                        ,stc.item_id
                        ,stc.lot_id
-- 2008/12/25 v1.32 UPDATE START
--                        ,SUM(NVL(stc.cargo_stock, 0)) AS cargo_stock
                        ,SUM(NVL(stc.cargo_stock, 0) - NVL(stc.cargo_stock_not_stn, 0)) AS cargo_stock
-- 2008/12/25 v1.32 UPDATE END
                 FROM    xxinv_stc_inventory_month_stck   stc
                        ,ic_whse_mst                      iwm
                 WHERE   stc.item_id      = gt_main_data(ln_idx).item_id
                 AND     stc.invent_ym    = iv_year_month
                 AND     iwm.whse_code    = stc.whse_code
                 AND     iwm.attribute1   = '0'
                 GROUP BY stc.whse_code, stc.item_id, stc.lot_id
                ) stc_in
                ,xxcmn_lot_cost                   xlc
          WHERE  stc_in.item_id      = xlc.item_id(+)
          AND    stc_in.lot_id       = xlc.lot_id(+)
          ;
        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             on_inv_qty   := 0;
             on_cargo_qty := 0;
             on_inv_amt   := 0;
             on_cargo_amt := 0;
        END;
-- 2008/12/18 v1.30 UPDATE END
      END IF;
--
    END prc_get_fst_end_inv_qty_amt;
--
  BEGIN
--
--##################  固定ステータス初期化部 START   ###################
--
    ov_retcode := gv_status_normal;
--
--###########################  固定部 END   ############################
--
    -- =====================================================
    -- 項目データ抽出処理
    -- =====================================================
    prc_get_report_data(
        ir_param      => ir_param       -- 01.入力パラメータ群
       ,ot_data_rec   => gt_main_data   -- 02.取得レコード群
       ,ov_errbuf     => lv_errbuf      --    エラー・メッセージ           --# 固定 #
       ,ov_retcode    => lv_retcode     --    リターン・コード             --# 固定 #
       ,ov_errmsg     => lv_errmsg      --    ユーザー・エラー・メッセージ --# 固定 #
      ) ;
    IF ( lv_retcode = gv_status_error ) THEN
      RAISE global_api_expt ;
--
    -- 取得データが０件の場合
    ELSIF ( gt_main_data.COUNT = 0 ) THEN
      RAISE no_data_expt ;
--
    END IF ;
--
    -- =====================================================
    -- 項目データ抽出・出力処理
    -- =====================================================
    -- -----------------------------------------------------
    -- ユーザーＧ開始タグ出力
    -- -----------------------------------------------------
    prc_set_xml('T', 'user_info');
    -- -----------------------------------------------------
    -- ユーザーＧデータタグ出力
    -- -----------------------------------------------------
    -- 帳票種別
    prc_set_xml('D', 'out_div', ir_param.print_kind);
    prc_set_xml('D', 'out_div_name', gv_print_class_name, 20);
    -- 処理年月
    prc_set_xml('D', 'exec_year', SUBSTR(ir_param.exec_year_month, 1, 4) );
    prc_set_xml('D', 'exec_month', TO_CHAR(SUBSTR(ir_param.exec_year_month, 5, 2),'00') );
    -- 商品区分
    prc_set_xml('D', 'prod_div', ir_param.goods_class);
    prc_set_xml('D', 'prod_div_name', gv_goods_class_name, 20);
    -- 品目区分
    prc_set_xml('D', 'item_div', ir_param.item_class);
    prc_set_xml('D', 'item_div_name', gv_item_class_name, 20);
    -- 群種別
    prc_set_xml('D', 'crowd_div', ir_param.crowd_kind);
    prc_set_xml('D', 'crowd_div_name', gv_crowd_kind_name, 20);
--
    -- 帳票ＩＤ
    prc_set_xml('D', 'report_id', gv_report_id);
    -- 実施日
    prc_set_xml('D', 'exec_date', TO_CHAR(gd_exec_date,gc_char_dt_format));
    -- 担当部署
    prc_set_xml('D', 'exec_user_dept', gv_user_dept, 10);
    -- 担当者名
    prc_set_xml('D', 'exec_user_name', gv_user_name, 14);
--
    -- 倉庫コードが指定されている場合
    IF (ir_param.locat_code  IS NOT NULL) THEN
      -- 倉庫計出力なし
      prc_set_xml('D', 'locat_sum', '1');
    END IF;
    -- -----------------------------------------------------
    -- ユーザーＧ終了タグ出力
    -- -----------------------------------------------------
    prc_set_xml('T','/user_info');
    -- -----------------------------------------------------
    -- データＬＧ開始タグ出力
    -- -----------------------------------------------------
    prc_set_xml('T', 'data_info');
    -- -----------------------------------------------------
    -- 倉庫ＬＧ開始タグ出力
    -- -----------------------------------------------------
    prc_set_xml('T', 'lg_locat');
    -- 帳票区分が「品目別」の場合
    IF (ir_param.print_kind = gc_print_kind_item) THEN
      -- -----------------------------------------------------
      -- 倉庫Ｇ開始タグ出力
      -- -----------------------------------------------------
      prc_set_xml('T', 'g_locat');
      -- ポジション
      ln_position := ln_position + 1;
      prc_set_xml('D', 'position', TO_CHAR(ln_position));
--
      -- -----------------------------------------------------
      -- キーブレイク時の初期処理
      -- -----------------------------------------------------
      -- キーブレイク用変数退避
      lv_locat_code := lc_break_null ;
      lv_crowd_high := lc_break_init ;
      -- -----------------------------------------------------
      -- 大群コードＬＧ開始タグ出力
      -- -----------------------------------------------------
      prc_set_xml('T', 'lg_crowd_high');
    END IF;
--
    -- =====================================================
    -- 項目データ抽出・出力処理
    -- =====================================================
    <<main_data_loop>>
    FOR i IN 1..gt_main_data.COUNT LOOP
-- 2008/11/25 v1.18 ADD START
      -- 変数初期化
      lb_zero := TRUE;  -- 出力判定
--
-- 2008/11/25 v1.18 ADD END
      -- =====================================================
      -- 倉庫コードブレイク
      -- =====================================================
      -- 帳票種別が「倉庫・品目別」で倉庫コードが切り替わった場合
      IF   ( ir_param.print_kind = gc_print_kind_locat )
       AND ( NVL( gt_main_data(i).locat_code, lc_break_null ) <> lv_locat_code ) THEN
        -- -----------------------------------------------------
        -- 終了タグ出力
        -- -----------------------------------------------------
        -- 初回レコードの場合は終了タグを出力しない。
        IF ( lv_locat_code <> lc_break_init ) THEN
          -- -----------------------------------------------------
          -- 明細データタグ出力
          -- -----------------------------------------------------
-- 2008/12/19 v1.31 DELETE START
/*
          -- 金額算出（原価管理区分が「標準原価」の場合）
          IF (lv_cost_kbn = gc_cost_st ) THEN
-- 2008/12/19 v1.31 UPDATE START
--            ln_amount := ln_unit_price * ln_quantity;
            ln_amount := ROUND(ln_unit_price * ln_quantity);
-- 2008/12/19 v1.31 UPDATE END
          END IF;
*/
-- 2008/12/19 v1.31 DELETE END
-- 2008/08/28 v1.10 UPDATE START
          -- 払出項目の場合
--          IF (lb_payout = TRUE) THEN
--            ln_quantity := ln_quantity * -1;
--            ln_amount   := ln_amount * -1;
--          END IF;
-- 2008/08/28 v1.10 UPDATE END
-- 2008/08/22 v1.8 ADD START
          IF (lb_revi = TRUE) THEN
            ln_quantity := ln_quantity * -1;
            ln_amount   := ln_amount * -1;
          END IF;
-- 2008/08/22 v1.8 ADD END
          -- 数量
          prc_set_xml('Z', lv_col_name || '_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          prc_set_xml('Z', lv_col_name || '_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2009/04/08 v1.34 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
          IF ((ln_quantity <> 0) OR (ln_amount <> 0)) THEN
            lb_zero := FALSE;
          END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2009/04/08 v1.34 DELETE END
          -- 数量・金額を集計（品目単位）
          IF (lb_payout = FALSE) THEN
            -- 受入
            ln_qty_in := ln_qty_in + ln_quantity;
            ln_amt_in := ln_amt_in + ln_amount;
          ELSE
            -- 払出
            ln_qty_out := ln_qty_out + ln_quantity;
            ln_amt_out := ln_amt_out + ln_amount;
          END IF;
--
-- 2009/04/08 v1.34 ADD START
          IF (
               (ln_qty_in <> 0)
               OR
               (ln_amt_in <> 0)
               OR
               (ln_qty_out <> 0)
               OR
               (ln_amt_out <> 0)
             ) THEN
            lb_zero := FALSE;
          END IF;
-- 2009/04/08 v1.34 ADD END
          -- -----------------------------------------------------
          -- 月末データタグ出力
          -- -----------------------------------------------------
          -- 数量
          ln_quantity := ln_first_inv_qty + ln_qty_in - ln_qty_out;
          prc_set_xml('Z', 'end_inv_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          ln_amount := ln_first_inv_amt + ln_amt_in - ln_amt_out;
          prc_set_xml('Z', 'end_inv_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2008/11/17 v1.16 DELETE START
--          -- -----------------
--          -- 受払VIEWより取得
--          -- -----------------
--          prc_get_inv_qty_amt(ir_param, i, ir_param.exec_year_month, ln_inv_qty, ln_inv_amt);
-- 2008/11/17 v1.16 DELETE END
--
          -- -----------------------------------------------------
          -- 棚卸・差異データタグ出力
          -- -----------------------------------------------------
          prc_get_fst_end_inv_qty_amt(ir_param, i, ir_param.exec_year_month,
-- 2008/11/17 v1.16 UPDATE START
--                                                ln_end_inv_qty, ln_end_inv_amt);
                                ln_end_inv_qty, ln_end_cargo_qty, ln_end_inv_amt, ln_end_cargo_amt);
-- 2008/11/17 v1.16 UPDATE END
-- 2008/12/15 v1.28 UPDATE START
--          IF (ln_end_inv_qty = 0) THEN
          IF (ln_end_inv_qty + ln_end_cargo_qty = 0) THEN
            -- 在庫数量が確定していない場合
            prc_set_xml('N', 'inv_qty'  , '0');
            prc_set_xml('N', 'inv_amt'  , '0');
-- 2008/08/20 v1.7 UPDATE START
--            prc_set_xml('N', 'quantity' , '0');
--            prc_set_xml('N', 'amount'   , '0');
            -- 差異数量
--            ln_quantity := ln_quantity - ln_end_inv_qty;
            ln_quantity := ln_quantity - ln_end_inv_qty - ln_end_cargo_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
--            ln_amount := ln_amount - ln_end_inv_amt ;
            ln_amount := ln_amount - ln_end_inv_amt - ln_end_cargo_amt;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
-- 2008/12/15 v1.28 UPDATE END
-- 2008/08/20 v1.7 UPDATE END
          ELSE
            -- 在庫数量が確定している場合
            -- 棚卸数量
-- 2008/11/17 v1.16 UPDATE START
--            ln_end_inv_qty := ln_end_inv_qty + ln_inv_qty;
            ln_end_inv_qty := ln_end_inv_qty + ln_end_cargo_qty;
-- 2008/11/17 v1.16 UPDATE END
            prc_set_xml('N', 'inv_qty' ,TO_CHAR(ROUND(ln_end_inv_qty, gn_quantity_decml)));
            -- 棚卸金額
-- 2008/12/10 v1.24 UPDATE START
/*
            IF (lv_cost_kbn = gc_cost_st ) THEN
              -- 原価管理区分が「標準原価」の場合
              ln_end_inv_amt := ln_end_inv_qty * ln_unit_price;
            ELSE
              -- 原価管理区分が「実際原価」の場合
-- 2008/11/17 v1.16 UPDATE START
--              ln_end_inv_amt := ln_end_inv_amt + ln_inv_amt;
              ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
-- 2008/11/17 v1.16 UPDATE END
            END IF;
*/
            ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
--
-- 2008/12/10 v1.24 UPDATE END
            prc_set_xml('N', 'inv_amt' ,TO_CHAR(ROUND(ln_end_inv_amt, gn_amount_decml )));
            -- 差異数量
            ln_quantity := ln_quantity - ln_end_inv_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
            ln_amount := ln_amount - ln_end_inv_amt ;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
          END IF;
--
-- 2008/11/25 v1.18 ADD START
          -- 当月受払・月首・棚卸の数量・金額が全てゼロの場合
          IF (
               (lb_zero = TRUE)
                 AND (ln_first_inv_qty = 0)
                   AND (ln_first_inv_amt = 0)
                     AND (ln_end_inv_qty = 0)
                       AND (ln_end_inv_amt = 0)
             ) THEN
          ------------------------------
          -- 出力判定用タグ
          ------------------------------
            prc_set_xml('Z', 'flg', '1');
          ELSE
            prc_set_xml('Z', 'flg', '0');
          END IF;
--
-- 2008/11/25 v1.18 ADD END
-- 2008/12/12 v1.27 ADD START
          -- 変数の初期化
          ln_first_inv_qty   := 0;
          ln_first_inv_amt   := 0;
          ln_end_inv_qty     := 0;
          ln_end_inv_amt     := 0;
          ln_first_cargo_qty := 0;
          ln_first_cargo_amt := 0;
          ln_end_cargo_qty   := 0;
          ln_end_cargo_amt   := 0;
--
-- 2008/12/12 v1.27 ADD END
          ------------------------------
          -- 品目コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_item');
          ------------------------------
          -- 品目コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_item');
          ------------------------------
          -- 群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_dtl');
          ------------------------------
          -- 群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_dtl');
          ------------------------------
          -- 小群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_low');
          ------------------------------
          -- 小群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_low');
          ------------------------------
          -- 中群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_mid');
          ------------------------------
          -- 中群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_mid');
          ------------------------------
          -- 大群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_high');
          ------------------------------
          -- 大群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_high');
          ------------------------------
          -- 倉庫コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_locat');
        END IF ;
--
        -- -----------------------------------------------------
        -- 倉庫コードＧ開始タグ出力
        -- -----------------------------------------------------
        prc_set_xml('T', 'g_locat');
        -- -----------------------------------------------------
        -- 倉庫コードＧデータタグ出力
        -- -----------------------------------------------------
        -- ポジション
        ln_position := ln_position + 1;
        prc_set_xml('D', 'position', TO_CHAR(ln_position));
        -- 倉庫コード
        prc_set_xml('D', 'locat_code', gt_main_data(i).locat_code);
        -- 倉庫名
        prc_set_xml('D', 'locat_name', gt_main_data(i).locat_name, 20);
        -- -----------------------------------------------------
        -- 大群コードＬＧ開始タグ出力
        -- -----------------------------------------------------
        prc_set_xml('T', 'lg_crowd_high');
--
        -- -----------------------------------------------------
        -- キーブレイク時の初期処理
        -- -----------------------------------------------------
        -- キーブレイク用変数退避
        lv_locat_code := NVL( gt_main_data(i).locat_code, lc_break_null )  ;
        lv_crowd_high := lc_break_init ;
--
      END IF ;
--
      -- =====================================================
      -- 大群コードブレイク
      -- =====================================================
      -- 大群コードが切り替わった場合
      IF ( NVL( gt_main_data(i).crowd_high, lc_break_null ) <> lv_crowd_high ) THEN
        -- -----------------------------------------------------
        -- 終了タグ出力
        -- -----------------------------------------------------
        -- 初回レコードの場合は終了タグを出力しない。
        IF ( lv_crowd_high <> lc_break_init ) THEN
          -- -----------------------------------------------------
          -- 明細データタグ出力
          -- -----------------------------------------------------
-- 2008/12/19 v1.31 DELETE START
/*
          -- 金額算出（原価管理区分が「標準原価」の場合）
          IF (lv_cost_kbn = gc_cost_st ) THEN
-- 2008/12/19 v1.31 UPDATE START
--            ln_amount := ln_unit_price * ln_quantity;
            ln_amount := ROUND(ln_unit_price * ln_quantity);
-- 2008/12/19 v1.31 UPDATE END
          END IF;
*/
-- 2008/12/19 v1.31 DELETE END
-- 2008/08/28 v1.10 UPDATE START
          -- 払出項目の場合
--          IF (lb_payout = TRUE) THEN
--            ln_quantity := ln_quantity * -1;
--            ln_amount   := ln_amount * -1;
--          END IF;
-- 2008/08/28 v1.10 UPDATE END
-- 2008/08/22 v1.8 ADD START
          IF (lb_revi = TRUE) THEN
            ln_quantity := ln_quantity * -1;
            ln_amount   := ln_amount * -1;
          END IF;
-- 2008/08/22 v1.8 ADD END
          -- 数量
          prc_set_xml('Z', lv_col_name || '_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          prc_set_xml('Z', lv_col_name || '_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2009/04/08 v1.34 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
          IF ((ln_quantity <> 0) OR (ln_amount <> 0)) THEN
            lb_zero := FALSE;
          END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2009/04/08 v1.34 DELETE END
          -- 数量・金額を集計（品目単位）
          IF (lb_payout = FALSE) THEN
            -- 受入
            ln_qty_in := ln_qty_in + ln_quantity;
            ln_amt_in := ln_amt_in + ln_amount;
          ELSE
            -- 払出
            ln_qty_out := ln_qty_out + ln_quantity;
            ln_amt_out := ln_amt_out + ln_amount;
          END IF;
--
-- 2009/04/08 v1.34 ADD START
          IF (
               (ln_qty_in <> 0)
               OR
               (ln_amt_in <> 0)
               OR
               (ln_qty_out <> 0)
               OR
               (ln_amt_out <> 0)
             ) THEN
            lb_zero := FALSE;
          END IF;
-- 2009/04/08 v1.34 ADD END
          -- -----------------------------------------------------
          -- 月末データタグ出力
          -- -----------------------------------------------------
          -- 数量
          ln_quantity := ln_first_inv_qty + ln_qty_in - ln_qty_out;
          prc_set_xml('Z', 'end_inv_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          ln_amount := ln_first_inv_amt + ln_amt_in - ln_amt_out;
          prc_set_xml('Z', 'end_inv_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2008/11/17 v1.16 DELETE START
--          -- -----------------
--          -- 受払VIEWより取得
--          -- -----------------
--          prc_get_inv_qty_amt(ir_param, i, ir_param.exec_year_month, ln_inv_qty, ln_inv_amt);
-- 2008/11/17 v1.16 DELETE END
--
          -- -----------------------------------------------------
          -- 棚卸・差異データタグ出力
          -- -----------------------------------------------------
          prc_get_fst_end_inv_qty_amt(ir_param, i, ir_param.exec_year_month,
-- 2008/11/17 v1.16 UPDATE START
--                                                ln_end_inv_qty, ln_end_inv_amt);
                                ln_end_inv_qty, ln_end_cargo_qty, ln_end_inv_amt, ln_end_cargo_amt);
-- 2008/11/17 v1.16 UPDATE END
-- 2008/12/15 v1.28 UPDATE START
--          IF (ln_end_inv_qty = 0) THEN
          IF (ln_end_inv_qty + ln_end_cargo_qty = 0) THEN
            -- 在庫数量が確定していない場合
            prc_set_xml('N', 'inv_qty'  , '0');
            prc_set_xml('N', 'inv_amt'  , '0');
-- 2008/08/20 v1.7 UPDATE START
--            prc_set_xml('N', 'quantity' , '0');
--            prc_set_xml('N', 'amount'   , '0');
            -- 差異数量
--            ln_quantity := ln_quantity - ln_end_inv_qty;
            ln_quantity := ln_quantity - ln_end_inv_qty - ln_end_cargo_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
--            ln_amount := ln_amount - ln_end_inv_amt ;
            ln_amount := ln_amount - ln_end_inv_amt - ln_end_cargo_amt;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
-- 2008/12/15 v1.28 UPDATE END
-- 2008/08/20 v1.7 UPDATE END
          ELSE
            -- 在庫数量が確定している場合
            -- 棚卸数量
-- 2008/11/17 v1.16 UPDATE START
--            ln_end_inv_qty := ln_end_inv_qty + ln_inv_qty;
            ln_end_inv_qty := ln_end_inv_qty + ln_end_cargo_qty;
-- 2008/11/17 v1.16 UPDATE END
            prc_set_xml('N', 'inv_qty' ,TO_CHAR(ROUND(ln_end_inv_qty, gn_quantity_decml)));
            -- 棚卸金額
-- 2008/12/10 v1.24 UPDATE START
/*
            IF (lv_cost_kbn = gc_cost_st ) THEN
              -- 原価管理区分が「標準原価」の場合
              ln_end_inv_amt := ln_end_inv_qty * ln_unit_price;
            ELSE
              -- 原価管理区分が「実際原価」の場合
-- 2008/11/17 v1.16 UPDATE START
--              ln_end_inv_amt := ln_end_inv_amt + ln_inv_amt;
              ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
-- 2008/11/17 v1.16 UPDATE END
            END IF;
*/
            ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
--
-- 2008/12/10 v1.24 UPDATE END
            prc_set_xml('N', 'inv_amt' ,TO_CHAR(ROUND(ln_end_inv_amt, gn_amount_decml )));
            -- 差異数量
            ln_quantity := ln_quantity - ln_end_inv_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
            ln_amount := ln_amount - ln_end_inv_amt ;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
          END IF;
--
-- 2008/11/25 v1.18 ADD START
          -- 当月受払・月首・棚卸の数量・金額が全てゼロの場合
          IF (
               (lb_zero = TRUE)
                 AND (ln_first_inv_qty = 0)
                   AND (ln_first_inv_amt = 0)
                     AND (ln_end_inv_qty = 0)
                       AND (ln_end_inv_amt = 0)
             ) THEN
          ------------------------------
          -- 出力判定用タグ
          ------------------------------
            prc_set_xml('Z', 'flg', '1');
          ELSE
            prc_set_xml('Z', 'flg', '0');
          END IF;
--
-- 2008/11/25 v1.18 ADD END
-- 2008/12/12 v1.27 ADD START
          -- 変数の初期化
          ln_first_inv_qty   := 0;
          ln_first_inv_amt   := 0;
          ln_end_inv_qty     := 0;
          ln_end_inv_amt     := 0;
          ln_first_cargo_qty := 0;
          ln_first_cargo_amt := 0;
          ln_end_cargo_qty   := 0;
          ln_end_cargo_amt   := 0;
--
-- 2008/12/12 v1.27 ADD END
          ------------------------------
          -- 品目コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_item');
          ------------------------------
          -- 品目コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_item');
          ------------------------------
          -- 群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_dtl');
          ------------------------------
          -- 群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_dtl');
          ------------------------------
          -- 小群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_low');
          ------------------------------
          -- 小群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_low');
          ------------------------------
          -- 中群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_mid');
          ------------------------------
          -- 中群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_mid');
          ------------------------------
          -- 大群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_high');
        END IF ;
--
        ------------------------------
        -- 大群コードＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'g_crowd_high');
        -- -----------------------------------------------------
        -- 大群コードＧデータタグ出力
        -- -----------------------------------------------------
        -- 大群コード
        prc_set_xml('D', 'crowd_high', gt_main_data(i).crowd_high);
        ------------------------------
        -- 中群コードＬＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'lg_crowd_mid');
--
        -- -----------------------------------------------------
        -- キーブレイク時の初期処理
        -- -----------------------------------------------------
        -- キーブレイク用変数退避
        lv_crowd_high := NVL( gt_main_data(i).crowd_high, lc_break_null ) ;
        lv_crowd_mid  := lc_break_init ;
--
      END IF ;
--
      -- =====================================================
      -- 中群コードブレイク
      -- =====================================================
      -- 中群コードが切り替わった場合
      IF ( NVL( gt_main_data(i).crowd_mid, lc_break_null ) <> lv_crowd_mid ) THEN
        -- -----------------------------------------------------
        -- 終了タグ出力
        -- -----------------------------------------------------
        -- 初回レコードの場合は終了タグを出力しない。
        IF ( lv_crowd_mid <> lc_break_init ) THEN
          -- -----------------------------------------------------
          -- 明細データタグ出力
          -- -----------------------------------------------------
-- 2008/12/19 v1.31 DELETE START
/*
          -- 金額算出（原価管理区分が「標準原価」の場合）
          IF (lv_cost_kbn = gc_cost_st ) THEN
-- 2008/12/19 v1.31 UPDATE START
--            ln_amount := ln_unit_price * ln_quantity;
            ln_amount := ROUND(ln_unit_price * ln_quantity);
-- 2008/12/19 v1.31 UPDATE END
          END IF;
*/
-- 2008/12/19 v1.31 DELETE END
-- 2008/08/28 v1.10 UPDATE START
          -- 払出項目の場合
--          IF (lb_payout = TRUE) THEN
--            ln_quantity := ln_quantity * -1;
--            ln_amount   := ln_amount * -1;
--          END IF;
-- 2008/08/28 v1.10 UPDATE END
-- 2008/08/22 v1.8 ADD START
          IF (lb_revi = TRUE) THEN
            ln_quantity := ln_quantity * -1;
            ln_amount   := ln_amount * -1;
          END IF;
-- 2008/08/22 v1.8 ADD END
          -- 数量
          prc_set_xml('Z', lv_col_name || '_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          prc_set_xml('Z', lv_col_name || '_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2009/04/08 v1.34 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
          IF ((ln_quantity <> 0) OR (ln_amount <> 0)) THEN
            lb_zero := FALSE;
          END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2009/04/08 v1.34 DELETE END
          -- 数量・金額を集計（品目単位）
          IF (lb_payout = FALSE) THEN
            -- 受入
            ln_qty_in := ln_qty_in + ln_quantity;
            ln_amt_in := ln_amt_in + ln_amount;
          ELSE
            -- 払出
            ln_qty_out := ln_qty_out + ln_quantity;
            ln_amt_out := ln_amt_out + ln_amount;
          END IF;
--
-- 2009/04/08 v1.34 ADD START
          IF (
               (ln_qty_in <> 0)
               OR
               (ln_amt_in <> 0)
               OR
               (ln_qty_out <> 0)
               OR
               (ln_amt_out <> 0)
             ) THEN
            lb_zero := FALSE;
          END IF;
-- 2009/04/08 v1.34 ADD END
          -- -----------------------------------------------------
          -- 月末データタグ出力
          -- -----------------------------------------------------
          -- 数量
          ln_quantity := ln_first_inv_qty + ln_qty_in - ln_qty_out;
          prc_set_xml('Z', 'end_inv_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          ln_amount := ln_first_inv_amt + ln_amt_in - ln_amt_out;
          prc_set_xml('Z', 'end_inv_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
          -- -----------------
          -- 受払VIEWより取得
          -- -----------------
-- 2008/11/17 v1.16 DELETE START
--          prc_get_inv_qty_amt(ir_param, i, ir_param.exec_year_month, ln_inv_qty, ln_inv_amt);
-- 2008/11/17 v1.16 DELETE END
--
          -- -----------------------------------------------------
          -- 棚卸・差異データタグ出力
          -- -----------------------------------------------------
          prc_get_fst_end_inv_qty_amt(ir_param, i, ir_param.exec_year_month,
-- 2008/11/17 v1.16 UPDATE START
--                                                ln_end_inv_qty, ln_end_inv_amt);
                                ln_end_inv_qty, ln_end_cargo_qty, ln_end_inv_amt, ln_end_cargo_amt);
-- 2008/11/17 v1.16 UPDATE END
-- 2008/12/15 v1.28 UPDATE START
--          IF (ln_end_inv_qty = 0) THEN
          IF (ln_end_inv_qty + ln_end_cargo_qty = 0) THEN
            -- 在庫数量が確定していない場合
            prc_set_xml('N', 'inv_qty'  , '0');
            prc_set_xml('N', 'inv_amt'  , '0');
-- 2008/08/20 v1.7 UPDATE START
--            prc_set_xml('N', 'quantity' , '0');
--            prc_set_xml('N', 'amount'   , '0');
            -- 差異数量
--            ln_quantity := ln_quantity - ln_end_inv_qty;
            ln_quantity := ln_quantity - ln_end_inv_qty - ln_end_cargo_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
--             ln_amount := ln_amount - ln_end_inv_amt ;
            ln_amount := ln_amount - ln_end_inv_amt - ln_end_cargo_amt;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
-- 2008/12/15 v1.28 UPDATE END
-- 2008/08/20 v1.7 UPDATE END
          ELSE
            -- 在庫数量が確定している場合
            -- 棚卸数量
-- 2008/11/17 v1.16 UPDATE START
--            ln_end_inv_qty := ln_end_inv_qty + ln_inv_qty;
            ln_end_inv_qty := ln_end_inv_qty + ln_end_cargo_qty;
-- 2008/11/17 v1.16 UPDATE END
            prc_set_xml('N', 'inv_qty' ,TO_CHAR(ROUND(ln_end_inv_qty, gn_quantity_decml)));
            -- 棚卸金額
-- 2008/12/10 v1.24 UPDATE START
/*
            IF (lv_cost_kbn = gc_cost_st ) THEN
              -- 原価管理区分が「標準原価」の場合
              ln_end_inv_amt := ln_end_inv_qty * ln_unit_price;
            ELSE
              -- 原価管理区分が「実際原価」の場合
-- 2008/11/17 v1.16 UPDATE START
--              ln_end_inv_amt := ln_end_inv_amt + ln_inv_amt;
              ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
-- 2008/11/17 v1.16 UPDATE END
            END IF;
*/
            ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
--
-- 2008/12/10 v1.24 UPDATE END
            prc_set_xml('N', 'inv_amt' ,TO_CHAR(ROUND(ln_end_inv_amt, gn_amount_decml )));
            -- 差異数量
            ln_quantity := ln_quantity - ln_end_inv_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
            ln_amount := ln_amount - ln_end_inv_amt ;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
          END IF;
--
-- 2008/11/25 v1.18 ADD START
          -- 当月受払・月首・棚卸の数量・金額が全てゼロの場合
          IF (
               (lb_zero = TRUE)
                 AND (ln_first_inv_qty = 0)
                   AND (ln_first_inv_amt = 0)
                     AND (ln_end_inv_qty = 0)
                       AND (ln_end_inv_amt = 0)
             ) THEN
          ------------------------------
          -- 出力判定用タグ
          ------------------------------
            prc_set_xml('Z', 'flg', '1');
          ELSE
            prc_set_xml('Z', 'flg', '0');
          END IF;
--
-- 2008/11/25 v1.18 ADD END
-- 2008/12/12 v1.27 ADD START
          -- 変数の初期化
          ln_first_inv_qty   := 0;
          ln_first_inv_amt   := 0;
          ln_end_inv_qty     := 0;
          ln_end_inv_amt     := 0;
          ln_first_cargo_qty := 0;
          ln_first_cargo_amt := 0;
          ln_end_cargo_qty   := 0;
          ln_end_cargo_amt   := 0;
--
-- 2008/12/12 v1.27 ADD END
          ------------------------------
          -- 品目コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_item');
          ------------------------------
          -- 品目コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_item');
          ------------------------------
          -- 群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_dtl');
          ------------------------------
          -- 群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_dtl');
          ------------------------------
          -- 小群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_low');
          ------------------------------
          -- 小群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_low');
          ------------------------------
          -- 中群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_mid');
        END IF ;
--
        ------------------------------
        -- 中群コードＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'g_crowd_mid');
        -- -----------------------------------------------------
        -- 中群コードＧデータタグ出力
        -- -----------------------------------------------------
        -- 中群コード
        prc_set_xml('D', 'crowd_mid', gt_main_data(i).crowd_mid);
        ------------------------------
        -- 小群コードＬＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'lg_crowd_low');
--
        -- -----------------------------------------------------
        -- キーブレイク時の初期処理
        -- -----------------------------------------------------
        -- キーブレイク用変数退避
        lv_crowd_mid := NVL( gt_main_data(i).crowd_mid, lc_break_null ) ;
        lv_crowd_low  := lc_break_init ;
--
      END IF ;
--
      -- =====================================================
      -- 小群コードブレイク
      -- =====================================================
      -- 小群コードが切り替わった場合
      IF ( NVL( gt_main_data(i).crowd_low, lc_break_null ) <> lv_crowd_low ) THEN
        -- -----------------------------------------------------
        -- 終了タグ出力
        -- -----------------------------------------------------
        -- 初回レコードの場合は終了タグを出力しない。
        IF ( lv_crowd_low <> lc_break_init ) THEN
          -- -----------------------------------------------------
          -- 明細データタグ出力
          -- -----------------------------------------------------
-- 2008/12/19 v1.31 DELETE START
/*
          -- 金額算出（原価管理区分が「標準原価」の場合）
          IF (lv_cost_kbn = gc_cost_st ) THEN
-- 2008/12/19 v1.31 UPDATE START
--            ln_amount := ln_unit_price * ln_quantity;
            ln_amount := ROUND(ln_unit_price * ln_quantity);
-- 2008/12/19 v1.31 UPDATE END
          END IF;
*/
-- 2008/12/19 v1.31 DELETE END
-- 2008/08/28 v1.10 UPDATE START
          -- 払出項目の場合
--          IF (lb_payout = TRUE) THEN
--            ln_quantity := ln_quantity * -1;
--            ln_amount   := ln_amount * -1;
--          END IF;
-- 2008/08/28 v1.10 UPDATE END
-- 2008/08/22 v1.8 ADD START
          IF (lb_revi = TRUE) THEN
            ln_quantity := ln_quantity * -1;
            ln_amount   := ln_amount * -1;
          END IF;
-- 2008/08/22 v1.8 ADD END
          -- 数量
          prc_set_xml('Z', lv_col_name || '_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          prc_set_xml('Z', lv_col_name || '_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2009/04/08 v1.34 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
          IF ((ln_quantity <> 0) OR (ln_amount <> 0)) THEN
            lb_zero := FALSE;
          END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2009/04/08 v1.34 DELETE END
          -- 数量・金額を集計（品目単位）
          IF (lb_payout = FALSE) THEN
            -- 受入
            ln_qty_in := ln_qty_in + ln_quantity;
            ln_amt_in := ln_amt_in + ln_amount;
          ELSE
            -- 払出
            ln_qty_out := ln_qty_out + ln_quantity;
            ln_amt_out := ln_amt_out + ln_amount;
          END IF;
--
-- 2009/04/08 v1.34 ADD START
          IF (
               (ln_qty_in <> 0)
               OR
               (ln_amt_in <> 0)
               OR
               (ln_qty_out <> 0)
               OR
               (ln_amt_out <> 0)
             ) THEN
            lb_zero := FALSE;
          END IF;
-- 2009/04/08 v1.34 ADD END
          -- -----------------------------------------------------
          -- 月末データタグ出力
          -- -----------------------------------------------------
          -- 数量
          ln_quantity := ln_first_inv_qty + ln_qty_in - ln_qty_out;
          prc_set_xml('Z', 'end_inv_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          ln_amount := ln_first_inv_amt + ln_amt_in - ln_amt_out;
          prc_set_xml('Z', 'end_inv_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
          -- -----------------
          -- 受払VIEWより取得
          -- -----------------
-- 2008/11/17 v1.16 DELETE START
--          prc_get_inv_qty_amt(ir_param, i, ir_param.exec_year_month, ln_inv_qty, ln_inv_amt);
-- 2008/11/17 v1.16 DELETE END
--
          -- -----------------------------------------------------
          -- 棚卸・差異データタグ出力
          -- -----------------------------------------------------
          prc_get_fst_end_inv_qty_amt(ir_param, i, ir_param.exec_year_month,
-- 2008/11/17 v1.16 UPDATE START
--                                                ln_end_inv_qty, ln_end_inv_amt);
                                ln_end_inv_qty, ln_end_cargo_qty, ln_end_inv_amt, ln_end_cargo_amt);
-- 2008/11/17 v1.16 UPDATE END
-- 2008/12/15 v1.28 UPDATE START
--          IF (ln_end_inv_qty = 0) THEN
          IF (ln_end_inv_qty + ln_end_cargo_qty = 0) THEN
            -- 在庫数量が確定していない場合
            prc_set_xml('N', 'inv_qty'  , '0');
            prc_set_xml('N', 'inv_amt'  , '0');
-- 2008/08/20 v1.7 UPDATE START
--            prc_set_xml('N', 'quantity' , '0');
--            prc_set_xml('N', 'amount'   , '0');
            -- 差異数量
--            ln_quantity := ln_quantity - ln_end_inv_qty;
            ln_quantity := ln_quantity - ln_end_inv_qty - ln_end_cargo_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
--            ln_amount := ln_amount - ln_end_inv_amt ;
            ln_amount := ln_amount - ln_end_inv_amt - ln_end_cargo_amt;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
-- 2008/12/15 v1.28 UPDATE END
-- 2008/08/20 v1.7 UPDATE END
          ELSE
            -- 在庫数量が確定している場合
            -- 棚卸数量
-- 2008/11/17 v1.16 UPDATE START
--            ln_end_inv_qty := ln_end_inv_qty + ln_inv_qty;
            ln_end_inv_qty := ln_end_inv_qty + ln_end_cargo_qty;
-- 2008/11/17 v1.16 UPDATE END
            prc_set_xml('N', 'inv_qty' ,TO_CHAR(ROUND(ln_end_inv_qty, gn_quantity_decml)));
            -- 棚卸金額
-- 2008/12/10 v1.24 UPDATE START
/*
            IF (lv_cost_kbn = gc_cost_st ) THEN
              -- 原価管理区分が「標準原価」の場合
              ln_end_inv_amt := ln_end_inv_qty * ln_unit_price;
            ELSE
              -- 原価管理区分が「実際原価」の場合
-- 2008/08/20 v1.7 UPDATE START
--              ln_end_inv_amt := ln_end_inv_amt + ln_inv_amt;
              ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
-- 2008/08/20 v1.7 UPDATE END
            END IF;
*/
            ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
--
-- 2008/12/10 v1.24 UPDATE END
            prc_set_xml('N', 'inv_amt' ,TO_CHAR(ROUND(ln_end_inv_amt, gn_amount_decml )));
            -- 差異数量
            ln_quantity := ln_quantity - ln_end_inv_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
            ln_amount := ln_amount - ln_end_inv_amt ;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
          END IF;
--
-- 2008/11/25 v1.18 ADD START
          -- 当月受払・月首・棚卸の数量・金額が全てゼロの場合
          IF (
               (lb_zero = TRUE)
                 AND (ln_first_inv_qty = 0)
                   AND (ln_first_inv_amt = 0)
                     AND (ln_end_inv_qty = 0)
                       AND (ln_end_inv_amt = 0)
             ) THEN
          ------------------------------
          -- 出力判定用タグ
          ------------------------------
            prc_set_xml('Z', 'flg', '1');
          ELSE
            prc_set_xml('Z', 'flg', '0');
          END IF;
--
-- 2008/11/25 v1.18 ADD END
-- 2008/12/12 v1.27 ADD START
          -- 変数の初期化
          ln_first_inv_qty   := 0;
          ln_first_inv_amt   := 0;
          ln_end_inv_qty     := 0;
          ln_end_inv_amt     := 0;
          ln_first_cargo_qty := 0;
          ln_first_cargo_amt := 0;
          ln_end_cargo_qty   := 0;
          ln_end_cargo_amt   := 0;
--
-- 2008/12/12 v1.27 ADD END
          ------------------------------
          -- 品目コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_item');
          ------------------------------
          -- 品目コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_item');
          ------------------------------
          -- 群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_dtl');
          ------------------------------
          -- 群コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_crowd_dtl');
          ------------------------------
          -- 小群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_low');
        END IF ;
--
        ------------------------------
        -- 小群コードＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'g_crowd_low');
        -- -----------------------------------------------------
        -- 小群コードＧデータタグ出力
        -- -----------------------------------------------------
        -- 小群コード
        prc_set_xml('D', 'crowd_low', gt_main_data(i).crowd_low);
        ------------------------------
        -- 群コードＬＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'lg_crowd_dtl');
--
        -- -----------------------------------------------------
        -- キーブレイク時の初期処理
        -- -----------------------------------------------------
        -- キーブレイク用変数退避
        lv_crowd_low  := NVL( gt_main_data(i).crowd_low, lc_break_null ) ;
        lv_crowd_code := lc_break_init ;
--
      END IF ;
--
      -- =====================================================
      -- 群コードブレイク
      -- =====================================================
      -- 群コードが切り替わった場合
      IF ( NVL( gt_main_data(i).crowd_code, lc_break_null ) <> lv_crowd_code ) THEN
        -- -----------------------------------------------------
        -- 終了タグ出力
        -- -----------------------------------------------------
        -- 初回レコードの場合は終了タグを出力しない。
        IF ( lv_crowd_code <> lc_break_init ) THEN
          -- -----------------------------------------------------
          -- 明細データタグ出力
          -- -----------------------------------------------------
-- 2008/12/19 v1.31 DELETE START
/*
          -- 金額算出（原価管理区分が「標準原価」の場合）
          IF (lv_cost_kbn = gc_cost_st ) THEN
-- 2008/12/19 v1.31 UPDATE START
--            ln_amount := ln_unit_price * ln_quantity;
            ln_amount := ROUND(ln_unit_price * ln_quantity);
-- 2008/12/19 v1.31 UPDATE END
          END IF;
*/
-- 2008/12/19 v1.31 DELETE END
-- 2008/08/28 v1.10 UPDATE START
          -- 払出項目の場合
--          IF (lb_payout = TRUE) THEN
--            ln_quantity := ln_quantity * -1;
--            ln_amount   := ln_amount * -1;
--          END IF;
-- 2008/08/28 v1.10 UPDATE END
-- 2008/08/22 v1.8 ADD START
          IF (lb_revi = TRUE) THEN
            ln_quantity := ln_quantity * -1;
            ln_amount   := ln_amount * -1;
          END IF;
-- 2008/08/22 v1.8 ADD END
          -- 数量
          prc_set_xml('Z', lv_col_name || '_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          prc_set_xml('Z', lv_col_name || '_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2009/04/08 v1.34 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
          IF ((ln_quantity <> 0) OR (ln_amount <> 0)) THEN
            lb_zero := FALSE;
          END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2009/04/08 v1.34 DELETE END
          -- 数量・金額を集計（品目単位）
          IF (lb_payout = FALSE) THEN
            -- 受入
            ln_qty_in := ln_qty_in + ln_quantity;
            ln_amt_in := ln_amt_in + ln_amount;
          ELSE
            -- 払出
            ln_qty_out := ln_qty_out + ln_quantity;
            ln_amt_out := ln_amt_out + ln_amount;
          END IF;
--
-- 2009/04/08 v1.34 ADD START
          IF (
               (ln_qty_in <> 0)
               OR
               (ln_amt_in <> 0)
               OR
               (ln_qty_out <> 0)
               OR
               (ln_amt_out <> 0)
             ) THEN
            lb_zero := FALSE;
          END IF;
-- 2009/04/08 v1.34 ADD END
          -- -----------------------------------------------------
          -- 月末データタグ出力
          -- -----------------------------------------------------
          -- 数量
          ln_quantity := ln_first_inv_qty + ln_qty_in - ln_qty_out;
          prc_set_xml('Z', 'end_inv_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          ln_amount := ln_first_inv_amt + ln_amt_in - ln_amt_out;
          prc_set_xml('Z', 'end_inv_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
          -- -----------------
          -- 受払VIEWより取得
          -- -----------------
-- 2008/11/17 v1.16 DELETE START
--          prc_get_inv_qty_amt(ir_param, i, ir_param.exec_year_month, ln_inv_qty, ln_inv_amt);
-- 2008/11/17 v1.16 DELETE END
--
          -- -----------------------------------------------------
          -- 棚卸・差異データタグ出力
          -- -----------------------------------------------------
          prc_get_fst_end_inv_qty_amt(ir_param, i, ir_param.exec_year_month,
-- 2008/11/17 v1.16 UPDATE START
--                                                ln_end_inv_qty, ln_end_inv_amt);
                                ln_end_inv_qty, ln_end_cargo_qty, ln_end_inv_amt, ln_end_cargo_amt);
-- 2008/11/17 v1.16 DELETE END
-- 2008/12/15 v1.28 UPDATE START
--          IF (ln_end_inv_qty = 0) THEN
          IF (ln_end_inv_qty + ln_end_cargo_qty = 0) THEN
            -- 在庫数量が確定していない場合
            prc_set_xml('N', 'inv_qty'  , '0');
            prc_set_xml('N', 'inv_amt'  , '0');
-- 2008/08/20 v1.7 UPDATE START
--            prc_set_xml('N', 'quantity' , '0');
--            prc_set_xml('N', 'amount'   , '0');
            -- 差異数量
--            ln_quantity := ln_quantity - ln_end_inv_qty;
            ln_quantity := ln_quantity - ln_end_inv_qty - ln_end_cargo_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
--            ln_amount := ln_amount - ln_end_inv_amt ;
            ln_amount := ln_amount - ln_end_inv_amt - ln_end_cargo_amt;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
-- 2008/12/15 v1.28 UPDATE END
-- 2008/08/20 v1.7 UPDATE END
          ELSE
            -- 在庫数量が確定している場合
            -- 棚卸数量
-- 2008/11/17 v1.16 UPDATE START
--            ln_end_inv_qty := ln_end_inv_qty + ln_inv_qty;
            ln_end_inv_qty := ln_end_inv_qty + ln_end_cargo_qty;
-- 2008/11/17 v1.16 UPDATE END
            prc_set_xml('N', 'inv_qty' ,TO_CHAR(ROUND(ln_end_inv_qty, gn_quantity_decml)));
            -- 棚卸金額
-- 2008/12/10 v1.24 UPDATE START
/*
            IF (lv_cost_kbn = gc_cost_st ) THEN
              -- 原価管理区分が「標準原価」の場合
              ln_end_inv_amt := ln_end_inv_qty * ln_unit_price;
            ELSE
              -- 原価管理区分が「実際原価」の場合
-- 2008/11/17 v1.16 UPDATE START
--              ln_end_inv_amt := ln_end_inv_amt + ln_inv_amt;
              ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
-- 2008/11/17 v1.16 UPDATE END
            END IF;
*/
            ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
--
-- 2008/12/10 v1.24 UPDATE END
            prc_set_xml('N', 'inv_amt' ,TO_CHAR(ROUND(ln_end_inv_amt, gn_amount_decml )));
            -- 差異数量
            ln_quantity := ln_quantity - ln_end_inv_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
            ln_amount := ln_amount - ln_end_inv_amt ;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
          END IF;
--
-- 2008/11/25 v1.18 ADD START
          -- 当月受払・月首・棚卸の数量・金額が全てゼロの場合
          IF (
               (lb_zero = TRUE)
                 AND (ln_first_inv_qty = 0)
                   AND (ln_first_inv_amt = 0)
                     AND (ln_end_inv_qty = 0)
                       AND (ln_end_inv_amt = 0)
             ) THEN
          ------------------------------
          -- 出力判定用タグ
          ------------------------------
            prc_set_xml('Z', 'flg', '1');
          ELSE
            prc_set_xml('Z', 'flg', '0');
          END IF;
--
-- 2008/11/25 v1.18 ADD END
-- 2008/12/12 v1.27 ADD START
          -- 変数の初期化
          ln_first_inv_qty   := 0;
          ln_first_inv_amt   := 0;
          ln_end_inv_qty     := 0;
          ln_end_inv_amt     := 0;
          ln_first_cargo_qty := 0;
          ln_first_cargo_amt := 0;
          ln_end_cargo_qty   := 0;
          ln_end_cargo_amt   := 0;
--
-- 2008/12/12 v1.27 ADD END
          ------------------------------
          -- 品目コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_item');
          ------------------------------
          -- 品目コードＬＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/lg_item');
          ------------------------------
          -- 群コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_crowd_dtl');
        END IF ;
--
        ------------------------------
        -- 群コードＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'g_crowd_dtl');
        -- -----------------------------------------------------
        -- 群コードＧデータタグ出力
        -- -----------------------------------------------------
        -- 群コード
        prc_set_xml('D', 'crowd_dtl', gt_main_data(i).crowd_code);
        ------------------------------
        -- 商品コードＬＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'lg_item');
--
        -- -----------------------------------------------------
        -- キーブレイク時の初期処理
        -- -----------------------------------------------------
        -- キーブレイク用変数退避
        lv_crowd_code := NVL( gt_main_data(i).crowd_code, lc_break_null ) ;
        lv_item_code  := lc_break_init ;
        lv_cost_kbn   := lc_break_init ;
--
        -- 計算項目初期化
        ln_unit_price    := 0;
        ln_inv_qty       := 0;
        ln_inv_amt       := 0;
        ln_first_inv_qty := 0;
        ln_first_inv_amt := 0;
        ln_end_inv_qty   := 0;
        ln_end_inv_amt   := 0;
-- 2008/12/09 v1.23 UPDATE START
        ln_first_cargo_qty := 0;
        ln_first_cargo_amt := 0;
        ln_end_cargo_qty   := 0;
        ln_end_cargo_amt   := 0;
-- 2008/12/09 v1.23 UPDATE END
--
      END IF ;
--
      -- =====================================================
      -- 品目コードブレイク
      -- =====================================================
      -- 品目コードが切り替わった場合
      IF ( NVL( gt_main_data(i).item_code, lc_break_null ) <> lv_item_code ) THEN
        -- -----------------------------------------------------
        -- 終了タグ出力
        -- -----------------------------------------------------
        -- 初回レコードの場合はタグを出力しない。
        IF ( lv_item_code <> lc_break_init ) THEN
          -- -----------------------------------------------------
          -- 明細データタグ出力
          -- -----------------------------------------------------
-- 2008/12/19 v1.31 DELETE START
/*
          -- 金額算出（原価管理区分が「標準原価」の場合）
          IF (lv_cost_kbn = gc_cost_st ) THEN
-- 2008/12/19 v1.31 UPDATE START
--            ln_amount := ln_unit_price * ln_quantity;
            ln_amount := ROUND(ln_unit_price * ln_quantity);
-- 2008/12/19 v1.31 UPDATE END
          END IF;
*/
-- 2008/12/19 v1.31 DELETE END
-- 2008/08/28 v1.10 UPDATE START
          -- 払出項目の場合
--          IF (lb_payout = TRUE) THEN
--            ln_quantity := ln_quantity * -1;
--            ln_amount   := ln_amount * -1;
--          END IF;
-- 2008/08/28 v1.10 UPDATE END
-- 2008/08/22 v1.8 ADD START
          IF (lb_revi = TRUE) THEN
            ln_quantity := ln_quantity * -1;
            ln_amount   := ln_amount * -1;
          END IF;
-- 2008/08/22 v1.8 ADD END
          -- 数量
          prc_set_xml('Z', lv_col_name || '_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          prc_set_xml('Z', lv_col_name || '_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2009/04/08 v1.34 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
          IF ((ln_quantity <> 0) OR (ln_amount <> 0)) THEN
            lb_zero := FALSE;
          END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2009/04/08 v1.34 DELETE END
          -- 数量・金額を集計（品目単位）
          IF (lb_payout = FALSE) THEN
            -- 受入
            ln_qty_in := ln_qty_in + ln_quantity;
            ln_amt_in := ln_amt_in + ln_amount;
          ELSE
            -- 払出
            ln_qty_out := ln_qty_out + ln_quantity;
            ln_amt_out := ln_amt_out + ln_amount;
          END IF;
--
-- 2009/04/08 v1.34 ADD START
          IF (
               (ln_qty_in <> 0)
               OR
               (ln_amt_in <> 0)
               OR
               (ln_qty_out <> 0)
               OR
               (ln_amt_out <> 0)
             ) THEN
            lb_zero := FALSE;
          END IF;
-- 2009/04/08 v1.34 ADD END
          -- -----------------------------------------------------
          -- 月末データタグ出力
          -- -----------------------------------------------------
          -- 数量
          ln_quantity := ln_first_inv_qty + ln_qty_in - ln_qty_out;
          prc_set_xml('Z', 'end_inv_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          ln_amount := ln_first_inv_amt + ln_amt_in - ln_amt_out;
          prc_set_xml('Z', 'end_inv_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
          -- -----------------
          -- 受払VIEWより取得
          -- -----------------
-- 2008/11/17 v1.16 DELETE START
--          prc_get_inv_qty_amt(ir_param, i, ir_param.exec_year_month, ln_inv_qty, ln_inv_amt);
-- 2008/11/17 v1.16 DELETE END
--
          -- -----------------------------------------------------
          -- 棚卸・差異データタグ出力
          -- -----------------------------------------------------
          prc_get_fst_end_inv_qty_amt(ir_param, i, ir_param.exec_year_month,
-- 2008/11/17 v1.16 UPDATE START
--                                                ln_end_inv_qty, ln_end_inv_amt);
                                ln_end_inv_qty, ln_end_cargo_qty, ln_end_inv_amt, ln_end_cargo_amt);
-- 2008/11/17 v1.16 UPDATE END
-- 2008/12/15 v1.28 UPDATE START
--          IF (ln_end_inv_qty = 0) THEN
          IF (ln_end_inv_qty + ln_end_cargo_qty = 0) THEN
            -- 在庫数量が確定していない場合
            prc_set_xml('N', 'inv_qty'  , '0');
            prc_set_xml('N', 'inv_amt'  , '0');
-- 2008/08/20 v1.7 UPDATE START
--            prc_set_xml('N', 'quantity' , '0');
--            prc_set_xml('N', 'amount'   , '0');
            -- 差異数量
--            ln_quantity := ln_quantity - ln_end_inv_qty;
            ln_quantity := ln_quantity - ln_end_inv_qty - ln_end_cargo_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
--            ln_amount := ln_amount - ln_end_inv_amt ;
            ln_amount := ln_amount - ln_end_inv_amt - ln_end_cargo_amt;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
-- 2008/12/15 v1.28 UPDATE END
-- 2008/08/20 v1.7 UPDATE END
          ELSE
            -- 在庫数量が確定している場合
            -- 棚卸数量
-- 2008/11/17 v1.16 UPDATE START
--            ln_end_inv_qty := ln_end_inv_qty + ln_inv_qty;
            ln_end_inv_qty := ln_end_inv_qty + ln_end_cargo_qty;
-- 2008/11/17 v1.16 UPDATE END
            prc_set_xml('N', 'inv_qty' ,TO_CHAR(ROUND(ln_end_inv_qty, gn_quantity_decml)));
            -- 棚卸金額
-- 2008/12/10 v1.24 UPDATE START
/*
            IF (lv_cost_kbn = gc_cost_st ) THEN
              -- 原価管理区分が「標準原価」の場合
              ln_end_inv_amt := ln_end_inv_qty * ln_unit_price;
            ELSE
              -- 原価管理区分が「実際原価」の場合
-- 2008/11/17 v1.16 UPDATE START
--              ln_end_inv_amt := ln_end_inv_amt + ln_inv_amt;
              ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
-- 2008/11/17 v1.16 UPDATE END
            END IF;
*/
            ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
--
-- 2008/12/10 v1.24 UPDATE END
            prc_set_xml('N', 'inv_amt' ,TO_CHAR(ROUND(ln_end_inv_amt, gn_amount_decml )));
            -- 差異数量
            ln_quantity := ln_quantity - ln_end_inv_qty;
            prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
            -- 差異金額
            ln_amount := ln_amount - ln_end_inv_amt ;
            prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
          END IF;
--
-- 2008/11/25 v1.18 ADD START
          -- 当月受払・月首・棚卸の数量・金額が全てゼロの場合
          IF (
               (lb_zero = TRUE)
                 AND (ln_first_inv_qty = 0)
                   AND (ln_first_inv_amt = 0)
                     AND (ln_end_inv_qty = 0)
                       AND (ln_end_inv_amt = 0)
             ) THEN
          ------------------------------
          -- 出力判定用タグ
          ------------------------------
            prc_set_xml('Z', 'flg', '1');
          ELSE
            prc_set_xml('Z', 'flg', '0');
          END IF;
--
-- 2008/11/25 v1.18 ADD END
-- 2008/12/12 v1.27 ADD START
          -- 変数の初期化
          ln_first_inv_qty   := 0;
          ln_first_inv_amt   := 0;
          ln_end_inv_qty     := 0;
          ln_end_inv_amt     := 0;
          ln_first_cargo_qty := 0;
          ln_first_cargo_amt := 0;
          ln_end_cargo_qty   := 0;
          ln_end_cargo_amt   := 0;
--
-- 2008/12/12 v1.27 ADD END
          ------------------------------
          -- 品目コードＧ終了タグ
          ------------------------------
          prc_set_xml('T', '/g_item');
        END IF ;
--
        ------------------------------
        -- 品目コードＧ開始タグ
        ------------------------------
        prc_set_xml('T', 'g_item');
        -- -----------------------------------------------------
        -- 品目コードＧデータタグ出力
        -- -----------------------------------------------------
        -- 品目コード
        prc_set_xml('D', 'item_code', gt_main_data(i).item_code);
        -- 品目名称
        prc_set_xml('D', 'item_name', gt_main_data(i).item_name, 20);
--
        -- -----------------------------------------------------
        -- 品目単位での項目取得
        -- -----------------------------------------------------
        -- 単価
        ln_unit_price := fnc_get_item_unit_price(i) ;
--
        -- -----------------
        -- 受払VIEWより取得
        -- -----------------
-- 2008/11/17 v1.16 DELETE START
--        prc_get_inv_qty_amt(ir_param, i, gv_exec_year_month_bef, ln_inv_qty, ln_inv_amt);
-- 2008/11/17 v1.16 DELETE END
--
        -- -----------------------------------------------------
        -- 月首データタグ出力
        -- -----------------------------------------------------
        prc_get_fst_end_inv_qty_amt(ir_param, i, gv_exec_year_month_bef,
-- 2008/11/11 v1.16 UPDATE START
--                                              ln_first_inv_qty, ln_first_inv_amt);
                        ln_first_inv_qty, ln_first_cargo_qty, ln_first_inv_amt, ln_first_cargo_amt);
-- 2008/11/11 v1.16 UPDATE END
        -- 数量
-- 2008/11/17 v1.16 DELETE START
--        ln_first_inv_qty := ln_first_inv_qty + ln_inv_qty;
-- 2008/11/17 v1.16 DELETE END
-- 2008/12/12 v1.27 ADD START
        ln_first_inv_qty := ln_first_inv_qty + ln_first_cargo_qty;
-- 2008/12/12 v1.27 ADD END
-- 2008/12/09 v1.23 UPDATE START
--        prc_set_xml('Z', 'first_inv_qty' , TO_CHAR(ln_first_inv_qty) );
-- 2008/12/12 v1.27 UPDATE START
--        prc_set_xml('Z', 'first_inv_qty' , TO_CHAR(ln_first_inv_qty + ln_first_cargo_qty) );
        prc_set_xml('Z', 'first_inv_qty' , TO_CHAR(ln_first_inv_qty));
-- 2008/12/12 v1.27 UPDATE END
-- 2008/12/09 v1.23 UPDATE END
        -- 金額
-- 2008/12/10 v1.24 UPDATE START
/*
        IF (NVL( gt_main_data(i).cost_kbn, lc_break_null ) = gc_cost_st ) THEN
          -- 原価管理区分が「標準原価」の場合
-- 2008/11/11 v1.16 UPDATE START
--          ln_first_inv_amt := (ln_first_inv_qty + ln_inv_qty) * ln_unit_price;
-- 2008/12/09 v1.23 UPDATE START
--          ln_first_inv_amt := ln_first_inv_qty * ln_unit_price;
          ln_first_inv_amt := ROUND((ln_first_inv_qty + ln_first_cargo_qty) * ln_unit_price);
-- 2008/12/09 v1.23 UPDATE END
 -- 2008/11/11 v1.16 UPDATE END
        ELSE
          -- 原価管理区分が「実際原価」の場合
          IF (gt_main_data(i).lot_ctl = gn_lot_ctl_y) THEN
-- 2008/11/11 v1.16 UPDATE START
--            ln_first_inv_amt := ln_first_inv_amt + ln_inv_amt;
-- 2008/12/09 v1.23 UPDATE START
--            ln_first_inv_amt := ln_first_inv_amt;
            ln_first_inv_amt := ln_first_inv_amt + ln_first_cargo_amt;
-- 2008/12/09 v1.23 UPDATE END
-- 2008/11/11 v1.16 UPDATE END
          ELSE
-- 2008/11/11 v1.16 UPDATE START
--            ln_first_inv_amt := (ln_first_inv_qty + ln_inv_qty) * ln_unit_price;
-- 2008/12/09 v1.23 UPDATE START
--            ln_first_inv_amt := ln_first_inv_qty * ln_unit_price;
            ln_first_inv_amt := ROUND((ln_first_inv_qty + ln_first_cargo_qty) * ln_unit_price);
-- 2008/12/09 v1.23 UPDATE END
-- 2008/11/11 v1.16 UPDATE END
          END IF;
        END IF;
*/
        ln_first_inv_amt := ln_first_inv_amt + ln_first_cargo_amt;
--
-- 2008/12/10 v1.24 UPDATE END
        prc_set_xml('Z', 'first_inv_amt' , TO_CHAR(ln_first_inv_amt) );
--
        -- -----------------------------------------------------
        -- キーブレイク時の初期処理
        -- -----------------------------------------------------
        -- キーブレイク用変数退避
        lv_item_code   := NVL( gt_main_data(i).item_code, lc_break_null ) ;
        lv_cost_kbn    := NVL( gt_main_data(i).cost_kbn, lc_break_null ) ;
        IF ( (lv_cost_kbn = gc_cost_ac) AND (gt_main_data(i).lot_ctl = gn_lot_ctl_n) ) THEN
          lv_cost_kbn  := gc_cost_st;
        END IF;
        lv_column_no   := lc_break_init ;
--
        -- 計算項目初期化
        ln_quantity := 0;
        ln_amount   := 0;
        ln_qty_in   := 0;
        ln_qty_out  := 0;
        ln_amt_in   := 0;
        ln_amt_out  := 0;
--
      END IF ;
--
      -- =====================================================
      -- 項目位置ブレイク
      -- =====================================================
      -- 項目位置が切り替わった場合
      IF (NVL( gt_main_data(i).column_no, lc_break_null ) <> lv_column_no ) THEN
        -- -----------------------------------------------------
        -- 終了タグ出力
        -- -----------------------------------------------------
        -- 初回レコードの場合は明細タグを出力しない。
        IF ( lv_column_no <> lc_break_init ) THEN
          -- -----------------------------------------------------
          -- 明細データタグ出力
          -- -----------------------------------------------------
-- 2008/12/19 v1.31 DELETE START
/*
          -- 金額算出（原価管理区分が「標準原価」の場合）
          IF (lv_cost_kbn = gc_cost_st ) THEN
-- 2008/12/19 v1.31 UPDATE START
--            ln_amount := ln_unit_price * ln_quantity;
            ln_amount := ROUND(ln_unit_price * ln_quantity);
-- 2008/12/19 v1.31 UPDATE END
          END IF;
*/
-- 2008/12/19 v1.31 DELETE END
-- 2008/08/28 v1.10 UPDATE START
          -- 払出項目の場合
--          IF (lb_payout = TRUE) THEN
--            ln_quantity := ln_quantity * -1;
--            ln_amount   := ln_amount * -1;
--          END IF;
-- 2008/08/28 v1.10 UPDATE END
-- 2008/08/22 v1.8 ADD START
          IF (lb_revi = TRUE) THEN
            ln_quantity := ln_quantity * -1;
            ln_amount   := ln_amount * -1;
          END IF;
-- 2008/08/22 v1.8 ADD END
          -- 数量
          prc_set_xml('Z', lv_col_name || '_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
          -- 金額
          prc_set_xml('Z', lv_col_name || '_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2009/04/08 v1.34 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
          IF ((ln_quantity <> 0) OR (ln_amount <> 0)) THEN
            lb_zero := FALSE;
          END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2009/04/08 v1.34 DELETE END
          -- 数量・金額を集計（品目単位）
          IF (lb_payout = FALSE) THEN
            -- 受入
            ln_qty_in := ln_qty_in + ln_quantity;
            ln_amt_in := ln_amt_in + ln_amount;
          ELSE
            -- 払出
            ln_qty_out := ln_qty_out + ln_quantity;
            ln_amt_out := ln_amt_out + ln_amount;
          END IF;
-- 2009/04/08 v1.34 ADD START
          IF (
               (ln_qty_in <> 0)
               OR
               (ln_amt_in <> 0)
               OR
               (ln_qty_out <> 0)
               OR
               (ln_amt_out <> 0)
             ) THEN
            lb_zero := FALSE;
          END IF ;
--
-- 2009/04/08 v1.34 ADD END
        END IF ;
--
        -- キーブレイク用変数退避
        lv_column_no   := NVL( gt_main_data(i).column_no, lc_break_null ) ;
--
        -- 計算項目初期化
        ln_quantity := 0;
        ln_amount   := 0;
        lv_col_name := lc_break_init;
--
        -- 項目判定初期化
        lb_trnsfr   := FALSE;
        lb_payout   := FALSE;
-- 2008/09/02 v1.11 UPDATE START
/*
-- 2008/08/22 v1.8 ADD START
        lb_revi     := FALSE;
-- 2008/08/22 v1.8 ADD END
*/
-- 2008/09/02 v1.11 UPDATE END
      END IF ;
--
      -- =====================================================
      -- 明細データ出力
      -- =====================================================
      CASE lv_column_no
        -- **【受入】**
        -- 仕入
        WHEN gc_col_no_po THEN
          lv_col_name := 'po';
        -- 包装
        WHEN gc_col_no_wrap THEN
          lv_col_name := 'wrap';
        -- セット
        WHEN gc_col_no_set THEN
          lv_col_name := 'set';
        -- 沖縄
        WHEN gc_col_no_oki THEN
          lv_col_name := 'okinawa';
        -- 振替入庫
        WHEN gc_col_no_trnsfr THEN
          lv_col_name := 'trnsfr';
          lb_trnsfr   := TRUE;
-- 2008/09/02 v1.11 UPDATE START
/*
-- 2008/08/27 v1.9 ADD START
          lb_revi     := TRUE;
-- 2008/08/27 v1.9 ADD END
*/
-- 2008/09/02 v1.11 UPDATE START
        -- 緑営１
        WHEN gc_col_no_acct_1 THEN
          lv_col_name := 'acct_1';
          lb_trnsfr   := TRUE;
-- 2008/09/02 v1.11 UPDATE START
/*
-- 2008/08/22 v1.8 ADD START
          lb_revi     := TRUE;
-- 2008/08/22 v1.8 ADD END
*/
-- 2008/09/02 v1.11 UPDATE START
        -- 緑営２
        WHEN gc_col_no_acct_2 THEN
          lv_col_name := 'acct_2';
          lb_trnsfr   := TRUE;
-- 2008/09/02 v1.11 UPDATE START
/*
-- 2008/08/22 v1.8 ADD START
          lb_revi     := TRUE;
-- 2008/08/22 v1.8 ADD END
*/
-- 2008/09/02 v1.11 UPDATE START
        -- ドリンクギフト
        WHEN gc_col_no_guift THEN
          lv_col_name := 'guift';
          lb_trnsfr   := TRUE;
-- 2008/09/02 v1.11 UPDATE START
/*
-- 2008/08/27 v1.9 ADD START
          lb_revi     := TRUE;
-- 2008/08/27 v1.9 ADD END
*/
-- 2008/09/02 v1.11 UPDATE START
        -- 倉替
        WHEN gc_col_no_locat_chg THEN
          lv_col_name := 'locat_chg';
        -- 返品
        WHEN gc_col_no_ret_goods THEN
          lv_col_name := 'ret_goods';
        -- その他
        WHEN gc_col_no_other THEN
          lv_col_name := 'other';
        -- **【払出】**
        -- セット
        WHEN gc_col_no_out_set THEN
          lv_col_name := 'out_set';
          lb_payout   := TRUE;
        -- 返品原料へ
        WHEN gc_col_no_out_mtrl THEN
          lv_col_name := 'out_mtrl';
          lb_payout   := TRUE;
        -- 解体半製品へ
        WHEN gc_col_no_out_dismnt THEN
          lv_col_name := 'out_dismnt';
          lb_payout   := TRUE;
        -- 有償
        WHEN gc_col_no_out_pay THEN
          lv_col_name := 'out_pay';
          lb_payout   := TRUE;
        -- 振替有償
        WHEN gc_col_no_out_trnsfr THEN
          lv_col_name := 'out_trnsfr';
          lb_payout   := TRUE;
          lb_trnsfr   := TRUE;
        -- 拠点
        WHEN gc_col_no_out_point THEN
          lv_col_name := 'out_point';
          lb_payout   := TRUE;
        -- ドリンクギフト
        WHEN gc_col_no_out_guift THEN
          lv_col_name := 'out_guift';
          lb_payout   := TRUE;
          lb_trnsfr   := TRUE;
        -- その他
        WHEN gc_col_no_out_other THEN
          lv_col_name := 'out_other';
          lb_payout   := TRUE;
        ELSE
          lv_col_name := lc_break_init;
      END CASE;
--
      -- 項目名が初期値以外
      IF (lv_col_name <> lc_break_init) THEN
-- 2008/09/02 v1.11 UPDATE START
/*
        -- 振替項目の場合
        IF (lb_trnsfr = TRUE) THEN
          -- 数量加算
          ln_quantity := ln_quantity + (NVL( gt_main_data(i).trans_qty, 0 )
                                        * NVL( gt_main_data(i).rcv_pay_div, 0));
          -- 金額加算（原価管理区分が「実際原価」の場合）
          IF (lv_cost_kbn = gc_cost_ac ) THEN
            ln_amount := ln_amount + (NVL(gt_main_data(i).trans_qty,0)
                                      * NVL(gt_main_data(i).actual_unit_price,0)
                                      * NVL( gt_main_data(i).rcv_pay_div, 0));
          END IF;
        ELSE
          -- 数量加算
          ln_quantity := ln_quantity + NVL( gt_main_data(i).trans_qty, 0 );
          -- 金額加算（原価管理区分が「実際原価」の場合）
          IF (lv_cost_kbn = gc_cost_ac ) THEN
            ln_amount := ln_amount + (NVL(gt_main_data(i).trans_qty,0)
                                      * NVL(gt_main_data(i).actual_unit_price,0));
          END IF;
        END IF;
*/
        -- 数量加算
        ln_quantity := ln_quantity + NVL( gt_main_data(i).trans_qty, 0 );
        -- 金額加算（原価管理区分が「実際原価」の場合）
        IF (lv_cost_kbn = gc_cost_ac ) THEN
-- 2008/12/19 v1.31 UPDATE START
--          ln_amount := ln_amount + (NVL(gt_main_data(i).trans_qty,0)
--                                    * NVL(gt_main_data(i).actual_unit_price,0));
          ln_amount := ln_amount + ROUND(NVL(gt_main_data(i).trans_qty,0)
                                    * NVL(gt_main_data(i).actual_unit_price,0));
        ELSE
          ln_amount := ln_amount + ROUND(NVL(gt_main_data(i).trans_qty,0)
                                    * ln_unit_price);
-- 2008/12/19 v1.31 UPDATE END
        END IF;
-- 2008/09/02 v1.11 UPDATE END
      END IF;
--
    END LOOP main_data_loop ;
--
    -- =====================================================
    -- 終了処理
    -- =====================================================
--
-- 2008/12/19 v1.31 DELETE START
/*
    -- 金額算出（原価管理区分が「標準原価」の場合）
    IF (lv_cost_kbn = gc_cost_st ) THEN
-- 2008/12/19 v1.31 UPDATE START
--      ln_amount := ln_unit_price * ln_quantity;
      ln_amount := ROUND(ln_unit_price * ln_quantity);
-- 2008/12/19 v1.31 UPDATE END
    END IF;
-- 2008/08/28 v1.10 UPDATE START
*/
-- 2008/12/19 v1.31 DELETE END
    -- 払出項目の場合
--    IF (lb_payout = TRUE) THEN
--      ln_quantity := ln_quantity * -1;
--      ln_amount   := ln_amount * -1;
--    END IF;
-- 2008/08/28 v1.10 UPDATE END
-- 2008/09/02 v1.11 UPDATE START
/*
-- 2008/08/22 v1.8 ADD START
    IF (lb_revi = TRUE) THEN
      ln_quantity := ln_quantity * -1;
      ln_amount   := ln_amount * -1;
    END IF;
-- 2008/08/22 v1.8 ADD END
*/
-- 2008/09/02 v1.11 UPDATE END
    -- 数量
    prc_set_xml('Z', lv_col_name || '_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
    -- 金額
    prc_set_xml('Z', lv_col_name || '_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
-- 2009/04/08 v1.34 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
    IF ((ln_quantity <> 0) OR (ln_amount <> 0)) THEN
      lb_zero := FALSE;
    END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2009/04/08 v1.34 DELETE END
    -- 数量・金額を集計（品目単位）
    IF (lb_payout = FALSE) THEN
      -- 受入
      ln_qty_in := ln_qty_in + ln_quantity;
      ln_amt_in := ln_amt_in + ln_amount;
    ELSE
      -- 払出
      ln_qty_out := ln_qty_out + ln_quantity;
      ln_amt_out := ln_amt_out + ln_amount;
    END IF;
--
-- 2009/04/08 v1.34 ADD START
    IF (
          (ln_qty_in <> 0)
          OR
          (ln_amt_in <> 0)
          OR
          (ln_qty_out <> 0)
          OR
          (ln_amt_out <> 0)
        ) THEN
      lb_zero := FALSE;
    END IF;
-- 2009/04/08 v1.34 ADD END
    -- -----------------------------------------------------
    -- 月末データタグ出力
    -- -----------------------------------------------------
    -- 数量
    ln_quantity := ln_first_inv_qty + ln_qty_in - ln_qty_out;
    prc_set_xml('Z', 'end_inv_qty' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml)));
    -- 金額
    ln_amount := ln_first_inv_amt + ln_amt_in - ln_amt_out;
    prc_set_xml('Z', 'end_inv_amt' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml)));
--
    -- -----------------
    -- 受払VIEWより取得
    -- -----------------
-- 2008/11/17 v1.16 DELETE START
--    prc_get_inv_qty_amt(ir_param, gt_main_data.COUNT, ir_param.exec_year_month,
--                        ln_inv_qty, ln_inv_amt);
-- 2008/11/17 v1.16 DELETE END
--
    -- -----------------------------------------------------
    -- 棚卸・差異データタグ出力
    -- -----------------------------------------------------
-- 2008/12/15 v1.28 N.Yoshida mod start
    ln_last_pos := gt_main_data.COUNT;
    prc_get_fst_end_inv_qty_amt(ir_param, ln_last_pos + 1, ir_param.exec_year_month,
--    prc_get_fst_end_inv_qty_amt(ir_param, gt_main_data.COUNT, ir_param.exec_year_month,
-- 2008/12/15 v1.28 N.Yoshida mod end
-- 2008/11/17 v1.16 DELETE START
--                                          ln_end_inv_qty, ln_end_inv_amt);
                                ln_end_inv_qty, ln_end_cargo_qty, ln_end_inv_amt, ln_end_cargo_amt);
-- 2008/11/17 v1.16 DELETE END
-- 2008/12/15 v1.28 UPDATE START
--    IF (ln_end_inv_qty = 0) THEN
    IF (ln_end_inv_qty + ln_end_cargo_qty = 0) THEN
      -- 在庫数量が確定していない場合
      prc_set_xml('N', 'inv_qty'  , '0');
      prc_set_xml('N', 'inv_amt'  , '0');
-- 2008/08/20 v1.7 UPDATE START
--      prc_set_xml('N', 'quantity' , '0');
--      prc_set_xml('N', 'amount'   , '0');
      -- 差異数量
--      ln_quantity := ln_quantity - ln_end_inv_qty;
      ln_quantity := ln_quantity - ln_end_inv_qty - ln_end_cargo_qty;
      prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
      -- 差異金額
--      ln_amount := ln_amount - ln_end_inv_amt ;
      ln_amount := ln_amount - ln_end_inv_amt - ln_end_cargo_amt;
      prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
-- 2008/12/15 v1.28 UPDATE END
-- 2008/08/20 v1.7 UPDATE END
    ELSE
      -- 在庫数量が確定している場合
      -- 棚卸数量
-- 2008/11/17 v1.16 UPDATE START
--      ln_end_inv_qty := ln_end_inv_qty + ln_inv_qty;
      ln_end_inv_qty := ln_end_inv_qty + ln_end_cargo_qty;
-- 2008/11/17 v1.16 UPDATE END
      prc_set_xml('N', 'inv_qty' ,TO_CHAR(ROUND(ln_end_inv_qty, gn_quantity_decml)));
      -- 棚卸金額
-- 2008/12/10 v1.24 UPDATE START
/*
      IF (lv_cost_kbn = gc_cost_st ) THEN
        -- 原価管理区分が「標準原価」の場合
        ln_end_inv_amt := ln_end_inv_qty * ln_unit_price;
      ELSE
        -- 原価管理区分が「実際原価」の場合
-- 2008/11/17 v1.16 UPDATE START
--        ln_end_inv_amt := ln_end_inv_amt + ln_inv_amt;
        ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
-- 2008/11/17 v1.16 UPDATE END
      END IF;
*/
      ln_end_inv_amt := ln_end_inv_amt + ln_end_cargo_amt;
--
-- 2008/12/10 v1.24 UPDATE END
      prc_set_xml('N', 'inv_amt' ,TO_CHAR(ROUND(ln_end_inv_amt, gn_amount_decml )));
      -- 差異数量
      ln_quantity := ln_quantity - ln_end_inv_qty;
      prc_set_xml('N', 'quantity' ,TO_CHAR(ROUND(ln_quantity, gn_quantity_decml )));
      -- 差異金額
      ln_amount := ln_amount - ln_end_inv_amt ;
      prc_set_xml('N', 'amount' ,TO_CHAR(ROUND(ln_amount, gn_amount_decml )));
-- 2008/12/17 v1.29 DELETE START
/*
-- 2008/11/25 v1.18 ADD START
      -- 当月受払・月首・棚卸の数量・金額が全てゼロの場合
      IF (
            (lb_zero = TRUE)
              AND (ln_first_inv_qty = 0)
                AND (ln_first_inv_amt = 0)
                  AND (ln_end_inv_qty = 0)
                    AND (ln_end_inv_amt = 0)
          ) THEN
      ------------------------------
      -- 出力判定用タグ
      ------------------------------
        prc_set_xml('Z', 'flg', '1');
      ELSE
        prc_set_xml('Z', 'flg', '0');
      END IF;
--
-- 2008/11/25 v1.18 ADD END
*/
-- 2008/12/17 v1.29 DELETE END
    END IF;
-- 2008/12/17 v1.29 ADD START
--
    -- 当月受払・月首・棚卸の数量・金額が全てゼロの場合
    IF (
          (lb_zero = TRUE)
            AND (ln_first_inv_qty = 0)
              AND (ln_first_inv_amt = 0)
                AND (ln_end_inv_qty = 0)
                  AND (ln_end_inv_amt = 0)
        ) THEN
    ------------------------------
    -- 出力判定用タグ
    ------------------------------
      prc_set_xml('Z', 'flg', '1');
    ELSE
      prc_set_xml('Z', 'flg', '0');
    END IF;
--
-- 2008/12/17 v1.29 ADD END

-- 2008/12/12 v1.27 ADD START
    -- 変数の初期化
    ln_first_inv_qty   := 0;
    ln_first_inv_amt   := 0;
    ln_end_inv_qty     := 0;
    ln_end_inv_amt     := 0;
    ln_first_cargo_qty := 0;
    ln_first_cargo_amt := 0;
    ln_end_cargo_qty   := 0;
    ln_end_cargo_amt   := 0;
--
-- 2008/12/12 v1.27 ADD END
    ------------------------------
    -- 品目コードＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/g_item');
    ------------------------------
    -- 品目コードＬＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/lg_item');
    ------------------------------
    -- 群コードＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/g_crowd_dtl');
    ------------------------------
    -- 群コードＬＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/lg_crowd_dtl');
    ------------------------------
    -- 小群コードＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/g_crowd_low');
    ------------------------------
    -- 小群コードＬＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/lg_crowd_low');
    ------------------------------
    -- 中群コードＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/g_crowd_mid');
    ------------------------------
    -- 中群コードＬＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/lg_crowd_mid');
    ------------------------------
    -- 大群コードＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/g_crowd_high');
    ------------------------------
    -- 大群コードＬＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/lg_crowd_high');
    ------------------------------
    -- 倉庫コードＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/g_locat');
    ------------------------------
    -- 倉庫コードＬＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/lg_locat');
    ------------------------------
    -- データＬＧ終了タグ
    ------------------------------
    prc_set_xml('T', '/data_info');
--
  EXCEPTION
    -- *** 取得データ０件 ***
    WHEN no_data_expt THEN
      ov_retcode := gv_status_warn ;
      ov_errmsg  := xxcmn_common_pkg.get_msg( gc_application
                                             ,'APP-XXCMN-10122' ) ;
--
--#################################  固定例外処理部 START   ####################################
--
    -- *** 共通関数例外ハンドラ ***
    WHEN global_api_expt THEN
      ov_errmsg  := lv_errmsg;
      ov_errbuf  := SUBSTRB(gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||lv_errbuf,1,5000);
      ov_retcode := gv_status_error;
    -- *** 共通関数OTHERS例外ハンドラ ***
    WHEN global_api_others_expt THEN
      ov_errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM;
      ov_retcode := gv_status_error;
    -- *** OTHERS例外ハンドラ ***
    WHEN OTHERS THEN
      ov_errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM;
      ov_retcode := gv_status_error;
--
--#####################################  固定部 END   ##########################################
--
  END prc_create_xml_data ;
--
  /**********************************************************************************
   * Procedure Name   : submain
   * Description      : メイン処理プロシージャ
   **********************************************************************************/
  PROCEDURE submain(
      iv_exec_year_month    IN     VARCHAR2         --   01 : 処理年月
     ,iv_goods_class        IN     VARCHAR2         --   02 : 商品区分
     ,iv_item_class         IN     VARCHAR2         --   03 : 品目区分
     ,iv_print_kind         IN     VARCHAR2         --   04 : 帳票種別
     ,iv_locat_code         IN     VARCHAR2         --   05 : 倉庫コード
     ,iv_crowd_kind         IN     VARCHAR2         --   06 : 群種別
     ,iv_crowd_code         IN     VARCHAR2         --   07 : 群コード
     ,iv_acct_crowd_code    IN     VARCHAR2         --   08 : 経理群コード
     ,ov_errbuf            OUT     VARCHAR2         -- エラー・メッセージ           --# 固定 #
     ,ov_retcode           OUT     VARCHAR2         -- リターン・コード             --# 固定 #
     ,ov_errmsg            OUT     VARCHAR2         -- ユーザー・エラー・メッセージ --# 固定 #
    )
  IS
--
--#####################  固定ローカル定数変数宣言部 START   ####################
--
    -- ======================================================
    -- 固定ローカル定数
    -- ======================================================
    cv_prg_name    CONSTANT VARCHAR2(100) := 'submain' ; -- プログラム名
    -- ======================================================
    -- ローカル変数
    -- ======================================================
    lv_errbuf  VARCHAR2(5000) ;                   --   エラー・メッセージ
    lv_retcode VARCHAR2(1) ;                      --   リターン・コード
    lv_errmsg  VARCHAR2(5000) ;                   --   ユーザー・エラー・メッセージ
--
--###########################  固定部 END   ####################################
--
    -- ======================================================
    -- ユーザー宣言部
    -- ======================================================
    -- *** ローカル変数 ***
    lr_param_rec            rec_param_data ;          -- パラメータ受渡し用
--
    lv_xml_string           VARCHAR2(32000) ;
    ln_retcode              NUMBER ;
--
  BEGIN
--
--##################  固定ステータス初期化部 START   ###################
--
    ov_retcode := gv_status_normal ;
--
--###########################  固定部 END   ############################
--
    -- =====================================================
    -- 初期処理
    -- =====================================================
    -- 帳票出力値格納
    gv_report_id                    := 'XXCMN770002T' ;      -- 帳票ID
    gd_exec_date                    := SYSDATE ;             -- 実施日
    -- パラメータ格納
    lr_param_rec.exec_year_month    := iv_exec_year_month;   -- 処理年月
    lr_param_rec.goods_class        := iv_goods_class ;      -- 商品区分
    lr_param_rec.item_class         := iv_item_class ;       -- 品目区分
    lr_param_rec.print_kind         := iv_print_kind;        -- 帳票区分
    lr_param_rec.locat_code         := iv_locat_code;        -- 倉庫コード
    lr_param_rec.crowd_kind         := iv_crowd_kind;        -- 群種別
    lr_param_rec.crowd_code         := iv_crowd_code;        -- 群コード
    lr_param_rec.acct_crowd_code    := iv_acct_crowd_code;   -- 経理郡コード
--
    -- 2009/05/29 ADD START
    gd_st_unit_date := FND_DATE.STRING_TO_DATE(iv_exec_year_month , gc_char_m_format);
    -- 2009/05/29 ADD END
--
    -- =====================================================
    -- 前処理
    -- =====================================================
    prc_initialize(
        ir_param          => lr_param_rec       -- 入力パラメータ群
       ,ov_errbuf         => lv_errbuf          -- エラー・メッセージ           --# 固定 #
       ,ov_retcode        => lv_retcode         -- リターン・コード             --# 固定 #
       ,ov_errmsg         => lv_errmsg          -- ユーザー・エラー・メッセージ --# 固定 #
      ) ;
    IF  (lv_retcode = gv_status_error)
     OR (lv_retcode = gv_status_warn) THEN
      RAISE global_process_expt ;
    END IF ;
--
    -- =====================================================
    -- 帳票データ出力
    -- =====================================================
    prc_create_xml_data(
        ir_param          => lr_param_rec       -- 入力パラメータレコード
       ,ov_errbuf         => lv_errbuf          -- エラー・メッセージ           --# 固定 #
       ,ov_retcode        => lv_retcode         -- リターン・コード             --# 固定 #
       ,ov_errmsg         => lv_errmsg          -- ユーザー・エラー・メッセージ --# 固定 #
      ) ;
    IF (lv_retcode = gv_status_error) THEN
      RAISE global_process_expt ;
    END IF ;
--
    -- ==================================================
    -- ＸＭＬ出力
    -- ==================================================
    FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '<?xml version="1.0" encoding="shift_jis" ?>' ) ;
--
    -- --------------------------------------------------
    -- 抽出データが０件の場合
    -- --------------------------------------------------
    IF  ( lv_errmsg IS NOT NULL )
    AND ( lv_retcode = gv_status_warn ) THEN
      -- ０件メッセージ出力
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '<root>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '  <data_info>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '    <lg_locat>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '      <g_locat>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '        <position>1</position>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '        <lg_crowd_high>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '          <g_crowd_high>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '            <lg_crowd_mid>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '              <g_crowd_mid>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                <lg_crowd_low>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                  <g_crowd_low>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                    <lg_crowd_dtl>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                      <g_crowd_dtl>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                       <msg>' || lv_errmsg || '</msg>');
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                      </g_crowd_dtl>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                    </lg_crowd_dtl>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                  </g_crowd_low>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '                </lg_crowd_low>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '              </g_crowd_mid>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '            </lg_crowd_mid>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '          </g_crowd_high>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '        </lg_crowd_high>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '      </g_locat>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '    </lg_locat>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '  </data_info>' ) ;
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '</root>' ) ;
--
      -- ０件メッセージログ出力
      lv_errmsg  := xxcmn_common_pkg.get_msg( gc_application
                                             ,'APP-XXCMN-10154'
                                             ,'TABLE'
                                             ,gv_print_name ) ;
--
    -- --------------------------------------------------
    -- 帳票データが出力できた場合
    -- --------------------------------------------------
    ELSE
      -- ＸＭＬヘッダー出力
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '<root>' ) ;
--
      -- ＸＭＬデータ部出力
      <<xml_data_table>>
      FOR i IN 1 .. gt_xml_data_table.COUNT LOOP
        -- 編集したデータをタグに変換
        lv_xml_string := fnc_conv_xml
                          (
                            iv_name   => gt_xml_data_table(i).tag_name    -- タグネーム
                           ,iv_value  => gt_xml_data_table(i).tag_value   -- タグデータ
                           ,ic_type   => gt_xml_data_table(i).tag_type    -- タグタイプ
                          ) ;
        -- ＸＭＬタグ出力
        FND_FILE.PUT_LINE( FND_FILE.OUTPUT, lv_xml_string ) ;
      END LOOP xml_data_table ;
--
      -- ＸＭＬフッダー出力
      FND_FILE.PUT_LINE( FND_FILE.OUTPUT, '</root>' ) ;
--
    END IF ;
--
    -- ==================================================
    -- 終了ステータス設定
    -- ==================================================
    ov_retcode := lv_retcode ;
    ov_errmsg  := lv_errmsg ;
    ov_errbuf  := lv_errbuf ;
--
  EXCEPTION
--#################################  固定例外処理部 START   ###################################
--
    -- *** 処理部共通例外ハンドラ ***
    WHEN global_process_expt THEN
      ov_errmsg  := lv_errmsg ;
      ov_errbuf  := SUBSTRB(gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||lv_errbuf,1,5000) ;
      ov_retcode := gv_status_error ;
    -- *** 共通関数OTHERS例外ハンドラ ***
    WHEN global_api_others_expt THEN
      ov_errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM ;
      ov_retcode := gv_status_error ;
    -- *** OTHERS例外ハンドラ ***
    WHEN OTHERS THEN
      ov_errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM ;
      ov_retcode := gv_status_error ;
--
--####################################  固定部 END   ##########################################
  END submain ;
--
  /**********************************************************************************
   * Procedure Name   : main
   * Description      : コンカレント実行ファイル登録プロシージャ
   **********************************************************************************/
--
  PROCEDURE main(
      errbuf                OUT    VARCHAR2         -- エラーメッセージ
     ,retcode               OUT    VARCHAR2         -- エラーコード
     ,iv_exec_year_month    IN     VARCHAR2         --   01 : 処理年月
     ,iv_goods_class        IN     VARCHAR2         --   02 : 商品区分
     ,iv_item_class         IN     VARCHAR2         --   03 : 品目区分
     ,iv_print_kind         IN     VARCHAR2         --   04 : 帳票種別
     ,iv_locat_code         IN     VARCHAR2         --   05 : 倉庫コード
     ,iv_crowd_kind         IN     VARCHAR2         --   06 : 群種別
     ,iv_crowd_code         IN     VARCHAR2         --   07 : 群コード
     ,iv_acct_crowd_code    IN     VARCHAR2         --   08 : 経理群コード
    )
--
--###########################  固定部 START   ###########################
--
  IS
--
    -- ======================================================
    -- 固定ローカル定数
    -- ======================================================
    cv_prg_name    CONSTANT VARCHAR2(100) := 'main' ; -- プログラム名
    -- ======================================================
    -- ローカル変数
    -- ======================================================
    lv_errbuf               VARCHAR2(5000) ;      --   エラー・メッセージ
    lv_retcode              VARCHAR2(1) ;         --   リターン・コード
    lv_errmsg               VARCHAR2(5000) ;      --   ユーザー・エラー・メッセージ
--
  BEGIN
--
--###########################  固定部 END   #############################
--
    -- ======================================================
    -- submainの呼び出し（実際の処理はsubmainで行う）
    -- ======================================================
    submain(
        iv_exec_year_month   => iv_exec_year_month   --   01 : 処理年月
       ,iv_goods_class       => iv_goods_class       --   02 : 商品区分
       ,iv_item_class        => iv_item_class        --   03 : 品目区分
       ,iv_print_kind        => iv_print_kind        --   04 : 帳票種別
       ,iv_locat_code        => iv_locat_code        --   05 : 倉庫コード
       ,iv_crowd_kind        => iv_crowd_kind        --   06 : 群種別
       ,iv_crowd_code        => iv_crowd_code        --   07 : 群コード
       ,iv_acct_crowd_code   => iv_acct_crowd_code   --   08 : 経理群コード
       ,ov_errbuf            => lv_errbuf            -- エラー・メッセージ           --# 固定 #
       ,ov_retcode           => lv_retcode           -- リターン・コード             --# 固定 #
       ,ov_errmsg            => lv_errmsg            -- ユーザー・エラー・メッセージ --# 固定 #
     ) ;
--
--###########################  固定部 START   #####################################################
--
    -- ======================================================
    -- エラー・メッセージ出力
    -- ======================================================
    IF  ( lv_retcode = gv_status_error )
     OR ( lv_retcode = gv_status_warn  ) THEN
      errbuf := lv_errmsg ;
      FND_FILE.PUT_LINE(FND_FILE.LOG,lv_errbuf) ;
    END IF ;
--
    --ステータスセット
    retcode := lv_retcode ;
--
  EXCEPTION
    -- *** 共通関数OTHERS例外ハンドラ ***
    WHEN global_api_others_expt THEN
      errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM ;
      retcode := gv_status_error ;
    -- *** OTHERS例外ハンドラ ***
    WHEN OTHERS THEN
      errbuf  := gv_pkg_name||gv_msg_cont||cv_prg_name||gv_msg_part||SQLERRM ;
      retcode := gv_status_error ;
  END main ;
--
--###########################  固定部 END   #######################################################
--
END xxcmn770002c ;
/